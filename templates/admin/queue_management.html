{% extends 'base.html' %}
{% load static %}

{% block title %}キュー管理 - 画像解析アプリ{% endblock %}

{% block navbar %}
{% include 'includes/admin_navbar.html' %}
{% endblock %}

{% block content %}
<div class="pt-16 py-8 sm:py-16 lg:py-24">
  <div class="container mx-auto px-2 py-0">
    <div class="bg-base-100 py-4 sm:py-8 lg:py-12">
      <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
        <div class="mb-6 space-y-3 text-center sm:mb-8 lg:mb-12">
          <h2 class="text-base-content text-2xl font-semibold md:text-3xl lg:text-4xl">
            <span class="relative z-1 font-bold">
              解析キュー
              <span
                class="from-primary absolute start-0 bottom-1 -z-1 h-0.5 w-full bg-gradient-to-r to-transparent to-80%"
                aria-hidden="true"></span>
            </span>
            管理システム
          </h2>
          <p class="text-base-content/80 text-xl">
            画像解析のキューを管理し、処理順序や優先度を制御できます。
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 統計情報セクション -->
<div class="container mx-auto px-4 py-4">
  <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
    <div class="bg-base-100 rounded-xl shadow-sm p-6 text-center">
      <div class="text-2xl font-bold text-base-content">{{ stats.total }}</div>
      <div class="text-sm text-base-content/70">総数</div>
    </div>
    <div class="bg-base-100 rounded-xl shadow-sm p-6 text-center">
      <div class="text-2xl font-bold text-warning">{{ stats.waiting }}</div>
      <div class="text-sm text-base-content/70">待機中</div>
    </div>
    <div class="bg-base-100 rounded-xl shadow-sm p-6 text-center">
      <div class="text-2xl font-bold text-info">{{ stats.processing }}</div>
      <div class="text-sm text-base-content/70">処理中</div>
    </div>
    <div class="bg-base-100 rounded-xl shadow-sm p-6 text-center">
      <div class="text-2xl font-bold text-success">{{ stats.completed }}</div>
      <div class="text-sm text-base-content/70">完了</div>
    </div>
    <div class="bg-base-100 rounded-xl shadow-sm p-6 text-center">
      <div class="text-2xl font-bold text-error">{{ stats.failed }}</div>
      <div class="text-sm text-base-content/70">失敗</div>
    </div>
  </div>

  <!-- キュー操作ボタン -->
  <div class="bg-base-100 rounded-xl shadow-sm p-6 mb-6">
    <div class="flex flex-wrap gap-4 items-center justify-between">
      <div class="flex flex-wrap gap-2">
        <button type="button" class="btn btn-primary" onclick="startNextProcessing()">
          <span class="icon-[tabler--play] size-4"></span>
          次の処理を開始
        </button>
        <button type="button" class="btn btn-outline btn-secondary" onclick="refreshQueue()">
          <span class="icon-[tabler--refresh] size-4"></span>
          更新
        </button>
        <button type="button" class="btn btn-outline btn-warning" onclick="reorderQueue()">
          <span class="icon-[tabler--sort-ascending] size-4"></span>
          キュー再整理
        </button>
      </div>
      <div class="flex flex-wrap gap-2">
        <select class="select select-bordered w-32" id="statusFilter">
          <option value="">すべて</option>
          <option value="waiting">待機中</option>
          <option value="processing">処理中</option>
          <option value="completed">完了</option>
          <option value="failed">失敗</option>
        </select>
        <select class="select select-bordered w-32" id="priorityFilter">
          <option value="">すべて</option>
          <option value="urgent">緊急</option>
          <option value="high">高</option>
          <option value="normal">通常</option>
          <option value="low">低</option>
        </select>
      </div>
    </div>
  </div>

  <!-- キュー一覧テーブル -->
  <div class="bg-base-100 rounded-xl shadow-sm p-6">
    <div class="overflow-x-auto">
      {% if queue_items %}
      <table class="table w-full">
        <thead>
          <tr>
            <th>位置</th>
            <th>画像</th>
            <th>ユーザー</th>
            <th>ステータス</th>
            <th>優先度</th>
            <th>モデル</th>
            <th>待機位置</th>
            <th>推定時間</th>
            <th>キュー追加日時</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody>
          {% for item in queue_items %}
          <tr data-queue-id="{{ item.id }}" data-status="{{ item.status }}" data-priority="{{ item.priority }}">
            <td>
              <div class="flex items-center gap-2">
                <span class="font-mono text-lg font-bold">{{ item.position }}</span>
                <div class="flex flex-col gap-1">
                  <button type="button" class="btn btn-xs btn-circle btn-outline"
                    onclick="moveQueueItem({{ item.id }}, {{ item.position|add:'-1' }})" {% if item.position <=1
                    %}disabled{% endif %}>
                    <span class="icon-[tabler--chevron-up] size-3"></span>
                  </button>
                  <button type="button" class="btn btn-xs btn-circle btn-outline"
                    onclick="moveQueueItem({{ item.id }}, {{ item.position|add:'1' }})">
                    <span class="icon-[tabler--chevron-down] size-3"></span>
                  </button>
                </div>
              </div>
            </td>
            <td>
              <div class="flex items-center gap-3">
                <div class="avatar">
                  <div class="w-10 h-10 rounded-md bg-base-200">
                    <div class="image-placeholder-small" data-src="{{ item.image.thumbnail_url }}">
                      <div class="skeleton h-full w-full animate-pulse"></div>
                    </div>
                  </div>
                </div>
                <div>
                  <div class="font-medium text-sm">{{ item.image.filename }}</div>
                  <div class="text-xs text-base-content/60">ID: {{ item.image.id }}</div>
                </div>
              </div>
            </td>
            <td>
              <div class="font-medium">{{ item.user.username }}</div>
              <div class="text-xs text-base-content/60">{{ item.user.email }}</div>
            </td>
            <td>
              {% if item.status == 'waiting' %}
              <span class="badge badge-warning">待機中</span>
              {% elif item.status == 'processing' %}
              <span class="badge badge-info">処理中</span>
              {% elif item.status == 'completed' %}
              <span class="badge badge-success">完了</span>
              {% elif item.status == 'failed' %}
              <span class="badge badge-error">失敗</span>
              {% elif item.status == 'cancelled' %}
              <span class="badge badge-neutral">キャンセル</span>
              {% endif %}
            </td>
            <td>
              <select class="select select-xs select-bordered" onchange="changePriority({{ item.id }}, this.value)" {%
                if item.status=='processing' %}disabled{% endif %}>
                <option value="low" {% if item.priority=='low' %}selected{% endif %}>低</option>
                <option value="normal" {% if item.priority=='normal' %}selected{% endif %}>通常</option>
                <option value="high" {% if item.priority=='high' %}selected{% endif %}>高</option>
                <option value="urgent" {% if item.priority=='urgent' %}selected{% endif %}>緊急</option>
              </select>
            </td>
            <td>
              <select class="select select-xs select-bordered" onchange="changeModel({{ item.id }}, this.value)" {% if
                item.status=='processing' %}disabled{% endif %}>
                <option value="resnet50" {% if item.model_name=='resnet50' or not item.model_name %}selected{% endif %}>
                  ResNet-50</option>
                <option value="efficientnet" {% if item.model_name=='efficientnet' %}selected{% endif %}>EfficientNet
                </option>
                <option value="mobilenet" {% if item.model_name=='mobilenet' %}selected{% endif %}>MobileNet</option>
                <option value="vgg16" {% if item.model_name=='vgg16' %}selected{% endif %}>VGG-16</option>
                <option value="custom" {% if item.model_name=='custom' %}selected{% endif %}>Custom</option>
              </select>
            </td>
            <td>
              {% if item.status == 'waiting' %}
              <span class="font-mono text-sm">{{ item.waiting_position }}位</span>
              {% else %}
              <span class="text-base-content/50">-</span>
              {% endif %}
            </td>
            <td>
              {% if item.status == 'waiting' %}
              <span class="text-sm">{{ item.estimated_wait_time }}分</span>
              {% else %}
              <span class="text-base-content/50">-</span>
              {% endif %}
            </td>
            <td>
              <div class="text-sm">{{ item.queued_at|date:"m/d H:i" }}</div>
            </td>
            <td>
              <div class="flex gap-1">
                {% if item.status == 'waiting' %}
                <button type="button" class="btn btn-xs btn-error" onclick="removeFromQueue({{ item.id }})">
                  <span class="icon-[tabler--trash] size-3"></span>
                </button>
                {% endif %}
                {% if item.status == 'failed' %}
                <button type="button" class="btn btn-xs btn-warning" onclick="retryQueueItem({{ item.id }})">
                  <span class="icon-[tabler--refresh] size-3"></span>
                </button>
                {% endif %}
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <div class="text-center py-12">
        <div class="text-base-content/50 text-lg mb-4">
          <span class="icon-[tabler--queue] size-16 mx-auto block mb-4"></span>
          キューにアイテムがありません
        </div>
        <p class="text-base-content/60">
          画像をアップロードすると、ここにキューアイテムが表示されます。
        </p>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- 成功/エラーメッセージ表示エリア -->
<div id="message-area" class="fixed top-4 right-4 z-50"></div>

{% endblock %}

{% block extra_js %}
{% block extra_js %}
<script src="{% static 'js/pages/queue-management.js' %}"></script>
{% endblock %}

{% block extra_css %}
<style>
  .image-placeholder-small {
    background: linear-gradient(135deg, #f3f4f6 25%, transparent 25%),
      linear-gradient(225deg, #f3f4f6 25%, transparent 25%),
      linear-gradient(45deg, #f3f4f6 25%, transparent 25%),
      linear-gradient(315deg, #f3f4f6 25%, transparent 25%);
    background-position: 5px 0, 5px 0, 0 0, 0 0;
    background-size: 10px 10px;
    background-color: #f9fafb;
    width: 100%;
    height: 100%;
    position: relative;
  }

  .image-placeholder-small[style*="background-image"],
  .image-placeholder-small.image-loaded {
    background-size: cover !important;
    background-position: center !important;
    background-repeat: no-repeat !important;
  }

  .image-placeholder-small[style*="background-image"] .skeleton,
  .image-placeholder-small.image-loaded .skeleton {
    display: none !important;
  }
</style>
{% endblock %}