{% extends 'base.html' %}
{% load static %}

{% block title %}管理者用画像一覧 - 画像解析アプリ{% endblock %}

{% block navbar %}
{% include 'includes/admin_navbar.html' %}
{% endblock %}

{% block content %}
{% csrf_token %}

<div class="pt-16 py-8 sm:py-16 lg:py-24">
  <div class="container mx-auto px-2 py-0">
    <div class="bg-base-100 py-4 sm:py-8 lg:py-12">
      <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
        <div class="mb-6 space-y-3 text-center sm:mb-8 lg:mb-12">
          <h2 class="text-base-content text-2xl font-semibold md:text-3xl lg:text-4xl">
            <span class="relative z-1 font-bold">
              管理者用
              <span
                class="from-primary absolute start-0 bottom-1 -z-1 h-0.5 w-full bg-gradient-to-r to-transparent to-80%"
                aria-hidden="true"></span>
            </span>
            画像一覧ページ
          </h2>
          <p class="text-base-content/80 text-xl">
            全ユーザーの画像解析状況を管理できます。アップロードされた画像の一覧、解析進捗、結果を確認できます。
          </p>
          <div class="group flex items-center justify-center gap-2 pt-2 pb-2"
            style="padding-top: 8px !important; padding-bottom: 8px !important;">
            <a href="image.upload.html" class="link link-animated link-primary font-normal">ログアウト</a>
            <span
              class="icon-[tabler--chevron-right] text-primary size-5 shrink-0 transition-transform group-hover:translate-x-1 rtl:rotate-180"></span>
          </div>
        </div>
      </div>
    </div>
  </div>


</div>
<!-- テーブルセクション -->
<div class="container mx-auto px-4 py-4">
  <div class="bg-base-100 rounded-xl shadow-sm p-6">
    <!-- Filter Bar -->
    <div class="flex flex-col flex-wrap gap-4 sm:flex-row sm:items-center sm:justify-between mb-6">
      <!-- Left side: Search -->
      <div class="select-floating w-80">
        <input class="input" list="datalistOptions" id="exampleDataList" placeholder="ファイル名で検索..." />
        <label class="select-floating-label" for="selectFloating">検索</label>
      </div>
      <!-- Right side: Date Sort and Status Filter -->
      <div class="flex flex-col sm:flex-row gap-4">
        <div class="select-floating w-40">
          <select class="select" aria-label="Date sort" id="dateSort">
            <option>新しい順</option>
            <option>古い順</option>
          </select>
          <label class="select-floating-label" for="dateSort">日順ソート</label>
        </div>

        <div class="select-floating w-40">
          <select class="select" aria-label="Select floating label" id="selectFloating">
            <option>すべて</option>
            <option>解析成功</option>
            <option>解析中</option>
            <option>準備中</option>
            <option>失敗</option>
          </select>
          <label class="select-floating-label" for="selectFloating">ステータス</label>
        </div>

        <div class="select-floating w-40">
          <select class="select" aria-label="User filter" id="userFilter">
            <option>すべて</option>
            <option>user_001</option>
            <option>user_002</option>
            <option>user_003</option>
            <option>user_004</option>
          </select>
          <label class="select-floating-label" for="userFilter">ユーザー名</label>
        </div>



        <div class="select-floating w-40">
          <select class="select" aria-label="Model filter" id="modelFilter">
            <option>すべて</option>
            <option>ResNet-50</option>
            <option>EfficientNet-B0</option>
            <option>MobileNet v2</option>
            <option>VGG-16</option>
            <option>Custom</option>
          </select>
          <label class="select-floating-label" for="modelFilter">使用モデル</label>
        </div>

        <div class="select-floating w-40">
          <select class="select" aria-label="Label filter" id="labelFilter">
            <option>すべて</option>
            <option>犬</option>
            <option>屋外</option>
            <option>公園</option>
            <option>風景</option>
            <option>人物</option>
          </select>
          <label class="select-floating-label" for="labelFilter">ラベル</label>
        </div>

        <div class="select-floating w-40">
          <select class="select" aria-label="Confidence filter" id="confidenceFilter">
            <option>すべて</option>
            <option>90%以上</option>
            <option>80-89%</option>
            <option>70-79%</option>
            <option>60-69%</option>
            <option>60%未満</option>
          </select>
          <label class="select-floating-label" for="confidenceFilter">信頼度</label>
        </div>

        <button type="button" class="btn btn-soft btn-sm btn-circle" onclick="resetAllFilters()" title="フィルターをリセット">
          <span class="icon-[tabler--refresh] size-4"></span>
        </button>
      </div>
    </div>

    <!-- Table -->
    <div class="overflow-x-auto max-w-6xl mx-auto">
      <table class="table w-full [&_tr:nth-child(even)]:bg-base-200">
        <thead>
          <tr>
            <th>ユーザー名</th>
            <th>サムネイル画像</th>
            <th>アップロード日時</th>
            <th>ステータス</th>
            <th>エラーログ</th>
            <th>解析開始日時</th>
            <th>解析終了日時</th>
            <th>使用した学習モデル</th>
            <th>機械学習によってつけられたラベル</th>
            <th>信頼度</th>
          </tr>
        </thead>
        <tbody>
          {% if has_data %}
          {% for image in images %}
          <tr data-image-id="{{ image.id }}">
            <td>
              <span class="font-medium">user_001</span>
            </td>
            <td>
              <div class="flex items-center gap-3">
                <div class="avatar cursor-pointer" data-overlay="#slide-down-animated-modal">
                  <div class="bg-base-content/10 h-10 w-10 rounded-md">
                    <div class="image-placeholder-small" data-src="{{ image.thumbnail_url }}">
                      <div class="skeleton h-full w-full animate-pulse"></div>
                    </div>
                  </div>
                </div>
                <div>
                  <div class="text-sm opacity-50">画像ファイル</div>
                  <div class="font-medium">{{ image.filename }}</div>
                </div>
              </div>
            </td>
            <td>{{ image.upload_date|date:"Y-m-d H:i" }}</td>
            <td>
              {% if image.status == 'success' %}
              <span class="badge badge-outline border-dashed badge-success me-2 cursor-pointer" title="クリックしてタイムラインを確認"
                data-overlay="#timeline-modal">解析成功</span>
              {% elif image.status == 'analyzing' %}
              <span class="badge badge-outline border-dashed badge-info me-2 cursor-pointer" title="クリックしてタイムラインを確認"
                data-overlay="#timeline-modal">解析中</span>
              {% elif image.status == 'preparing' %}
              <span class="badge badge-outline border-dashed badge-secondary me-2 cursor-pointer"
                title="クリックしてタイムラインを確認" data-overlay="#timeline-modal">準備中</span>
              {% elif image.status == 'failed' %}
              <span class="badge badge-outline border-dashed badge-error me-2 cursor-pointer" title="クリックしてタイムラインを確認"
                data-overlay="#timeline-modal">失敗</span>
              {% else %}
              <span class="badge badge-outline border-dashed badge-secondary me-2">
                準備中
              </span>
              {% endif %}
            </td>
            <td>
              {% if image.status == 'failed' %}
              <button type="button" class="btn btn-error btn-sm" aria-haspopup="dialog" aria-expanded="false"
                aria-controls="error-log-modal" data-overlay="#error-log-modal">エラー詳細</button>
              {% else %}
              <span class="text-sm text-gray-500">-</span>
              {% endif %}
            </td>
            <td>
              {% if image.timeline_log.analysis_started_at %}
              {{ image.timeline_log.analysis_started_at|date:"Y-m-d H:i" }}
              {% else %}
              <span class="text-sm text-gray-500">-</span>
              {% endif %}
            </td>
            <td>
              {% if image.timeline_log.analysis_completed_at %}
              {{ image.timeline_log.analysis_completed_at|date:"Y-m-d H:i" }}
              {% else %}
              <span class="text-sm text-gray-500">-</span>
              {% endif %}
            </td>
            <td>
              {% if image.timeline_log.model_used %}
              <span class="badge badge-info">{{ image.timeline_log.model_used }}</span>
              {% else %}
              <span class="text-sm text-gray-500">-</span>
              {% endif %}
            </td>
            <td>
              {% if image.analysis_results.exists %}
              {% for result in image.analysis_results.all %}
              <span class="badge badge-primary">{{ result.label }}</span>
              {% endfor %}
              {% else %}
              <span class="text-sm text-gray-500">-</span>
              {% endif %}
            </td>
            <td>
              {% if image.analysis_results.exists %}
              {% for result in image.analysis_results.all %}
              <span class="badge badge-success">{{ result.confidence }}%</span>
              {% endfor %}
              {% else %}
              <span class="text-sm text-gray-500">-</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
          {% else %}
          <tr>
            <td colspan="10" class="text-center py-8">
              <div class="text-gray-500">
                <span class="icon-[tabler--photo] size-8 mx-auto mb-2 block"></span>
                画像データがありません
              </div>
            </td>
          </tr>
          {% endif %}
        </tbody>
      </table>
    </div>

    <!-- 他の行は省略 -->
  </div>

  <!-- Pagination -->
  <div class="flex flex-wrap items-center justify-between gap-2 py-4">
    <div class="text-sm text-base-content/80">
      {% if has_data %}
      Showing <span class="font-semibold">{{ page_obj.start_index }}-{{ page_obj.end_index }}</span> of
      <span class="font-semibold">{{ page_obj.paginator.count }}</span> images
      {% else %}
      画像データがありません
      {% endif %}
    </div>
    {% if has_data and page_obj.has_other_pages %}
    <nav class="join">
      {% if page_obj.has_previous %}
      <a href="?page={{ page_obj.previous_page_number }}" class="btn btn-soft btn-square join-item">
        <span class="icon-[tabler--chevron-left] size-5"></span>
      </a>
      {% else %}
      <button class="btn btn-soft btn-square join-item" disabled>
        <span class="icon-[tabler--chevron-left] size-5"></span>
      </button>
      {% endif %}

      {% for num in page_obj.paginator.page_range %}
      {% if page_obj.number == num %}
      <button class="btn btn-soft join-item btn-square" aria-current="page">{{ num }}</button>
      {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %} <a href="?page={{ num }}"
        class="btn btn-soft join-item btn-square">{{ num }}</a>
        {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}" class="btn btn-soft btn-square join-item">
          <span class="icon-[tabler--chevron-right] size-5"></span>
        </a>
        {% else %}
        <button class="btn btn-soft btn-square join-item" disabled>
          <span class="icon-[tabler--chevron-right] size-5"></span>
        </button>
        {% endif %}
    </nav>
    {% endif %}
  </div>
</div>



<!-- Image Detail Modal -->
<div id="slide-down-animated-modal" class="overlay modal overlay-open:opacity-100 overlay-open:duration-300 hidden"
  role="dialog" tabindex="-1">
  <div
    class="modal-dialog fixed top-8 left-1/2 transform -translate-x-1/2 overlay-open:duration-300 transition-all ease-out max-w-sm sm:max-w-md lg:max-w-lg">
    <div class="modal-content max-h-[90vh] overflow-y-auto">
      <div class="modal-header">
        <h3 class="modal-title">画像詳細</h3>
        <button type="button" class="btn btn-text btn-circle btn-sm absolute end-3 top-3" aria-label="Close"
          data-overlay="#slide-down-animated-modal">
          <span class="icon-[tabler--x] size-4"></span>
        </button>
      </div>
      <div class="modal-body">
        <div class="flex flex-col gap-4">
          <!-- Image -->
          <div class="flex justify-center">
            <img id="modal-image" src="" alt=""
              class="rounded-lg shadow-lg max-w-full h-auto max-h-96 object-contain" />
          </div>

          <!-- Image Details -->
          <div class="grid grid-cols-1 gap-3">
            <div class="flex justify-between items-center">
              <span class="font-semibold">ファイル名:</span>
              <span id="modal-filename" class="text-sm text-gray-600"></span>
            </div>
            <div class="flex justify-between items-center">
              <span class="font-semibold">ユーザー名:</span>
              <span id="modal-username" class="text-sm text-gray-600"></span>
            </div>
            <div class="flex justify-between items-center">
              <span class="font-semibold">アップロード日時:</span>
              <span id="modal-upload-time" class="text-sm text-gray-600"></span>
            </div>
            <div class="flex justify-between items-center">
              <span class="font-semibold">ステータス:</span>
              <span id="modal-status-badge" class="badge badge-outline border-dashed me-2"></span>
            </div>
            <div class="flex justify-between items-center">
              <span class="font-semibold">解析開始日時:</span>
              <span id="modal-analysis-start" class="text-sm text-gray-600"></span>
            </div>
            <div class="flex justify-between items-center">
              <span class="font-semibold">解析終了日時:</span>
              <span id="modal-analysis-end" class="text-sm text-gray-600"></span>
            </div>
            <div class="flex justify-between items-center">
              <span class="font-semibold">使用した学習モデル:</span>
              <span id="modal-model" class="text-sm text-gray-600"></span>
            </div>
            <div class="flex justify-between items-center">
              <span class="font-semibold">機械学習によってつけられたラベル:</span>
              <div id="modal-labels" class="flex flex-wrap gap-1"></div>
            </div>
            <div class="flex justify-between items-center">
              <span class="font-semibold">信頼度:</span>
              <span id="modal-confidence" class="badge"></span>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-soft btn-secondary" data-overlay="#slide-down-animated-modal">
          閉じる
        </button>
      </div>
    </div>
  </div>
</div>

<!-- タイムライン表示モーダル -->
<div id="timeline-modal" class="overlay modal overlay-open:opacity-100 overlay-open:duration-300 hidden" role="dialog"
  tabindex="-1">
  <div
    class="modal-dialog overlay-open:mt-4 sm:overlay-open:mt-8 lg:overlay-open:mt-12 overlay-open:duration-300 transition-all ease-out max-w-sm sm:max-w-md lg:max-w-lg">
    <div class="modal-content">
      <div class="modal-header p-4 sm:p-6">
        <h3 class="modal-title text-lg sm:text-xl">解析タイムライン</h3>
        <button type="button" class="btn btn-text btn-circle btn-sm absolute end-3 top-3" aria-label="Close"
          data-overlay="#timeline-modal">
          <span class="icon-[tabler--x] size-4"></span>
        </button>
      </div>
      <div class="modal-body p-4 sm:p-6">
        <div class="flex flex-col gap-4 sm:gap-6">
          <!-- 画像情報 -->
          <div class="text-center">
            <h4 class="font-semibold text-sm sm:text-base mb-2" id="timeline-filename">ファイル名</h4>
            <p class="text-xs sm:text-sm text-gray-500" id="timeline-status">ステータス</p>
          </div>

          <!-- 進捗バー（解析中の場合のみ表示） -->
          <div id="timeline-progress-section" class="hidden">
            <div class="flex items-center gap-x-3 whitespace-nowrap mb-4">
              <div class="progress h-2 flex-1" id="timeline-progress">
                <div class="progress-bar progress-info transition-all duration-500" style="width:0%"
                  id="timeline-progress-bar"></div>
              </div>
              <span class="text-base-content mb-0.5 text-sm">
                <span id="timeline-progress-value">0</span>%
              </span>
            </div>
            <div class="text-center">
              <span class="text-xs text-gray-600" id="timeline-progress-description">解析中...</span>
            </div>
          </div>

          <!-- タイムライン表示 -->
          <div class="space-y-4" id="timeline-content">
            <div class="flex items-center gap-3">
              <div class="flex-shrink-0">
                <div class="w-8 h-8 bg-success rounded-full flex items-center justify-center">
                  <span class="icon-[tabler--upload] text-success-content size-4"></span>
                </div>
              </div>
              <div class="flex-1">
                <div class="flex justify-between items-center">
                  <span class="text-sm font-medium">ファイルアップロード</span>
                  <span class="text-xs text-gray-500" id="upload-time">-</span>
                </div>
                <div class="text-xs text-gray-600" id="upload-duration">所要時間: -</div>
              </div>
            </div>

            <div class="flex items-center gap-3">
              <div class="flex-shrink-0">
                <div class="w-8 h-8 bg-warning rounded-full flex items-center justify-center">
                  <span class="icon-[tabler--brain] text-warning-content size-4"></span>
                </div>
              </div>
              <div class="flex-1">
                <div class="flex justify-between items-center">
                  <span class="text-sm font-medium">解析開始</span>
                  <span class="text-xs text-gray-500" id="analysis-start-time">-</span>
                </div>
                <div class="text-xs text-gray-600" id="model-used">使用モデル: -</div>
              </div>
            </div>

            <div class="flex items-center gap-3">
              <div class="flex-shrink-0">
                <div class="w-8 h-8 bg-info rounded-full flex items-center justify-center">
                  <span class="icon-[tabler--check] text-info-content size-4"></span>
                </div>
              </div>
              <div class="flex-1">
                <div class="flex justify-between items-center">
                  <span class="text-sm font-medium">解析完了</span>
                  <span class="text-xs text-gray-500" id="analysis-end-time">-</span>
                </div>
                <div class="text-xs text-gray-600" id="analysis-duration">所要時間: -</div>
              </div>
            </div>

            <div class="border-t pt-3">
              <div class="flex justify-between items-center">
                <span class="text-sm font-semibold">総所要時間</span>
                <span class="text-sm font-semibold text-primary" id="total-duration">-</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="flex justify-end gap-3">
          <button type="button" class="btn btn-soft btn-secondary" data-overlay="#timeline-modal">閉じる</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Error Log Modal -->
<div id="error-log-modal" class="overlay modal overlay-open:opacity-100 overlay-open:duration-300 hidden" role="dialog"
  tabindex="-1">
  <div class="modal-dialog overlay-open:mt-12 overlay-open:duration-300 transition-all ease-out">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">エラーログ詳細</h3>
        <button type="button" class="btn btn-text btn-circle btn-sm absolute end-3 top-3" aria-label="Close"
          data-overlay="#error-log-modal">
          <span class="icon-[tabler--x] size-4"></span>
        </button>
      </div>
      <div class="modal-body">
        <div class="flex flex-col gap-4">
          <!-- Error Details -->
          <div class="grid grid-cols-1 gap-3">
            <div class="flex justify-between items-center">
              <span class="font-semibold">ファイル名:</span>
              <span class="text-sm text-gray-600">sample_image_001.jpg</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="font-semibold">ユーザー名:</span>
              <span class="text-sm text-gray-600">user_001</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="font-semibold">アップロード日時:</span>
              <span class="text-sm text-gray-600">2024-01-15 10:30</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="font-semibold">ステータス:</span>
              <span class="badge badge-outline border-dashed badge-error me-2">失敗</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="font-semibold">エラーログ:</span>
              <div class="text-sm text-gray-600 max-w-xs text-right">
                ファイル形式がサポートされていません。PNGファイルは現在サポートされていません。
              </div>
            </div>
            <div class="flex justify-between items-center">
              <span class="font-semibold">エラー発生日時:</span>
              <span class="text-sm text-gray-600">2024-01-15 10:35</span>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-soft btn-secondary" data-overlay="#error-log-modal">
          閉じる
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_css %}
<style>
  .table tbody tr:nth-child(even) {
    background-color: #f3f4f6;
  }

  .image-placeholder-small {
    background: linear-gradient(135deg, #f3f4f6 25%, transparent 25%),
      linear-gradient(225deg, #f3f4f6 25%, transparent 25%),
      linear-gradient(45deg, #f3f4f6 25%, transparent 25%),
      linear-gradient(315deg, #f3f4f6 25%, transparent 25%);
    background-position: 5px 0, 5px 0, 0 0, 0 0;
    background-size: 10px 10px;
    background-color: #f9fafb;
    width: 100%;
    height: 100%;
    position: relative;
  }

  /* 小さいプレースホルダーが画像読み込み済みの時のスタイル */
  .image-placeholder-small[style*="background-image"],
  .image-placeholder-small.image-loaded {
    background-size: cover !important;
    background-position: center !important;
    background-repeat: no-repeat !important;
  }

  .image-placeholder-small[style*="background-image"] .skeleton,
  .image-placeholder-small.image-loaded .skeleton {
    display: none !important;
  }
</style>
{% endblock %}

{% block extra_js %}
<script>
  // Function to reset all filters
  function resetAllFilters() {
    console.log('Resetting all filters...');

    // Reset search input
    const searchInput = document.getElementById('exampleDataList');
    if (searchInput) {
      searchInput.value = '';
    }

    // Reset date sort
    const dateSort = document.getElementById('dateSort');
    if (dateSort) {
      dateSort.selectedIndex = 0; // Select first option
    }

    // Reset status filter
    const statusFilter = document.getElementById('selectFloating');
    if (statusFilter) {
      statusFilter.selectedIndex = 0; // Select first option
    }

    // Reset user filter
    const userFilter = document.getElementById('userFilter');
    if (userFilter) {
      userFilter.selectedIndex = 0; // Select first option
    }

    // Reset model filter
    const modelFilter = document.getElementById('modelFilter');
    if (modelFilter) {
      modelFilter.selectedIndex = 0; // Select first option
    }

    // Reset label filter
    const labelFilter = document.getElementById('labelFilter');
    if (labelFilter) {
      labelFilter.selectedIndex = 0; // Select first option
    }

    // Reset confidence filter
    const confidenceFilter = document.getElementById('confidenceFilter');
    if (confidenceFilter) {
      confidenceFilter.selectedIndex = 0; // Select first option
    }

    // Apply filters after reset
    applyFilters();
    console.log('All filters have been reset');
  }

  // Function to apply filters
  function applyFilters() {
    const searchTerm = document.getElementById('exampleDataList').value.toLowerCase();
    const statusFilter = document.getElementById('selectFloating').value;
    const userFilter = document.getElementById('userFilter').value;
    const modelFilter = document.getElementById('modelFilter').value;
    const labelFilter = document.getElementById('labelFilter').value;
    const confidenceFilter = document.getElementById('confidenceFilter').value;
    const dateSort = document.getElementById('dateSort').value;

    const rows = document.querySelectorAll('tbody tr[data-image-id]');
    let visibleCount = 0;

    // First, collect all rows and their data for sorting
    const rowData = [];
    rows.forEach(row => {
      let showRow = true;

      // Search filter
      if (searchTerm) {
        const filename = row.querySelector('.font-medium').textContent.toLowerCase();
        if (!filename.includes(searchTerm)) {
          showRow = false;
        }
      }

      // Status filter
      if (statusFilter !== 'すべて') {
        const statusBadge = row.querySelector('.badge');
        const statusText = statusBadge.textContent.trim();
        if (statusFilter === '解析成功' && statusText !== '解析成功') showRow = false;
        if (statusFilter === '解析中' && statusText !== '解析中') showRow = false;
        if (statusFilter === '準備中' && statusText !== '準備中') showRow = false;
        if (statusFilter === '失敗' && statusText !== '失敗') showRow = false;
      }

      // User filter
      if (userFilter !== 'すべて') {
        const username = row.querySelector('td:first-child .font-medium').textContent.trim();
        if (username !== userFilter) showRow = false;
      }

      // Model filter
      if (modelFilter !== 'すべて') {
        const modelBadge = row.querySelector('td:last-child .badge');
        if (modelBadge) {
          const modelText = modelBadge.textContent.trim();
          if (modelText !== modelFilter) showRow = false;
        } else {
          showRow = false;
        }
      }

      if (showRow) {
        // Get upload date for sorting (3rd column in admin table)
        const uploadDateText = row.querySelector('td:nth-child(3)').textContent.trim();
        const uploadDate = new Date(uploadDateText);

        rowData.push({
          row: row,
          uploadDate: uploadDate,
          uploadDateText: uploadDateText
        });
        visibleCount++;
      } else {
        row.style.display = 'none';
      }
    });

    // Sort by date if needed
    if (dateSort === '古い順') {
      console.log('古い順でソート');
      rowData.sort((a, b) => a.uploadDate - b.uploadDate);
    } else if (dateSort === '新しい順') {
      console.log('新しい順でソート');
      rowData.sort((a, b) => b.uploadDate - a.uploadDate);
    }

    // Reorder and show rows
    const tbody = document.querySelector('tbody');
    if (tbody) {
      // Remove existing rows
      rowData.forEach(item => {
        item.row.remove();
      });

      // Add rows in sorted order
      rowData.forEach(item => {
        item.row.style.display = '';
        tbody.appendChild(item.row);
      });
    }

    // Update pagination info
    const paginationInfo = document.querySelector('.text-sm.text-base-content\\/80');
    if (paginationInfo) {
      paginationInfo.innerHTML = `<span class="font-semibold">${visibleCount}</span> 件の画像を表示中`;
    }

    // Show "no results" message if no rows are visible
    let noResultsRow = tbody.querySelector('.no-results-row');

    console.log('検索結果チェック:', { visibleCount, totalRows: rows.length, hasNoResultsRow: !!noResultsRow });

    if (visibleCount === 0 && rows.length > 0) {
      console.log('検索結果なしメッセージを表示');
      if (!noResultsRow) {
        noResultsRow = document.createElement('tr');
        noResultsRow.className = 'no-results-row';
        noResultsRow.innerHTML = `
          <td colspan="8" class="text-center py-8">
            <div class="text-gray-500">
              <span class="icon-[tabler--search] size-8 mx-auto mb-2 block"></span>
              検索条件に一致する画像が見つかりません
            </div>
          </td>
        `;
        tbody.appendChild(noResultsRow);
        console.log('検索結果なしメッセージを追加');
      }
      noResultsRow.style.display = '';
    } else if (noResultsRow) {
      console.log('検索結果なしメッセージを非表示');
      noResultsRow.style.display = 'none';
    }
  }

  // Add event listeners for filters
  document.addEventListener('DOMContentLoaded', function () {
    const searchInput = document.getElementById('exampleDataList');
    const filters = document.querySelectorAll('select');

    // Search input
    if (searchInput) {
      searchInput.addEventListener('input', applyFilters);
    }

    // Filter selects
    filters.forEach(filter => {
      filter.addEventListener('change', applyFilters);
    });
  });

  // モーダルに画像データを設定する関数
  function openImageModal(filename, imageSrc, uploadTime, username, status, analysisStart, analysisEnd, model, labels, confidence) {
    // モーダルの内容を設定
    document.getElementById('modal-filename').textContent = filename;
    document.getElementById('modal-image').src = imageSrc;
    document.getElementById('modal-image').alt = filename;
    document.getElementById('modal-upload-time').textContent = uploadTime;
    document.getElementById('modal-username').textContent = username;
    // ステータスバッジの設定
    const statusBadge = document.getElementById('modal-status-badge');
    console.log('Status value:', status); // デバッグ用
    statusBadge.textContent = status;

    // ステータスに応じてバッジの色を設定
    if (status === '解析成功') {
      statusBadge.className = 'badge badge-outline border-dashed badge-success me-2';
      console.log('Set success badge'); // デバッグ用
    } else if (status === '解析中') {
      statusBadge.className = 'badge badge-outline border-dashed badge-info me-2';
      console.log('Set info badge'); // デバッグ用
    } else if (status === '準備中') {
      statusBadge.className = 'badge badge-outline border-dashed badge-secondary me-2';
      console.log('Set secondary badge'); // デバッグ用
    } else if (status === '失敗') {
      statusBadge.className = 'badge badge-outline border-dashed badge-error me-2';
      console.log('Set error badge'); // デバッグ用
    } else {
      statusBadge.className = 'badge badge-outline border-dashed me-2';
      console.log('Set default badge, status was:', status); // デバッグ用
    }
    document.getElementById('modal-analysis-start').textContent = analysisStart;
    document.getElementById('modal-analysis-end').textContent = analysisEnd;
    document.getElementById('modal-model').textContent = model;

    // ラベル
    const labelsContainer = document.getElementById('modal-labels');
    labelsContainer.innerHTML = '';
    if (labels && labels.length > 0) {
      labels.forEach(label => {
        const badge = document.createElement('span');
        badge.className = 'badge badge-primary';
        badge.textContent = label;
        labelsContainer.appendChild(badge);
      });
    } else {
      labelsContainer.innerHTML = '<span class="text-sm text-gray-500">ラベルなし</span>';
    }

    // 信頼度
    const confidenceBadge = document.getElementById('modal-confidence');
    if (confidence && confidence !== '-') {
      confidenceBadge.textContent = confidence;
      confidenceBadge.className = 'badge';

      // 信頼度に応じて色を設定
      const confidenceValue = parseFloat(confidence.replace('%', ''));
      if (confidenceValue >= 80) {
        confidenceBadge.classList.add('badge-success');
      } else if (confidenceValue >= 60) {
        confidenceBadge.classList.add('badge-warning');
      } else {
        confidenceBadge.classList.add('badge-error');
      }
    } else {
      confidenceBadge.textContent = '-';
      confidenceBadge.className = 'badge badge-outline';
    }
  }

  // 画像読み込み処理
  function loadImages() {
    const placeholders = document.querySelectorAll('.image-placeholder-small[data-src]');
    placeholders.forEach(placeholder => {
      const src = placeholder.dataset.src;
      if (src) {
        const img = new Image();
        img.onload = function () {
          placeholder.style.backgroundImage = `url(${src})`;
          placeholder.classList.add('image-loaded');
        };
        img.onerror = function () {
          console.log('Failed to load image:', src);
        };
        img.src = src;
      }
    });
  }

  // テーブルのサムネイル画像クリックイベント
  document.addEventListener('DOMContentLoaded', function () {
    // 画像読み込みを開始
    loadImages();
    const avatarElements = document.querySelectorAll('.avatar[data-overlay="#slide-down-animated-modal"]');

    avatarElements.forEach(avatar => {
      avatar.addEventListener('click', function () {
        const row = this.closest('tr');
        if (row) {
          const username = row.querySelector('td:nth-child(1) .font-medium')?.textContent || '';
          const filename = row.querySelector('td:nth-child(2) .font-medium')?.textContent || '';
          const uploadTime = row.querySelector('td:nth-child(3)')?.textContent || '';
          const status = row.querySelector('td:nth-child(4) .badge')?.textContent?.trim() || '';
          const analysisStart = row.querySelector('td:nth-child(6)')?.textContent || '-';
          const analysisEnd = row.querySelector('td:nth-child(7)')?.textContent || '-';
          const model = row.querySelector('td:nth-child(8) .badge')?.textContent || '-';
          const labels = Array.from(row.querySelectorAll('td:nth-child(9) .badge')).map(badge => badge.textContent);
          const confidence = row.querySelector('td:nth-child(10) .badge')?.textContent || '-';

          // 画像URLを取得（サムネイルから）
          const thumbnailImg = row.querySelector('.image-placeholder-small');
          const imageSrc = thumbnailImg ? thumbnailImg.dataset.src : '';

          // モーダルを開く
          openImageModal(filename, imageSrc, uploadTime, username, status, analysisStart, analysisEnd, model, labels, confidence);
        }
      });
    });

    // タイムラインモーダル関連のイベント処理
    document.addEventListener('click', function (event) {
      // タイムラインモーダルを開くバッジがクリックされた場合
      if (event.target.getAttribute('data-overlay') === '#timeline-modal') {
        const row = event.target.closest('tr');
        const imageId = row ? row.getAttribute('data-image-id') : null;
        console.log('タイムラインバッジクリック、画像ID:', imageId);

        if (imageId) {
          openTimelineModal(imageId);
        }
      }
    });

    // タイムラインモーダルを開く関数
    function openTimelineModal(imageId) {
      // 画像データを取得
      const row = document.querySelector(`tr[data-image-id="${imageId}"]`);
      if (!row) return;

      const filename = row.querySelector('td:nth-child(2) .font-medium')?.textContent || '';
      const status = row.querySelector('td:nth-child(4) .badge')?.textContent?.trim() || '';
      const uploadTime = row.querySelector('td:nth-child(3)')?.textContent || '';
      const analysisStart = row.querySelector('td:nth-child(6)')?.textContent || '-';
      const analysisEnd = row.querySelector('td:nth-child(7)')?.textContent || '-';
      const model = row.querySelector('td:nth-child(8) .badge')?.textContent || '-';

      // モーダルにデータを設定
      document.getElementById('timeline-filename').textContent = filename;
      document.getElementById('timeline-status').textContent = status;
      document.getElementById('upload-time').textContent = uploadTime;
      document.getElementById('analysis-start-time').textContent = analysisStart;
      document.getElementById('analysis-end-time').textContent = analysisEnd;
      document.getElementById('model-used').textContent = `使用モデル: ${model}`;

      // 進捗バーの表示制御
      const progressSection = document.getElementById('timeline-progress-section');
      if (status === '解析中') {
        progressSection.classList.remove('hidden');
        // 進捗バーの更新（ダミーデータ）
        updateProgressBar(75); // 例: 75%の進捗
      } else {
        progressSection.classList.add('hidden');
      }

      // 所要時間の計算（ダミーデータ）
      document.getElementById('upload-duration').textContent = '所要時間: 2秒';
      document.getElementById('analysis-duration').textContent = '所要時間: 15秒';
      document.getElementById('total-duration').textContent = '17秒';
    }

    // 進捗バー更新関数
    function updateProgressBar(percentage) {
      const progressBar = document.getElementById('timeline-progress-bar');
      const progressValue = document.getElementById('timeline-progress-value');

      if (progressBar && progressValue) {
        progressBar.style.width = `${percentage}%`;
        progressValue.textContent = percentage;
      }
    }
  });
</script>
{% endblock %}