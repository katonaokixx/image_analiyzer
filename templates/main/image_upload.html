{% extends 'base.html' %}
{% load static %}

{% block title %}画像アップロード - 画像解析アプリ{% endblock %}

{% block content %}
<!-- ページヘッダーセクション -->
<div class="pt-16 py-2 sm:py-4 lg:pt-24 lg:pb-12">
  <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
    <div class="mb-1 space-y-4 text-center sm:mb-2 lg:mb-3">
      <h2 class="text-base-content text-2xl font-semibold md:text-3xl lg:text-4xl">
        <span class="relative z-1 font-bold">
          画像アップロード
          <span class="from-primary absolute start-0 bottom-1 -z-1 h-0.5 w-full bg-gradient-to-r to-transparent to-80%"
            aria-hidden="true"></span>
        </span>
        & 解析
      </h2>
      <p class="text-base-content/80 text-xl">
        画像をアップロードと解析ができます。
      </p>
      <div class="group flex items-center justify-center gap-2 pt-4 pb-2">
        <span
          class="icon-[tabler--chevron-left] text-primary size-5 shrink-0 transition-transform group-hover:-translate-x-1 rtl:rotate-180"></span>
        <a href="{% url 'user_image_table' %}" class="link link-animated link-primary font-normal">画像一覧へ</a>
      </div>
    </div>
  </div>
</div>

<div class="pt-0 mb-8 px-4 sm:px-6 lg:px-8">
  <div class="card max-w-5xl w-full mx-auto">
    <div class="card-header">
      <h5 class="card-title text-lg sm:text-xl">画像アップロード</h5>
    </div>
    <div class="card-body p-4 sm:p-6">

      <!-- CSRFトークン -->
      {% csrf_token %}


      <!-- data-file-upload は厳密な JSON -->
      <div id="file-upload-limit" data-file-upload='{
             "url": "/api/form-upload/",
             "maxFilesize": 1,
             "maxFiles": 5,
             "autoProcessQueue": false,
             "extensions": {
               "jpg": { "class": "shrink-0 size-5" },
               "png": { "class": "shrink-0 size-5" },
               "gif": { "class": "shrink-0 size-5" }
             }
           }'>

        <!-- プレビュー用テンプレート -->
        <template data-file-upload-preview="">
          <div class="rounded-box bg-base-100 shadow-base-300/20 p-3 shadow-lg">
            <div class="mb-1 flex items-center justify-between">
              <div class="flex items-center gap-x-3">
                <span
                  class="text-base-content/80 border-base-content/20 flex size-8 items-center justify-center rounded-lg border p-0.5"
                  data-file-upload-file-icon="">
                  <img class="hidden rounded-md" data-dz-thumbnail="" alt="">
                </span>
                <div>
                  <p class="text-base-content text-sm font-medium">
                    <span class="inline-block truncate align-bottom" data-file-upload-file-name=""></span>.
                    <span data-file-upload-file-ext=""></span>
                  </p>
                  <p class="text-base-content/50 text-xs" data-file-upload-file-size=""
                    data-file-upload-file-success=""></p>
                  <p class="text-error text-xs" style="display:none" data-file-upload-file-error="">File exceeds size
                    limit.</p>
                </div>
              </div>
              <div class="flex items-center">
                <div class="tooltip [--placement:top]" style="display:none" data-file-upload-file-error="">
                  <button type="button" class="tooltip-toggle btn btn-sm btn-circle btn-text btn-error">
                    <span class="icon-[tabler--alert-circle] size-4 shrink-0"></span>
                  </button>
                  <span class="tooltip-content tooltip-shown:opacity-100 tooltip-shown:visible" role="tooltip">
                    <span class="tooltip-body">Please try to upload a file smaller than 1MB.</span>
                  </span>
                </div>
                <button type="button" class="btn btn-sm btn-circle btn-text" data-file-upload-reload="">
                  <span class="icon-[tabler--refresh] size-4 shrink-0"></span>
                </button>
                <button type="button" class="btn btn-sm btn-circle btn-text" data-file-upload-remove="">
                  <span class="icon-[tabler--trash] size-4 shrink-0"></span>
                </button>
              </div>
            </div>
            <div class="flex items-center gap-x-3 whitespace-nowrap">
              <div class="progress h-2" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"
                data-file-upload-progress-bar="">
                <div
                  class="progress-bar progress-primary file-upload-complete:progress-success transition-all duration-500"
                  style="width:0" data-file-upload-progress-bar-pane=""></div>
              </div>
              <span class="text-base-content mb-0.5 text-sm">
                <span data-file-upload-progress-bar-value="">0</span>%
              </span>
            </div>
          </div>
        </template>

        <!-- ドロップ領域 -->
        <div
          class="bg-base-200/60 rounded-box flex flex-col justify-center border-2 border-base-content/20 border-dashed">
          <div class="text-center cursor-pointer p-6 sm:p-8 lg:p-12" data-file-upload-trigger="">
            <p class="text-base-content/50 mb-3 text-xs sm:text-sm">1MB以下のファイルを選択してください。（最大5枚、合計5MBまで）</p>
            <button class="btn btn-soft btn-sm btn-primary text-nowrap">
              <span class="icon-[tabler--file-upload] size-4 sm:size-4.5 shrink-0"></span>
              <span class="hidden sm:inline">ドラッグ&ドロップでアップロード</span>
              <span class="sm:hidden">アップロード</span>
            </button>
            <p class="text-base-content/50 my-2 text-xs">または</p>
            <p class="link link-animated link-primary font-medium text-xs sm:text-sm">ファイルを選択</p>
          </div>
          <div class="mx-4 sm:mx-8 lg:mx-12 mb-4 sm:mb-6 lg:mb-8 space-y-2 empty:m-0" data-file-upload-previews="">
          </div>
        </div>

        <!-- アップロード開始ボタン -->
        <div id="upload-button-container" class="hidden flex justify-center mt-4">
          <button id="start-upload-btn" class="btn btn-primary btn-outline waves waves-primary">
            <span class="icon-[tabler--upload] size-5 mr-2"></span>アップロード開始
          </button>
        </div>

        <!-- 解析開始(モデル選択)ボタン -->
        <div id="analysis-button-container" class="hidden flex justify-center mt-4">
          <button id="start-analysis-btn" class="btn btn-primary btn-outline waves waves-primary"
            data-overlay="#slide-down-animated-modal">
            <span class="icon-[tabler--brain] size-5 mr-2"></span>モデルを選択
          </button>
        </div>




        <!-- モデル未選択アラート -->
        <div id="model-selection-alert" class="alert alert-outline alert-warning hidden" role="alert">
          <span class="icon-[tabler--alert-triangle] size-5"></span>
          <div>
            <h3 class="font-semibold">モデルを選択してください</h3>
            <div class="text-xs">画像一覧に進む前に、解析モデルを選択してください。</div>
          </div>
        </div>

        <!-- タイムライン -->
        <ul id="timeline-container"
          class="timeline timeline-snap-icon timeline-compact timeline-vertical w-full hidden">

          <!-- アップロード成功 -->
          <li id="timeline-item-1-success" class="hidden">
            <div class="timeline-end ms-2 m-3 w-full rounded-lg p-3 sm:p-4 pt-1 bg-success/5 border border-success/20">
              <div
                class="text-base-content pt-0.5 mb-3 flex gap-2 font-medium max-sm:flex-col-reverse sm:items-center sm:justify-between">
                <span class="text-sm sm:text-base">ファイルアップロード完了</span>
                <span class="text-base-content/50 text-xs sm:text-sm font-normal">今すぐ</span>
              </div>
              <p id="timeline-description" class="mb-2 text-xs sm:text-sm">ファイルのアップロードに成功しました</p>
              <div class="flex items-center gap-2">
                <span class="icon-[tabler--check-circle] text-success size-4 sm:size-5"></span>
                <span class="text-xs sm:text-sm text-success font-medium">アップロード成功</span>
              </div>
            </div>
          </li>

          <!-- アップロード失敗 -->
          <li id="timeline-item-1-error" class="hidden">
            <hr class="bg-error" />
            <div class="timeline-middle">
              <span class="badge badge-error size-4.5 rounded-full p-0">
                <span class="icon-[tabler--alert-triangle] text-error-content size-3.5"></span>
              </span>
            </div>
            <div class="timeline-end ms-2 m-3 w-full rounded-lg p-3 sm:p-4 pt-1 border border-error/30 bg-error/5">
              <div
                class="text-base-content pt-0.5 mb-3 flex gap-2 font-medium max-sm:flex-col-reverse sm:items-center sm:justify-between">
                <span class="text-sm sm:text-base">アップロード失敗</span>
                <span class="text-base-content/50 text-xs sm:text-sm font-normal">今すぐ</span>
              </div>
              <p id="timeline-error-description" class="mb-2 text-xs sm:text-sm">ファイルのアップロードに失敗しました</p>
              <div class="flex items-center gap-2">
                <span class="icon-[tabler--alert-circle] text-error size-4 sm:size-5"></span>
                <span class="text-xs sm:text-sm text-error font-medium">アップロード失敗</span>
              </div>
            </div>
            <hr class="bg-error" />
          </li>

          <!-- 解析開始 -->
          <li id="timeline-item-2" class="hidden" style="display: none;">
            <hr class="bg-warning" />
            <div class="timeline-end ms-2 m-3 w-full rounded-lg p-3 sm:p-4 pt-1 bg-warning/5 border border-warning/20">
              <div
                class="text-base-content pt-0.5 mb-3 flex gap-2 font-medium max-sm:flex-col-reverse sm:items-center sm:justify-between">
                <span class="text-sm sm:text-base">解析開始</span>
                <span class="text-base-content/50 text-xs sm:text-sm font-normal">今すぐ</span>
              </div>
              <p class="mb-2 text-xs sm:text-sm">AIによる画像解析を開始しました。</p>

              <!-- アップロードUIを流用した解析進捗表示 -->
              <div class="mx-4 sm:mx-8 lg:mx-12 space-y-2" id="analysis-progress-previews">
                <!-- 各画像の解析進捗はJavaScriptで動的に生成 -->
              </div>
            </div>
            <hr class="bg-warning" />
          </li>

          <!-- 解析失敗（2つ目のタイムラインが失敗時に変更される） -->
          <li id="timeline-item-2-error" class="hidden" style="display: none;">
            <hr class="bg-error" />
            <div class="timeline-middle">
              <span class="badge badge-error size-4.5 rounded-full p-0">
                <span class="icon-[tabler--alert-triangle] text-error-content size-3.5"></span>
              </span>
            </div>
            <div class="timeline-end ms-2 m-3 w-full rounded-lg p-3 sm:p-4 pt-1 border border-error/30 bg-error/5">
              <div
                class="text-base-content pt-0.5 mb-3 flex gap-2 font-medium max-sm:flex-col-reverse sm:items-center sm:justify-between">
                <span class="text-sm sm:text-base">解析失敗</span>
                <span class="text-base-content/50 text-xs sm:text-sm font-normal">今すぐ</span>
              </div>
              <p class="mb-2 text-xs sm:text-sm">解析が失敗しました</p>
              <div class="flex items-center gap-2">
                <span class="icon-[tabler--alert-circle] text-error size-4 sm:size-5"></span>
                <span class="text-xs sm:text-sm text-error font-medium">解析失敗</span>
              </div>
            </div>
            <hr class="bg-error" />
          </li>

          <!-- 解析完了 -->
          <li id="timeline-item-3" class="hidden" style="display: none;">
            <hr class="bg-success" />
            <div class="timeline-end ms-2 m-3 w-full rounded-lg p-3 sm:p-4 pt-1 bg-success/5 border border-success/20">
              <div
                class="text-base-content pt-0.5 mb-3 flex gap-2 font-medium max-sm:flex-col-reverse sm:items-center sm:justify-between">
                <span class="text-sm sm:text-base">解析完了</span>
                <span class="text-base-content/50 text-xs sm:text-sm font-normal">今すぐ</span>
              </div>
              <p class="mb-2 text-xs sm:text-sm">画像のカテゴリー分類が完了しました</p>
              <div class="flex items-center gap-2">
                <span class="icon-[tabler--brain] text-info size-4 sm:size-5"></span>
                <span class="text-xs sm:text-sm text-info font-medium">完了</span>
              </div>
            </div>
            <hr class="bg-success" />
          </li>

          <!-- 解析失敗 -->
          <li id="timeline-item-3-error" class="hidden" style="display: none;">
            <hr class="bg-error" />
            <div class="timeline-middle">
              <span class="badge badge-error size-4.5 rounded-full p-0">
                <span class="icon-[tabler--alert-triangle] text-error-content size-3.5"></span>
              </span>
            </div>
            <div class="timeline-end ms-2 m-3 w-full rounded-lg p-3 sm:p-4 pt-1 border border-error/30 bg-error/5">
              <div
                class="text-base-content pt-0.5 mb-3 flex gap-2 font-medium max-sm:flex-col-reverse sm:items-center sm:justify-between">
                <span class="text-sm sm:text-base">解析失敗</span>
                <span class="text-base-content/50 text-xs sm:text-sm font-normal">今すぐ</span>
              </div>
              <p class="mb-2 text-xs sm:text-sm">解析が失敗しました</p>
              <div class="flex items-center gap-2">
                <span class="icon-[tabler--alert-circle] text-error size-4 sm:size-5"></span>
                <span class="text-xs sm:text-sm text-error font-medium">解析失敗</span>
              </div>
            </div>
            <hr class="bg-error" />
          </li>


        </ul>

      </div><!-- /#file-upload-limit -->
    </div>
  </div>
</div>

<div class="h-16"></div>

<!-- モデル選択モーダル -->
<div id="slide-down-animated-modal" class="overlay modal overlay-open:opacity-100 overlay-open:duration-300 hidden"
  role="dialog" tabindex="-1">
  <div
    class="modal-dialog overlay-open:mt-4 sm:overlay-open:mt-8 lg:overlay-open:mt-12 overlay-open:duration-300 transition-all ease-out max-w-sm sm:max-w-md lg:max-w-lg">
    <div class="modal-content">
      <div class="modal-header p-4 sm:p-6">
        <h3 class="modal-title text-lg sm:text-xl">画像解析モデル選択</h3>
        <button type="button" class="btn btn-text btn-circle btn-sm absolute end-3 top-3" aria-label="Close"
          data-overlay="#slide-down-animated-modal">
          <span class="icon-[tabler--x] size-4"></span>
        </button>
      </div>
      <div class="modal-body p-4 sm:p-6">
        <div class="flex flex-col gap-4 sm:gap-6">
          <div class="text-center">
            <p class="text-sm sm:text-base text-gray-600 mb-2">アップロードされた画像を解析するための機械学習モデルを選択してください。</p>
            <p class="text-xs sm:text-sm text-gray-500">各モデルは異なる特徴を持ち、解析目的に応じて最適なものを選択できます。</p>
          </div>
          <div class="space-y-3">
            <div class="form-control">
              <label class="label"><span class="label-text font-semibold text-sm sm:text-base">解析モデル</span></label>
              <select class="select select-bordered w-full text-sm sm:text-base" id="model-selector">
                <option value="">モデルを選択してください</option>
                <option value="resnet50">PyTorch ResNet-50 (汎用画像分類)</option>
                <option value="efficientnet">TensorFlow EfficientNet (軽量・高速)</option>
                <option value="mobilenet">PyTorch MobileNet (モバイル最適化)</option>
                <option value="vgg16">PyTorch VGG-16 (高精度・詳細分析)</option>
                <option value="custom">CLIP (柔軟なテキストラベル分類)</option>
              </select>
            </div>
            <div class="bg-base-200 rounded-lg p-3 sm:p-4">
              <h4 class="font-semibold text-xs sm:text-sm mb-2">選択されたモデルの特徴</h4>
              <p class="text-xs sm:text-sm text-gray-600" id="model-description">モデルを選択すると、ここに詳細な説明が表示されます。</p>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="flex justify-end gap-3">
          <button type="button" class="btn btn-soft btn-secondary"
            data-overlay="#slide-down-animated-modal">キャンセル</button>
          <button type="button" class="btn btn-primary" id="modal-start-analysis-btn">
            <span class="icon-[tabler--player-play] size-5 mr-2"></span>解析開始
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- 簡素化されたアップロード機能 -->
<script src="{% static 'js/upload-simplified.js' %}?v={{ timestamp|default:'1.0' }}"></script>
<script>
  // セッションから保存されたモデル選択を復元
  document.addEventListener('DOMContentLoaded', function () {
    const selectedModel = '{{ selected_model|default:""|escapejs }}';
    const modelSelector = document.getElementById('model-selector');

    if (selectedModel && modelSelector) {
      modelSelector.value = selectedModel;
    }

    // セッションから解析状態を復元
    const analysisStatus = '{{ analysis_status|default:""|escapejs }}';
    const uploadedImagesStr = '{{ uploaded_images_json|default:"[]"|escapejs }}';
    let uploadedImages = [];
    try {
      uploadedImages = JSON.parse(uploadedImagesStr);
    } catch (e) {
      console.error('JSON解析エラー:', e);
      uploadedImages = [];
    }

    console.log('デバッグ: analysisStatus =', analysisStatus);
    console.log('デバッグ: analysisStatus type =', typeof analysisStatus);
    console.log('デバッグ: analysisStatus length =', analysisStatus.length);
    console.log('デバッグ: analysisStatus === "uploaded" =', analysisStatus === 'uploaded');
    console.log('デバッグ: analysisStatus === "failed" =', analysisStatus === 'failed');
    console.log('デバッグ: uploadedImages =', uploadedImages);

    // リロード時の状態復元中であることを示すフラグを設定
    window.isRestoringState = true;
    console.log('🔄 デバッグ: 状態復元を開始');
    console.log('🔄 デバッグ: 現在のURL:', window.location.href);
    console.log('🔄 デバッグ: ページタイトル:', document.title);

    // リロード時にuploadSuccessShownフラグをリセットしない
    if (uploadedImages && uploadedImages.length > 0) {
      window.uploadSuccessShown = true;
      console.log('🔄 デバッグ: アップロード済み画像があるため、uploadSuccessShownフラグをtrueに設定');
    } else {
      console.log('🔄 デバッグ: アップロード済み画像がないため、uploadSuccessShownフラグはfalseのまま');
    }

    if (uploadedImages && uploadedImages.length > 0) {
      console.log('🔄 デバッグ: アップロード済み画像データを処理開始');
      console.log('🔄 デバッグ: 生のuploadedImagesデータ:', uploadedImages);
      console.log('🔄 デバッグ: uploadedImagesの型:', typeof uploadedImages);
      console.log('🔄 デバッグ: uploadedImagesの長さ:', uploadedImages.length);

      // uploadedImagesは既にJavaScriptオブジェクトなので、そのまま使用
      const images = uploadedImages;
      console.log('🔄 デバッグ: 解析された画像データ:', images);
      console.log('🔄 デバッグ: 画像数:', images.length);

      console.log('🔄 デバッグ: 画像が存在するため、UI状態を復元します');
      // 1つ目のタイムライン（アップロード完了）を表示
      const timelineContainer = document.getElementById('timeline-container');
      const timeline1 = document.getElementById('timeline-item-1-success');

      console.log('🔄 デバッグ: タイムライン要素の取得結果:');
      console.log('🔄 デバッグ: timelineContainer:', timelineContainer);
      console.log('🔄 デバッグ: timeline1:', timeline1);

      if (timelineContainer && timeline1) {
        timelineContainer.classList.remove('hidden');
        timelineContainer.style.display = 'block';
        timeline1.classList.remove('hidden');
        timeline1.style.display = 'block';
        console.log('🔄 デバッグ: アップロード完了タイムラインを表示しました');
      } else {
        console.log('🔄 デバッグ: タイムライン要素が見つかりません');
      }

      // アップロード完了後は解析ボタンを表示し、アップロードボタンを非表示にする
      const analysisButton = document.getElementById('analysis-button-container');
      const uploadButtonContainer = document.getElementById('upload-button-container');

      console.log('🔄 デバッグ: ボタン要素の取得結果:');
      console.log('🔄 デバッグ: analysisButton:', analysisButton);
      console.log('🔄 デバッグ: uploadButtonContainer:', uploadButtonContainer);

      if (analysisButton) {
        analysisButton.classList.remove('hidden');
        console.log('🔄 デバッグ: 解析ボタンを表示しました');
        console.log('🔄 デバッグ: 解析ボタンのクラス:', analysisButton.className);
        console.log('🔄 デバッグ: 解析ボタンのスタイル:', analysisButton.style.display);
      } else {
        console.log('🔄 デバッグ: 解析ボタンが見つかりません');
      }

      if (uploadButtonContainer) {
        uploadButtonContainer.classList.add('hidden');
        console.log('🔄 デバッグ: アップロードボタンを非表示にしました');
        console.log('🔄 デバッグ: アップロードボタンのクラス:', uploadButtonContainer.className);
        console.log('🔄 デバッグ: アップロードボタンのスタイル:', uploadButtonContainer.style.display);
      } else {
        console.log('🔄 デバッグ: アップロードボタンが見つかりません');
      }

      // 解析が実際に開始されている場合のみ2つ目以降のタイムラインを表示
      console.log('🔄 デバッグ: 解析タイムライン表示条件のチェック開始');
      console.log('🔄 デバッグ: analysisStatus =', analysisStatus);
      console.log('🔄 デバッグ: analysisStatus !== "uploaded" チェック:', analysisStatus !== 'uploaded');
      console.log('🔄 デバッグ: analysisStatus === "uploaded" チェック:', analysisStatus === 'uploaded');

      // 解析が開始されている場合のみ2つ目以降のタイムラインを表示
      // uploaded状態や空文字列の場合は解析タイムラインを表示しない
      if (analysisStatus &&
        analysisStatus !== 'uploaded' &&
        analysisStatus !== '' &&
        analysisStatus.trim() !== '' &&
        (analysisStatus === 'analyzing' || analysisStatus === 'completed' || analysisStatus === 'failed')) {

        console.log('🔄 デバッグ: 解析タイムラインを表示する条件を満たしています');
        // 2つ目のタイムライン（解析開始）を表示
        const timeline2 = document.getElementById('timeline-item-2');
        if (timeline2) {
          timeline2.classList.remove('hidden');
          timeline2.style.display = 'block';
        }

        // 解析状態に応じて3つ目のタイムラインを表示
        if (analysisStatus === 'completed') {
          const timeline3 = document.getElementById('timeline-item-3');
          if (timeline3) {
            timeline3.classList.remove('hidden');
            timeline3.style.display = 'block';
          }
          // 解析完了時は解析ボタンを非表示にする
          if (analysisButton) {
            analysisButton.classList.add('hidden');
            console.log('デバッグ: 解析完了のため解析ボタンを非表示');
          }
        } else if (analysisStatus === 'failed') {
          // 失敗時は2つ目のタイムラインを非表示にして、失敗専用タイムラインを表示
          if (timeline2) {
            timeline2.classList.add('hidden');
            timeline2.style.display = 'none';
          }

          // 2つ目のタイムライン（解析失敗）を表示
          const timeline2Error = document.getElementById('timeline-item-2-error');
          if (timeline2Error) {
            timeline2Error.classList.remove('hidden');
            timeline2Error.style.display = 'block';
          }
          if (analysisButton) {
            analysisButton.classList.add('hidden');
            console.log('デバッグ: 解析失敗のため解析ボタンを非表示');
          }
        }
      } else if (analysisStatus === 'uploaded' || analysisStatus === '' || analysisStatus.trim() === '') {
        console.log('🔄 デバッグ: アップロード完了のみのため、解析タイムラインは表示しません');
        console.log('🔄 デバッグ: analysisStatus =', analysisStatus);

        // アップロード完了時は解析タイムラインを確実に非表示にする
        const timeline2 = document.getElementById('timeline-item-2');
        const timeline2Error = document.getElementById('timeline-item-2-error');
        const timeline3 = document.getElementById('timeline-item-3');

        if (timeline2) {
          timeline2.classList.add('hidden');
          timeline2.style.display = 'none';
          console.log('デバッグ: 解析開始タイムラインを非表示');
        }
        if (timeline2Error) {
          timeline2Error.classList.add('hidden');
          timeline2Error.style.display = 'none';
          console.log('デバッグ: 解析失敗タイムラインを非表示');
        }
        if (timeline3) {
          timeline3.classList.add('hidden');
          timeline3.style.display = 'none';
          console.log('デバッグ: 解析完了タイムラインを非表示');
        }
      } else {
        console.log('🔄 デバッグ: 不明な状態のため、解析タイムラインは表示しません');
        console.log('🔄 デバッグ: analysisStatus =', analysisStatus);

        // 不明な状態でも解析タイムラインを非表示にする
        const timeline2 = document.getElementById('timeline-item-2');
        const timeline2Error = document.getElementById('timeline-item-2-error');
        const timeline3 = document.getElementById('timeline-item-3');

        if (timeline2) {
          timeline2.classList.add('hidden');
          timeline2.style.display = 'none';
        }
        if (timeline2Error) {
          timeline2Error.classList.add('hidden');
          timeline2Error.style.display = 'none';
        }
        if (timeline3) {
          timeline3.classList.add('hidden');
          timeline3.style.display = 'none';
        }
      }

      console.log('解析状態を復元しました:', analysisStatus);
    }
  } else {
    console.log('🔄 デバッグ: アップロード済み画像がない場合の処理');
    // アップロード済み画像がない場合は、アップロードボタンを表示し、解析ボタンを非表示にする
    const analysisButton = document.getElementById('analysis-button-container');
    const uploadButtonContainer = document.getElementById('upload-button-container');

    console.log('🔄 デバッグ: ボタン要素の取得結果（画像なし）:');
    console.log('🔄 デバッグ: analysisButton:', analysisButton);
    console.log('🔄 デバッグ: uploadButtonContainer:', uploadButtonContainer);

    if(analysisButton) {
      analysisButton.classList.add('hidden');
      console.log('🔄 デバッグ: アップロード済み画像がないため解析ボタンを非表示にしました');
    } else {
      console.log('🔄 デバッグ: 解析ボタンが見つかりません');
    }

    if(uploadButtonContainer) {
      uploadButtonContainer.classList.remove('hidden');
      console.log('🔄 デバッグ: アップロード済み画像がないためアップロードボタンを表示しました');
    } else {
      console.log('🔄 デバッグ: アップロードボタンが見つかりません');
    }
  }

  // 状態復元完了
  window.isRestoringState = false;
  console.log('🔄 デバッグ: 状態復元完了');
  console.log('🔄 デバッグ: 最終的なUI状態:');
  console.log('🔄 デバッグ: - タイムラインコンテナ:', document.getElementById('timeline-container')?.style.display);
  console.log('🔄 デバッグ: - 解析ボタン:', document.getElementById('analysis-button-container')?.style.display);
  console.log('🔄 デバッグ: - アップロードボタン:', document.getElementById('upload-button-container')?.style.display);
  console.log('🔄 デバッグ: - uploadSuccessShown:', window.uploadSuccessShown);
  console.log('🔄 デバッグ: - isRestoringState:', window.isRestoringState);

  // 初期化時に解析タイムラインを確実に非表示にする
  console.log('🔄 デバッグ: 初期化時の解析タイムライン非表示処理開始');
  const timeline2 = document.getElementById('timeline-item-2');
  const timeline2Error = document.getElementById('timeline-item-2-error');
  const timeline3 = document.getElementById('timeline-item-3');

  console.log('🔄 デバッグ: 解析タイムライン要素の取得結果:');
  console.log('🔄 デバッグ: timeline2:', timeline2);
  console.log('🔄 デバッグ: timeline2Error:', timeline2Error);
  console.log('🔄 デバッグ: timeline3:', timeline3);

  if (timeline2) {
    timeline2.classList.add('hidden');
    timeline2.style.display = 'none';
    console.log('🔄 デバッグ: 初期化時に解析開始タイムラインを非表示にしました');
  } else {
    console.log('🔄 デバッグ: 解析開始タイムラインが見つかりません');
  }

  if (timeline2Error) {
    timeline2Error.classList.add('hidden');
    timeline2Error.style.display = 'none';
    console.log('🔄 デバッグ: 初期化時に解析失敗タイムラインを非表示にしました');
  } else {
    console.log('🔄 デバッグ: 解析失敗タイムラインが見つかりません');
  }

  if (timeline3) {
    timeline3.classList.add('hidden');
    timeline3.style.display = 'none';
    console.log('🔄 デバッグ: 初期化時に解析完了タイムラインを非表示にしました');
  } else {
    console.log('🔄 デバッグ: 解析完了タイムラインが見つかりません');
  }

  // 解析完了失敗タイムラインも非表示にする
  const timeline3Error = document.getElementById('timeline-item-3-error');
  if (timeline3Error) {
    timeline3Error.classList.add('hidden');
    timeline3Error.style.display = 'none';
    console.log('🔄 デバッグ: 初期化時に解析完了失敗タイムラインを非表示にしました');
  } else {
    console.log('🔄 デバッグ: 解析完了失敗タイムラインが見つかりません');
  }

  console.log('🔄 デバッグ: 初期化時の解析タイムライン非表示処理完了');
  });

  // 初回解析機能
  function startAnalysis(modelName) {
    console.log('初回解析開始:', modelName);

    // 初回解析フラグを設定
    window.isRetryAnalysis = false;

    // 2つ目のタイムライン（解析開始）を表示
    const timeline2 = document.getElementById('timeline-item-2');
    if (timeline2) {
      timeline2.classList.remove('hidden');
      timeline2.style.display = 'block';
      console.log('2つ目のタイムライン（解析開始）を表示');

      // 進捗バーを生成
      generateAnalysisProgressBar();
    }

    // 解析ボタンを無効化
    const analysisButton = document.getElementById('start-analysis-btn');
    if (analysisButton) {
      analysisButton.disabled = true;
      analysisButton.innerHTML = '<span class="icon-[tabler--loader-2] size-5 mr-2 animate-spin"></span>解析中...';
    }

    // 解析APIを呼び出し
    fetch('/api/analysis/start/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken()
      },
      body: JSON.stringify({
        model_name: modelName
      })
    })
      .then(response => response.json())
      .then(data => {
        console.log('解析API応答:', data);
        if (data.success) {
          // 解析開始成功 - 進捗監視を開始
          console.log('解析が開始されました。進捗を監視します。');
          startAnalysisProgressMonitoring();
        } else {
          alert('解析の開始に失敗しました: ' + (data.error || '不明なエラー'));
          // ボタンを元に戻す
          if (analysisButton) {
            analysisButton.disabled = false;
            analysisButton.innerHTML = '<span class="icon-[tabler--brain] size-5 mr-2"></span>モデルを選択';
          }
        }
      })
      .catch(error => {
        console.error('解析開始API呼び出しエラー:', error);
        alert('解析の開始中にエラーが発生しました: ' + error.message);
        // ボタンを元に戻す
        if (analysisButton) {
          analysisButton.disabled = false;
          analysisButton.innerHTML = '<span class="icon-[tabler--brain] size-5 mr-2"></span>モデルを選択';
        }
      });
  }


  // 現在の画像IDを取得
  function getCurrentImageId() {
    // セッションから取得した画像データを使用
    if (uploadedImages && uploadedImages.length > 0) {
      return uploadedImages[0].id; // 最初の画像のIDを返す
    }
    return null;
  }


  // 初回解析進捗バー生成
  function generateAnalysisProgressBar() {
    const container = document.getElementById('analysis-progress-previews');
    if (!container) return;

    container.innerHTML = `
      <div class="rounded-box bg-base-100 shadow-base-300/20 p-3 shadow-lg">
        <div class="mb-1 flex items-center justify-between">
          <div class="flex items-center gap-x-3">
            <span class="text-base-content/80 border-base-content/20 flex size-8 items-center justify-center rounded-lg border p-0.5">
              <span class="icon-[tabler--photo] text-base-content/70 size-5"></span>
            </span>
            <div>
              <p class="text-base-content text-sm font-medium">解析中...</p>
              <p class="text-base-content/50 text-xs">AIによる画像解析を実行中です</p>
            </div>
          </div>
        </div>
        <div class="flex items-center gap-x-3 whitespace-nowrap">
          <div class="progress h-2" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
            <div class="progress-bar progress-primary transition-all duration-500" style="width:0%"></div>
          </div>
          <span class="text-base-content mb-0.5 text-sm">0%</span>
        </div>
      </div>
    `;
  }

  // 初回解析進捗監視
  function startAnalysisProgressMonitoring() {
    const progressBar = document.querySelector('#analysis-progress-previews .progress-bar');
    const progressValue = document.querySelector('#analysis-progress-previews .text-sm');

    if (!progressBar || !progressValue) return;

    let progress = 0;
    const interval = setInterval(() => {
      progress += Math.random() * 10;
      if (progress > 100) progress = 100;

      progressBar.style.width = `${progress}%`;
      progressValue.textContent = `${Math.round(progress)}%`;

      if (progress >= 100) {
        clearInterval(interval);
        // 解析完了タイムラインを表示
        showAnalysisCompletedTimeline();
      }
    }, 500);
  }

  // 初回解析完了タイムライン表示
  function showAnalysisCompletedTimeline() {
    const timeline3 = document.getElementById('timeline-item-3');
    if (timeline3) {
      timeline3.classList.remove('hidden');
      timeline3.style.display = 'block';
      console.log('3つ目のタイムライン（解析完了）を表示');
    }
  }


  // CSRFトークン取得
  function getCSRFToken() {
    const token = document.querySelector('[name=csrfmiddlewaretoken]');
    return token ? token.value : '';
  }

  // モーダル内の解析開始ボタンのイベント設定
  const modalStartButton = document.getElementById('modal-start-analysis-btn');
  if (modalStartButton) {
    modalStartButton.addEventListener('click', function () {
      const selector = document.getElementById('model-selector');
      const model = selector ? selector.value : '';
      if (!model) {
        alert('モデルを選択してください');
        return;
      }

      // 初回解析を実行
      window.isRetryAnalysis = false;
      startAnalysis(model);
    });
  }


</script>
{% endblock %}

{% block extra_css %}
<style>
  /* タイムラインの表示を有効化 */
  #timeline-container .timeline-middle {
    display: flex !important;
  }

  /* タイムラインのスタイル調整 */
  #timeline-container .timeline-end {
    margin-left: 1rem !important;
  }
</style>
{% endblock %}