{% extends 'base.html' %}
{% load static %}

{% block title %}ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ - ç”»åƒè§£æã‚¢ãƒ—ãƒª{% endblock %}

{% block content %}
<!-- ãƒšãƒ¼ã‚¸ãƒ˜ãƒƒãƒ€ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
<div class="pt-16 py-2 sm:py-4 lg:pt-24 lg:pb-12">
  <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
    <div class="mb-1 space-y-4 text-center sm:mb-2 lg:mb-3">
      <h2 class="text-base-content text-2xl font-semibold md:text-3xl lg:text-4xl">
        <span class="relative z-1 font-bold">
          ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
          <span class="from-primary absolute start-0 bottom-1 -z-1 h-0.5 w-full bg-gradient-to-r to-transparent to-80%"
            aria-hidden="true"></span>
        </span>
        & è§£æ
      </h2>
      <p class="text-base-content/80 text-xl">
        ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¨è§£æãŒã§ãã¾ã™ã€‚
      </p>
      <div class="group flex items-center justify-center gap-2 pt-4 pb-2">
        <span
          class="icon-[tabler--chevron-left] text-primary size-5 shrink-0 transition-transform group-hover:-translate-x-1 rtl:rotate-180"></span>
        <a href="{% url 'user_image_table' %}" class="link link-animated link-primary font-normal">ç”»åƒä¸€è¦§ã¸</a>
      </div>
    </div>
  </div>
</div>

<div class="pt-0 mb-8 px-4 sm:px-6 lg:px-8">
  <div class="card max-w-5xl w-full mx-auto">
    <div class="card-header">
      <h5 class="card-title text-lg sm:text-xl">ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h5>
    </div>
    <div class="card-body p-4 sm:p-6">

      <!-- CSRFãƒˆãƒ¼ã‚¯ãƒ³ -->
      {% csrf_token %}


      <!-- data-file-upload ã¯å³å¯†ãª JSON -->
      <div id="file-upload-limit" data-file-upload='{
             "url": "/api/form-upload/",
             "maxFilesize": 1,
             "maxFiles": 5,
             "autoProcessQueue": false,
             "extensions": {
               "jpg": { "class": "shrink-0 size-5" },
               "png": { "class": "shrink-0 size-5" },
               "gif": { "class": "shrink-0 size-5" }
             }
           }'>

        <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ -->
        <template data-file-upload-preview="">
          <div class="rounded-box bg-base-100 shadow-base-300/20 p-3 shadow-lg">
            <div class="mb-1 flex items-center justify-between">
              <div class="flex items-center gap-x-3">
                <span
                  class="text-base-content/80 border-base-content/20 flex size-8 items-center justify-center rounded-lg border p-0.5"
                  data-file-upload-file-icon="">
                  <img class="hidden rounded-md" data-dz-thumbnail="" alt="">
                </span>
                <div>
                  <p class="text-base-content text-sm font-medium">
                    <span class="inline-block truncate align-bottom" data-file-upload-file-name=""></span>.
                    <span data-file-upload-file-ext=""></span>
                  </p>
                  <p class="text-base-content/50 text-xs" data-file-upload-file-size=""
                    data-file-upload-file-success=""></p>
                  <p class="text-error text-xs" style="display:none" data-file-upload-file-error="">File exceeds size
                    limit.</p>
                </div>
              </div>
              <div class="flex items-center">
                <div class="tooltip [--placement:top]" style="display:none" data-file-upload-file-error="">
                  <button type="button" class="tooltip-toggle btn btn-sm btn-circle btn-text btn-error">
                    <span class="icon-[tabler--alert-circle] size-4 shrink-0"></span>
                  </button>
                  <span class="tooltip-content tooltip-shown:opacity-100 tooltip-shown:visible" role="tooltip">
                    <span class="tooltip-body">Please try to upload a file smaller than 1MB.</span>
                  </span>
                </div>
                <button type="button" class="btn btn-sm btn-circle btn-text" data-file-upload-reload="">
                  <span class="icon-[tabler--refresh] size-4 shrink-0"></span>
                </button>
                <button type="button" class="btn btn-sm btn-circle btn-text" data-file-upload-remove="">
                  <span class="icon-[tabler--trash] size-4 shrink-0"></span>
                </button>
              </div>
            </div>
            <div class="flex items-center gap-x-3 whitespace-nowrap">
              <div class="progress h-2" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"
                data-file-upload-progress-bar="">
                <div
                  class="progress-bar progress-primary file-upload-complete:progress-success transition-all duration-500"
                  style="width:0" data-file-upload-progress-bar-pane=""></div>
              </div>
              <span class="text-base-content mb-0.5 text-sm">
                <span data-file-upload-progress-bar-value="">0</span>%
              </span>
            </div>
          </div>
        </template>

        <!-- ãƒ‰ãƒ­ãƒƒãƒ—é ˜åŸŸ -->
        <div
          class="bg-base-200/60 rounded-box flex flex-col justify-center border-2 border-base-content/20 border-dashed">
          <div class="text-center cursor-pointer p-6 sm:p-8 lg:p-12" data-file-upload-trigger="">
            <p class="text-base-content/50 mb-3 text-xs sm:text-sm">1MBä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚ï¼ˆæœ€å¤§5æšã€åˆè¨ˆ5MBã¾ã§ï¼‰</p>
            <button class="btn btn-soft btn-sm btn-primary text-nowrap">
              <span class="icon-[tabler--file-upload] size-4 sm:size-4.5 shrink-0"></span>
              <span class="hidden sm:inline">ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</span>
              <span class="sm:hidden">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</span>
            </button>
            <p class="text-base-content/50 my-2 text-xs">ã¾ãŸã¯</p>
            <p class="link link-animated link-primary font-medium text-xs sm:text-sm">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</p>
          </div>
          <div class="mx-4 sm:mx-8 lg:mx-12 mb-4 sm:mb-6 lg:mb-8 space-y-2 empty:m-0" data-file-upload-previews="">
          </div>
        </div>

        <!-- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹ãƒœã‚¿ãƒ³ -->
        <div id="upload-button-container" class="hidden flex justify-center mt-4">
          <button id="start-upload-btn" class="btn btn-primary btn-outline waves waves-primary">
            <span class="icon-[tabler--upload] size-5 mr-2"></span>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹
          </button>
        </div>

        <!-- è§£æé–‹å§‹(ãƒ¢ãƒ‡ãƒ«é¸æŠ)ãƒœã‚¿ãƒ³ -->
        <div id="analysis-button-container" class="hidden flex justify-center mt-4">
          <button id="start-analysis-btn" class="btn btn-primary btn-outline waves waves-primary"
            data-overlay="#slide-down-animated-modal">
            <span class="icon-[tabler--brain] size-5 mr-2"></span>ãƒ¢ãƒ‡ãƒ«ã‚’é¸æŠ
          </button>
        </div>




        <!-- ãƒ¢ãƒ‡ãƒ«æœªé¸æŠã‚¢ãƒ©ãƒ¼ãƒˆ -->
        <div id="model-selection-alert" class="alert alert-outline alert-warning hidden" role="alert">
          <span class="icon-[tabler--alert-triangle] size-5"></span>
          <div>
            <h3 class="font-semibold">ãƒ¢ãƒ‡ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</h3>
            <div class="text-xs">ç”»åƒä¸€è¦§ã«é€²ã‚€å‰ã«ã€è§£æãƒ¢ãƒ‡ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</div>
          </div>
        </div>

        <!-- ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ -->
        <ul id="timeline-container"
          class="timeline timeline-snap-icon timeline-compact timeline-vertical w-full hidden">

          <!-- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æˆåŠŸ -->
          <li id="timeline-item-1-success" class="hidden">
            <div class="timeline-end ms-2 m-3 w-full rounded-lg p-3 sm:p-4 pt-1 bg-success/5 border border-success/20">
              <div
                class="text-base-content pt-0.5 mb-3 flex gap-2 font-medium max-sm:flex-col-reverse sm:items-center sm:justify-between">
                <span class="text-sm sm:text-base">ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†</span>
                <span class="text-base-content/50 text-xs sm:text-sm font-normal">ä»Šã™ã</span>
              </div>
              <p id="timeline-description" class="mb-2 text-xs sm:text-sm">ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«æˆåŠŸã—ã¾ã—ãŸ</p>
              <div class="flex items-center gap-2">
                <span class="icon-[tabler--check-circle] text-success size-4 sm:size-5"></span>
                <span class="text-xs sm:text-sm text-success font-medium">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æˆåŠŸ</span>
              </div>
            </div>
          </li>

          <!-- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•— -->
          <li id="timeline-item-1-error" class="hidden">
            <hr class="bg-error" />
            <div class="timeline-middle">
              <span class="badge badge-error size-4.5 rounded-full p-0">
                <span class="icon-[tabler--alert-triangle] text-error-content size-3.5"></span>
              </span>
            </div>
            <div class="timeline-end ms-2 m-3 w-full rounded-lg p-3 sm:p-4 pt-1 border border-error/30 bg-error/5">
              <div
                class="text-base-content pt-0.5 mb-3 flex gap-2 font-medium max-sm:flex-col-reverse sm:items-center sm:justify-between">
                <span class="text-sm sm:text-base">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—</span>
                <span class="text-base-content/50 text-xs sm:text-sm font-normal">ä»Šã™ã</span>
              </div>
              <p id="timeline-error-description" class="mb-2 text-xs sm:text-sm">ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ</p>
              <div class="flex items-center gap-2">
                <span class="icon-[tabler--alert-circle] text-error size-4 sm:size-5"></span>
                <span class="text-xs sm:text-sm text-error font-medium">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—</span>
              </div>
            </div>
            <hr class="bg-error" />
          </li>

          <!-- è§£æé–‹å§‹ -->
          <li id="timeline-item-2" class="hidden" style="display: none;">
            <hr class="bg-warning" />
            <div class="timeline-end ms-2 m-3 w-full rounded-lg p-3 sm:p-4 pt-1 bg-warning/5 border border-warning/20">
              <div
                class="text-base-content pt-0.5 mb-3 flex gap-2 font-medium max-sm:flex-col-reverse sm:items-center sm:justify-between">
                <span class="text-sm sm:text-base">è§£æé–‹å§‹</span>
                <span class="text-base-content/50 text-xs sm:text-sm font-normal">ä»Šã™ã</span>
              </div>
              <p class="mb-2 text-xs sm:text-sm">AIã«ã‚ˆã‚‹ç”»åƒè§£æã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚</p>

              <!-- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰UIã‚’æµç”¨ã—ãŸè§£æé€²æ—è¡¨ç¤º -->
              <div class="mx-4 sm:mx-8 lg:mx-12 space-y-2" id="analysis-progress-previews">
                <!-- å„ç”»åƒã®è§£æé€²æ—ã¯JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
              </div>
            </div>
            <hr class="bg-warning" />
          </li>

          <!-- è§£æå¤±æ•—ï¼ˆ2ã¤ç›®ã®ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãŒå¤±æ•—æ™‚ã«å¤‰æ›´ã•ã‚Œã‚‹ï¼‰ -->
          <li id="timeline-item-2-error" class="hidden" style="display: none;">
            <hr class="bg-error" />
            <div class="timeline-middle">
              <span class="badge badge-error size-4.5 rounded-full p-0">
                <span class="icon-[tabler--alert-triangle] text-error-content size-3.5"></span>
              </span>
            </div>
            <div class="timeline-end ms-2 m-3 w-full rounded-lg p-3 sm:p-4 pt-1 border border-error/30 bg-error/5">
              <div
                class="text-base-content pt-0.5 mb-3 flex gap-2 font-medium max-sm:flex-col-reverse sm:items-center sm:justify-between">
                <span class="text-sm sm:text-base">è§£æå¤±æ•—</span>
                <span class="text-base-content/50 text-xs sm:text-sm font-normal">ä»Šã™ã</span>
              </div>
              <p class="mb-2 text-xs sm:text-sm">è§£æãŒå¤±æ•—ã—ã¾ã—ãŸ</p>
              <div class="flex items-center gap-2">
                <span class="icon-[tabler--alert-circle] text-error size-4 sm:size-5"></span>
                <span class="text-xs sm:text-sm text-error font-medium">è§£æå¤±æ•—</span>
              </div>
            </div>
            <hr class="bg-error" />
          </li>

          <!-- è§£æå®Œäº† -->
          <li id="timeline-item-3" class="hidden" style="display: none;">
            <hr class="bg-success" />
            <div class="timeline-end ms-2 m-3 w-full rounded-lg p-3 sm:p-4 pt-1 bg-success/5 border border-success/20">
              <div
                class="text-base-content pt-0.5 mb-3 flex gap-2 font-medium max-sm:flex-col-reverse sm:items-center sm:justify-between">
                <span class="text-sm sm:text-base">è§£æå®Œäº†</span>
                <span class="text-base-content/50 text-xs sm:text-sm font-normal">ä»Šã™ã</span>
              </div>
              <p class="mb-2 text-xs sm:text-sm">ç”»åƒã®ã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ†é¡ãŒå®Œäº†ã—ã¾ã—ãŸ</p>
              <div class="flex items-center gap-2">
                <span class="icon-[tabler--brain] text-info size-4 sm:size-5"></span>
                <span class="text-xs sm:text-sm text-info font-medium">å®Œäº†</span>
              </div>
            </div>
            <hr class="bg-success" />
          </li>

          <!-- è§£æå¤±æ•— -->
          <li id="timeline-item-3-error" class="hidden" style="display: none;">
            <hr class="bg-error" />
            <div class="timeline-middle">
              <span class="badge badge-error size-4.5 rounded-full p-0">
                <span class="icon-[tabler--alert-triangle] text-error-content size-3.5"></span>
              </span>
            </div>
            <div class="timeline-end ms-2 m-3 w-full rounded-lg p-3 sm:p-4 pt-1 border border-error/30 bg-error/5">
              <div
                class="text-base-content pt-0.5 mb-3 flex gap-2 font-medium max-sm:flex-col-reverse sm:items-center sm:justify-between">
                <span class="text-sm sm:text-base">è§£æå¤±æ•—</span>
                <span class="text-base-content/50 text-xs sm:text-sm font-normal">ä»Šã™ã</span>
              </div>
              <p class="mb-2 text-xs sm:text-sm">è§£æãŒå¤±æ•—ã—ã¾ã—ãŸ</p>
              <div class="flex items-center gap-2">
                <span class="icon-[tabler--alert-circle] text-error size-4 sm:size-5"></span>
                <span class="text-xs sm:text-sm text-error font-medium">è§£æå¤±æ•—</span>
              </div>
            </div>
            <hr class="bg-error" />
          </li>


        </ul>

      </div><!-- /#file-upload-limit -->
    </div>
  </div>
</div>

<div class="h-16"></div>

<!-- ãƒ¢ãƒ‡ãƒ«é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="slide-down-animated-modal" class="overlay modal overlay-open:opacity-100 overlay-open:duration-300 hidden"
  role="dialog" tabindex="-1">
  <div
    class="modal-dialog overlay-open:mt-4 sm:overlay-open:mt-8 lg:overlay-open:mt-12 overlay-open:duration-300 transition-all ease-out max-w-sm sm:max-w-md lg:max-w-lg">
    <div class="modal-content">
      <div class="modal-header p-4 sm:p-6">
        <h3 class="modal-title text-lg sm:text-xl">ç”»åƒè§£æãƒ¢ãƒ‡ãƒ«é¸æŠ</h3>
        <button type="button" class="btn btn-text btn-circle btn-sm absolute end-3 top-3" aria-label="Close"
          data-overlay="#slide-down-animated-modal">
          <span class="icon-[tabler--x] size-4"></span>
        </button>
      </div>
      <div class="modal-body p-4 sm:p-6">
        <div class="flex flex-col gap-4 sm:gap-6">
          <div class="text-center">
            <p class="text-sm sm:text-base text-gray-600 mb-2">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸç”»åƒã‚’è§£æã™ã‚‹ãŸã‚ã®æ©Ÿæ¢°å­¦ç¿’ãƒ¢ãƒ‡ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>
            <p class="text-xs sm:text-sm text-gray-500">å„ãƒ¢ãƒ‡ãƒ«ã¯ç•°ãªã‚‹ç‰¹å¾´ã‚’æŒã¡ã€è§£æç›®çš„ã«å¿œã˜ã¦æœ€é©ãªã‚‚ã®ã‚’é¸æŠã§ãã¾ã™ã€‚</p>
          </div>
          <div class="space-y-3">
            <div class="form-control">
              <label class="label"><span class="label-text font-semibold text-sm sm:text-base">è§£æãƒ¢ãƒ‡ãƒ«</span></label>
              <select class="select select-bordered w-full text-sm sm:text-base" id="model-selector">
                <option value="">ãƒ¢ãƒ‡ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                <option value="resnet50">PyTorch ResNet-50 (æ±ç”¨ç”»åƒåˆ†é¡)</option>
                <option value="efficientnet">TensorFlow EfficientNet (è»½é‡ãƒ»é«˜é€Ÿ)</option>
                <option value="mobilenet">PyTorch MobileNet (ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ–)</option>
                <option value="vgg16">PyTorch VGG-16 (é«˜ç²¾åº¦ãƒ»è©³ç´°åˆ†æ)</option>
                <option value="custom">CLIP (æŸ”è»Ÿãªãƒ†ã‚­ã‚¹ãƒˆãƒ©ãƒ™ãƒ«åˆ†é¡)</option>
              </select>
            </div>
            <div class="bg-base-200 rounded-lg p-3 sm:p-4">
              <h4 class="font-semibold text-xs sm:text-sm mb-2">é¸æŠã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«ã®ç‰¹å¾´</h4>
              <p class="text-xs sm:text-sm text-gray-600" id="model-description">ãƒ¢ãƒ‡ãƒ«ã‚’é¸æŠã™ã‚‹ã¨ã€ã“ã“ã«è©³ç´°ãªèª¬æ˜ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="flex justify-end gap-3">
          <button type="button" class="btn btn-soft btn-secondary"
            data-overlay="#slide-down-animated-modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button type="button" class="btn btn-primary" id="modal-start-analysis-btn">
            <span class="icon-[tabler--player-play] size-5 mr-2"></span>è§£æé–‹å§‹
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- ç°¡ç´ åŒ–ã•ã‚ŒãŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ -->
<script src="{% static 'js/upload-simplified.js' %}?v={{ timestamp|default:'1.0' }}"></script>
<script>
  // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰ä¿å­˜ã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«é¸æŠã‚’å¾©å…ƒ
  document.addEventListener('DOMContentLoaded', function () {
    const selectedModel = '{{ selected_model|default:""|escapejs }}';
    const modelSelector = document.getElementById('model-selector');

    if (selectedModel && modelSelector) {
      modelSelector.value = selectedModel;
    }

    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰è§£æçŠ¶æ…‹ã‚’å¾©å…ƒ
    const analysisStatus = '{{ analysis_status|default:""|escapejs }}';
    const uploadedImagesStr = '{{ uploaded_images_json|default:"[]"|escapejs }}';
    let uploadedImages = [];
    try {
      uploadedImages = JSON.parse(uploadedImagesStr);
    } catch (e) {
      console.error('JSONè§£æã‚¨ãƒ©ãƒ¼:', e);
      uploadedImages = [];
    }

    console.log('ãƒ‡ãƒãƒƒã‚°: analysisStatus =', analysisStatus);
    console.log('ãƒ‡ãƒãƒƒã‚°: analysisStatus type =', typeof analysisStatus);
    console.log('ãƒ‡ãƒãƒƒã‚°: analysisStatus length =', analysisStatus.length);
    console.log('ãƒ‡ãƒãƒƒã‚°: analysisStatus === "uploaded" =', analysisStatus === 'uploaded');
    console.log('ãƒ‡ãƒãƒƒã‚°: analysisStatus === "failed" =', analysisStatus === 'failed');
    console.log('ãƒ‡ãƒãƒƒã‚°: uploadedImages =', uploadedImages);

    // ãƒªãƒ­ãƒ¼ãƒ‰æ™‚ã®çŠ¶æ…‹å¾©å…ƒä¸­ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã™ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
    window.isRestoringState = true;
    console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: çŠ¶æ…‹å¾©å…ƒã‚’é–‹å§‹');
    console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: ç¾åœ¨ã®URL:', window.location.href);
    console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«:', document.title);

    // ãƒªãƒ­ãƒ¼ãƒ‰æ™‚ã«uploadSuccessShownãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆã—ãªã„
    if (uploadedImages && uploadedImages.length > 0) {
      window.uploadSuccessShown = true;
      console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ç”»åƒãŒã‚ã‚‹ãŸã‚ã€uploadSuccessShownãƒ•ãƒ©ã‚°ã‚’trueã«è¨­å®š');
    } else {
      console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ç”»åƒãŒãªã„ãŸã‚ã€uploadSuccessShownãƒ•ãƒ©ã‚°ã¯falseã®ã¾ã¾');
    }

    if (uploadedImages && uploadedImages.length > 0) {
      console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†é–‹å§‹');
      console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: ç”Ÿã®uploadedImagesãƒ‡ãƒ¼ã‚¿:', uploadedImages);
      console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: uploadedImagesã®å‹:', typeof uploadedImages);
      console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: uploadedImagesã®é•·ã•:', uploadedImages.length);

      // uploadedImagesã¯æ—¢ã«JavaScriptã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãªã®ã§ã€ãã®ã¾ã¾ä½¿ç”¨
      const images = uploadedImages;
      console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: è§£æã•ã‚ŒãŸç”»åƒãƒ‡ãƒ¼ã‚¿:', images);
      console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: ç”»åƒæ•°:', images.length);

      console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: ç”»åƒãŒå­˜åœ¨ã™ã‚‹ãŸã‚ã€UIçŠ¶æ…‹ã‚’å¾©å…ƒã—ã¾ã™');
      // 1ã¤ç›®ã®ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ï¼ˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼‰ã‚’è¡¨ç¤º
      const timelineContainer = document.getElementById('timeline-container');
      const timeline1 = document.getElementById('timeline-item-1-success');

      console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¦ç´ ã®å–å¾—çµæœ:');
      console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: timelineContainer:', timelineContainer);
      console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: timeline1:', timeline1);

      if (timelineContainer && timeline1) {
        timelineContainer.classList.remove('hidden');
        timelineContainer.style.display = 'block';
        timeline1.classList.remove('hidden');
        timeline1.style.display = 'block';
        console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ');
      } else {
        console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      }

      // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†å¾Œã¯è§£æãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã—ã€ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹
      const analysisButton = document.getElementById('analysis-button-container');
      const uploadButtonContainer = document.getElementById('upload-button-container');

      console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: ãƒœã‚¿ãƒ³è¦ç´ ã®å–å¾—çµæœ:');
      console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: analysisButton:', analysisButton);
      console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: uploadButtonContainer:', uploadButtonContainer);

      if (analysisButton) {
        analysisButton.classList.remove('hidden');
        console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: è§£æãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ');
        console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: è§£æãƒœã‚¿ãƒ³ã®ã‚¯ãƒ©ã‚¹:', analysisButton.className);
        console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: è§£æãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«:', analysisButton.style.display);
      } else {
        console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: è§£æãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      }

      if (uploadButtonContainer) {
        uploadButtonContainer.classList.add('hidden');
        console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã«ã—ã¾ã—ãŸ');
        console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®ã‚¯ãƒ©ã‚¹:', uploadButtonContainer.className);
        console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«:', uploadButtonContainer.style.display);
      } else {
        console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      }

      // è§£æãŒå®Ÿéš›ã«é–‹å§‹ã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿2ã¤ç›®ä»¥é™ã®ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’è¡¨ç¤º
      console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: è§£æã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¡¨ç¤ºæ¡ä»¶ã®ãƒã‚§ãƒƒã‚¯é–‹å§‹');
      console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: analysisStatus =', analysisStatus);
      console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: analysisStatus !== "uploaded" ãƒã‚§ãƒƒã‚¯:', analysisStatus !== 'uploaded');
      console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: analysisStatus === "uploaded" ãƒã‚§ãƒƒã‚¯:', analysisStatus === 'uploaded');

      // è§£æãŒé–‹å§‹ã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿2ã¤ç›®ä»¥é™ã®ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’è¡¨ç¤º
      // uploadedçŠ¶æ…‹ã‚„ç©ºæ–‡å­—åˆ—ã®å ´åˆã¯è§£æã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’è¡¨ç¤ºã—ãªã„
      if (analysisStatus &&
        analysisStatus !== 'uploaded' &&
        analysisStatus !== '' &&
        analysisStatus.trim() !== '' &&
        (analysisStatus === 'analyzing' || analysisStatus === 'completed' || analysisStatus === 'failed')) {

        console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: è§£æã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’è¡¨ç¤ºã™ã‚‹æ¡ä»¶ã‚’æº€ãŸã—ã¦ã„ã¾ã™');
        // 2ã¤ç›®ã®ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ï¼ˆè§£æé–‹å§‹ï¼‰ã‚’è¡¨ç¤º
        const timeline2 = document.getElementById('timeline-item-2');
        if (timeline2) {
          timeline2.classList.remove('hidden');
          timeline2.style.display = 'block';
        }

        // è§£æçŠ¶æ…‹ã«å¿œã˜ã¦3ã¤ç›®ã®ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’è¡¨ç¤º
        if (analysisStatus === 'completed') {
          const timeline3 = document.getElementById('timeline-item-3');
          if (timeline3) {
            timeline3.classList.remove('hidden');
            timeline3.style.display = 'block';
          }
          // è§£æå®Œäº†æ™‚ã¯è§£æãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹
          if (analysisButton) {
            analysisButton.classList.add('hidden');
            console.log('ãƒ‡ãƒãƒƒã‚°: è§£æå®Œäº†ã®ãŸã‚è§£æãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º');
          }
        } else if (analysisStatus === 'failed') {
          // å¤±æ•—æ™‚ã¯2ã¤ç›®ã®ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’éè¡¨ç¤ºã«ã—ã¦ã€å¤±æ•—å°‚ç”¨ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’è¡¨ç¤º
          if (timeline2) {
            timeline2.classList.add('hidden');
            timeline2.style.display = 'none';
          }

          // 2ã¤ç›®ã®ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ï¼ˆè§£æå¤±æ•—ï¼‰ã‚’è¡¨ç¤º
          const timeline2Error = document.getElementById('timeline-item-2-error');
          if (timeline2Error) {
            timeline2Error.classList.remove('hidden');
            timeline2Error.style.display = 'block';
          }
          if (analysisButton) {
            analysisButton.classList.add('hidden');
            console.log('ãƒ‡ãƒãƒƒã‚°: è§£æå¤±æ•—ã®ãŸã‚è§£æãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º');
          }
        }
      } else if (analysisStatus === 'uploaded' || analysisStatus === '' || analysisStatus.trim() === '') {
        console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†ã®ã¿ã®ãŸã‚ã€è§£æã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã¯è¡¨ç¤ºã—ã¾ã›ã‚“');
        console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: analysisStatus =', analysisStatus);

        // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†æ™‚ã¯è§£æã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’ç¢ºå®Ÿã«éè¡¨ç¤ºã«ã™ã‚‹
        const timeline2 = document.getElementById('timeline-item-2');
        const timeline2Error = document.getElementById('timeline-item-2-error');
        const timeline3 = document.getElementById('timeline-item-3');

        if (timeline2) {
          timeline2.classList.add('hidden');
          timeline2.style.display = 'none';
          console.log('ãƒ‡ãƒãƒƒã‚°: è§£æé–‹å§‹ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’éè¡¨ç¤º');
        }
        if (timeline2Error) {
          timeline2Error.classList.add('hidden');
          timeline2Error.style.display = 'none';
          console.log('ãƒ‡ãƒãƒƒã‚°: è§£æå¤±æ•—ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’éè¡¨ç¤º');
        }
        if (timeline3) {
          timeline3.classList.add('hidden');
          timeline3.style.display = 'none';
          console.log('ãƒ‡ãƒãƒƒã‚°: è§£æå®Œäº†ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’éè¡¨ç¤º');
        }
      } else {
        console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: ä¸æ˜ãªçŠ¶æ…‹ã®ãŸã‚ã€è§£æã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã¯è¡¨ç¤ºã—ã¾ã›ã‚“');
        console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: analysisStatus =', analysisStatus);

        // ä¸æ˜ãªçŠ¶æ…‹ã§ã‚‚è§£æã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹
        const timeline2 = document.getElementById('timeline-item-2');
        const timeline2Error = document.getElementById('timeline-item-2-error');
        const timeline3 = document.getElementById('timeline-item-3');

        if (timeline2) {
          timeline2.classList.add('hidden');
          timeline2.style.display = 'none';
        }
        if (timeline2Error) {
          timeline2Error.classList.add('hidden');
          timeline2Error.style.display = 'none';
        }
        if (timeline3) {
          timeline3.classList.add('hidden');
          timeline3.style.display = 'none';
        }
      }

      console.log('è§£æçŠ¶æ…‹ã‚’å¾©å…ƒã—ã¾ã—ãŸ:', analysisStatus);
    }
  } else {
    console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ç”»åƒãŒãªã„å ´åˆã®å‡¦ç†');
    // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ç”»åƒãŒãªã„å ´åˆã¯ã€ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã—ã€è§£æãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹
    const analysisButton = document.getElementById('analysis-button-container');
    const uploadButtonContainer = document.getElementById('upload-button-container');

    console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: ãƒœã‚¿ãƒ³è¦ç´ ã®å–å¾—çµæœï¼ˆç”»åƒãªã—ï¼‰:');
    console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: analysisButton:', analysisButton);
    console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: uploadButtonContainer:', uploadButtonContainer);

    if(analysisButton) {
      analysisButton.classList.add('hidden');
      console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ç”»åƒãŒãªã„ãŸã‚è§£æãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã«ã—ã¾ã—ãŸ');
    } else {
      console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: è§£æãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    }

    if(uploadButtonContainer) {
      uploadButtonContainer.classList.remove('hidden');
      console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ç”»åƒãŒãªã„ãŸã‚ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ');
    } else {
      console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    }
  }

  // çŠ¶æ…‹å¾©å…ƒå®Œäº†
  window.isRestoringState = false;
  console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: çŠ¶æ…‹å¾©å…ƒå®Œäº†');
  console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: æœ€çµ‚çš„ãªUIçŠ¶æ…‹:');
  console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: - ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ:', document.getElementById('timeline-container')?.style.display);
  console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: - è§£æãƒœã‚¿ãƒ³:', document.getElementById('analysis-button-container')?.style.display);
  console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: - ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³:', document.getElementById('upload-button-container')?.style.display);
  console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: - uploadSuccessShown:', window.uploadSuccessShown);
  console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: - isRestoringState:', window.isRestoringState);

  // åˆæœŸåŒ–æ™‚ã«è§£æã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’ç¢ºå®Ÿã«éè¡¨ç¤ºã«ã™ã‚‹
  console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: åˆæœŸåŒ–æ™‚ã®è§£æã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³éè¡¨ç¤ºå‡¦ç†é–‹å§‹');
  const timeline2 = document.getElementById('timeline-item-2');
  const timeline2Error = document.getElementById('timeline-item-2-error');
  const timeline3 = document.getElementById('timeline-item-3');

  console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: è§£æã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¦ç´ ã®å–å¾—çµæœ:');
  console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: timeline2:', timeline2);
  console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: timeline2Error:', timeline2Error);
  console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: timeline3:', timeline3);

  if (timeline2) {
    timeline2.classList.add('hidden');
    timeline2.style.display = 'none';
    console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: åˆæœŸåŒ–æ™‚ã«è§£æé–‹å§‹ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’éè¡¨ç¤ºã«ã—ã¾ã—ãŸ');
  } else {
    console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: è§£æé–‹å§‹ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
  }

  if (timeline2Error) {
    timeline2Error.classList.add('hidden');
    timeline2Error.style.display = 'none';
    console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: åˆæœŸåŒ–æ™‚ã«è§£æå¤±æ•—ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’éè¡¨ç¤ºã«ã—ã¾ã—ãŸ');
  } else {
    console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: è§£æå¤±æ•—ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
  }

  if (timeline3) {
    timeline3.classList.add('hidden');
    timeline3.style.display = 'none';
    console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: åˆæœŸåŒ–æ™‚ã«è§£æå®Œäº†ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’éè¡¨ç¤ºã«ã—ã¾ã—ãŸ');
  } else {
    console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: è§£æå®Œäº†ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
  }

  // è§£æå®Œäº†å¤±æ•—ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚‚éè¡¨ç¤ºã«ã™ã‚‹
  const timeline3Error = document.getElementById('timeline-item-3-error');
  if (timeline3Error) {
    timeline3Error.classList.add('hidden');
    timeline3Error.style.display = 'none';
    console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: åˆæœŸåŒ–æ™‚ã«è§£æå®Œäº†å¤±æ•—ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’éè¡¨ç¤ºã«ã—ã¾ã—ãŸ');
  } else {
    console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: è§£æå®Œäº†å¤±æ•—ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
  }

  console.log('ğŸ”„ ãƒ‡ãƒãƒƒã‚°: åˆæœŸåŒ–æ™‚ã®è§£æã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³éè¡¨ç¤ºå‡¦ç†å®Œäº†');
  });

  // åˆå›è§£ææ©Ÿèƒ½
  function startAnalysis(modelName) {
    console.log('åˆå›è§£æé–‹å§‹:', modelName);

    // åˆå›è§£æãƒ•ãƒ©ã‚°ã‚’è¨­å®š
    window.isRetryAnalysis = false;

    // 2ã¤ç›®ã®ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ï¼ˆè§£æé–‹å§‹ï¼‰ã‚’è¡¨ç¤º
    const timeline2 = document.getElementById('timeline-item-2');
    if (timeline2) {
      timeline2.classList.remove('hidden');
      timeline2.style.display = 'block';
      console.log('2ã¤ç›®ã®ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ï¼ˆè§£æé–‹å§‹ï¼‰ã‚’è¡¨ç¤º');

      // é€²æ—ãƒãƒ¼ã‚’ç”Ÿæˆ
      generateAnalysisProgressBar();
    }

    // è§£æãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
    const analysisButton = document.getElementById('start-analysis-btn');
    if (analysisButton) {
      analysisButton.disabled = true;
      analysisButton.innerHTML = '<span class="icon-[tabler--loader-2] size-5 mr-2 animate-spin"></span>è§£æä¸­...';
    }

    // è§£æAPIã‚’å‘¼ã³å‡ºã—
    fetch('/api/analysis/start/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken()
      },
      body: JSON.stringify({
        model_name: modelName
      })
    })
      .then(response => response.json())
      .then(data => {
        console.log('è§£æAPIå¿œç­”:', data);
        if (data.success) {
          // è§£æé–‹å§‹æˆåŠŸ - é€²æ—ç›£è¦–ã‚’é–‹å§‹
          console.log('è§£æãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸã€‚é€²æ—ã‚’ç›£è¦–ã—ã¾ã™ã€‚');
          startAnalysisProgressMonitoring();
        } else {
          alert('è§£æã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
          // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
          if (analysisButton) {
            analysisButton.disabled = false;
            analysisButton.innerHTML = '<span class="icon-[tabler--brain] size-5 mr-2"></span>ãƒ¢ãƒ‡ãƒ«ã‚’é¸æŠ';
          }
        }
      })
      .catch(error => {
        console.error('è§£æé–‹å§‹APIå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼:', error);
        alert('è§£æã®é–‹å§‹ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
        // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
        if (analysisButton) {
          analysisButton.disabled = false;
          analysisButton.innerHTML = '<span class="icon-[tabler--brain] size-5 mr-2"></span>ãƒ¢ãƒ‡ãƒ«ã‚’é¸æŠ';
        }
      });
  }


  // ç¾åœ¨ã®ç”»åƒIDã‚’å–å¾—
  function getCurrentImageId() {
    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰å–å¾—ã—ãŸç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
    if (uploadedImages && uploadedImages.length > 0) {
      return uploadedImages[0].id; // æœ€åˆã®ç”»åƒã®IDã‚’è¿”ã™
    }
    return null;
  }


  // åˆå›è§£æé€²æ—ãƒãƒ¼ç”Ÿæˆ
  function generateAnalysisProgressBar() {
    const container = document.getElementById('analysis-progress-previews');
    if (!container) return;

    container.innerHTML = `
      <div class="rounded-box bg-base-100 shadow-base-300/20 p-3 shadow-lg">
        <div class="mb-1 flex items-center justify-between">
          <div class="flex items-center gap-x-3">
            <span class="text-base-content/80 border-base-content/20 flex size-8 items-center justify-center rounded-lg border p-0.5">
              <span class="icon-[tabler--photo] text-base-content/70 size-5"></span>
            </span>
            <div>
              <p class="text-base-content text-sm font-medium">è§£æä¸­...</p>
              <p class="text-base-content/50 text-xs">AIã«ã‚ˆã‚‹ç”»åƒè§£æã‚’å®Ÿè¡Œä¸­ã§ã™</p>
            </div>
          </div>
        </div>
        <div class="flex items-center gap-x-3 whitespace-nowrap">
          <div class="progress h-2" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
            <div class="progress-bar progress-primary transition-all duration-500" style="width:0%"></div>
          </div>
          <span class="text-base-content mb-0.5 text-sm">0%</span>
        </div>
      </div>
    `;
  }

  // åˆå›è§£æé€²æ—ç›£è¦–
  function startAnalysisProgressMonitoring() {
    const progressBar = document.querySelector('#analysis-progress-previews .progress-bar');
    const progressValue = document.querySelector('#analysis-progress-previews .text-sm');

    if (!progressBar || !progressValue) return;

    let progress = 0;
    const interval = setInterval(() => {
      progress += Math.random() * 10;
      if (progress > 100) progress = 100;

      progressBar.style.width = `${progress}%`;
      progressValue.textContent = `${Math.round(progress)}%`;

      if (progress >= 100) {
        clearInterval(interval);
        // è§£æå®Œäº†ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’è¡¨ç¤º
        showAnalysisCompletedTimeline();
      }
    }, 500);
  }

  // åˆå›è§£æå®Œäº†ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¡¨ç¤º
  function showAnalysisCompletedTimeline() {
    const timeline3 = document.getElementById('timeline-item-3');
    if (timeline3) {
      timeline3.classList.remove('hidden');
      timeline3.style.display = 'block';
      console.log('3ã¤ç›®ã®ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ï¼ˆè§£æå®Œäº†ï¼‰ã‚’è¡¨ç¤º');
    }
  }


  // CSRFãƒˆãƒ¼ã‚¯ãƒ³å–å¾—
  function getCSRFToken() {
    const token = document.querySelector('[name=csrfmiddlewaretoken]');
    return token ? token.value : '';
  }

  // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®è§£æé–‹å§‹ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
  const modalStartButton = document.getElementById('modal-start-analysis-btn');
  if (modalStartButton) {
    modalStartButton.addEventListener('click', function () {
      const selector = document.getElementById('model-selector');
      const model = selector ? selector.value : '';
      if (!model) {
        alert('ãƒ¢ãƒ‡ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      // åˆå›è§£æã‚’å®Ÿè¡Œ
      window.isRetryAnalysis = false;
      startAnalysis(model);
    });
  }


</script>
{% endblock %}

{% block extra_css %}
<style>
  /* ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã®è¡¨ç¤ºã‚’æœ‰åŠ¹åŒ– */
  #timeline-container .timeline-middle {
    display: flex !important;
  }

  /* ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ */
  #timeline-container .timeline-end {
    margin-left: 1rem !important;
  }
</style>
{% endblock %}