{% extends 'base.html' %}
{% load static %}

{% block title %}Test Page{% endblock %}

{% block content %}
<div class="pt-16 py-8 sm:py-16 lg:py-24">
  <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
    <div class="mb-12 space-y-4 text-center sm:mb-16 lg:mb-24">
      <h2 class="text-base-content text-2xl font-semibold md:text-3xl lg:text-4xl">
        <span class="relative z-1 font-bold">
          アップロードされた
          <span class="from-primary absolute start-0 bottom-1 -z-1 h-0.5 w-full bg-gradient-to-r to-transparent to-80%"
            aria-hidden="true"></span>
        </span>
        画像ギャラリー
      </h2>
      <p class="text-base-content/80 text-xl">
        アップロードした画像の一覧を表示します。解析状況や結果を確認できます。
      </p>
      <div class="group flex items-center justify-center gap-2 pt-4 pb-4"
        style="padding-top: 16px !important; padding-bottom: 16px !important;">
        <a href="{% url 'image_upload' %}" class="link link-animated link-primary font-normal">画像解析へ</a>
        <span
          class="icon-[tabler--chevron-right] text-primary size-5 shrink-0 transition-transform group-hover:translate-x-1 rtl:rotate-180"></span>
      </div>
    </div>

    <!-- デバッグ情報 -->
    <div class="mb-4 p-4 bg-yellow-100 rounded">
      <p><strong>デバッグ情報:</strong></p>
      <p>has_data: {{ has_data }}</p>
      <p>images.count: {{ images.count }}</p>
      <p>images|length: {{ images|length }}</p>
      {% for image in images|slice:":2" %}
      <p>Image {{ forloop.counter }}: {{ image.filename }} - URL: {{ image.thumbnail_url }}</p>
      {% endfor %}
    </div>

    <!-- 画像ギャラリー -->
    {% if has_data %}
    <div class="grid gap-6 md:grid-cols-2">
      {% for image in images|slice:":8" %}
      {% if forloop.first %}
      <!-- 最初の画像（大きいサイズ） -->
      <div>
        <div class="image-placeholder rounded-box aspect-5/4 min-h-121.75 object-cover"
          data-src="{{ image.thumbnail_url }}">
          <div class="skeleton h-full w-full animate-pulse"></div>
        </div>
      </div>
      {% elif forloop.counter == 2 %}
      <!-- 2番目から5番目の画像（2x2グリッド） -->
      <div class="grid grid-cols-2 gap-6">
        <div class="image-placeholder rounded-box aspect-5/4 min-h-57.75 object-cover"
          data-src="{{ image.thumbnail_url }}">
          <div class="skeleton h-full w-full animate-pulse"></div>
        </div>
        {% elif forloop.counter == 3 %}
        <div class="image-placeholder rounded-box aspect-5/4 min-h-57.75 object-cover"
          data-src="{{ image.thumbnail_url }}">
          <div class="skeleton h-full w-full animate-pulse"></div>
        </div>
        {% elif forloop.counter == 4 %}
        <div class="image-placeholder rounded-box aspect-5/4 min-h-57.75 object-cover"
          data-src="{{ image.thumbnail_url }}">
          <div class="skeleton h-full w-full animate-pulse"></div>
        </div>
        {% elif forloop.counter == 5 %}
        <div class="image-placeholder rounded-box aspect-5/4 min-h-57.75 object-cover"
          data-src="{{ image.thumbnail_url }}">
          <div class="skeleton h-full w-full animate-pulse"></div>
        </div>
      </div>
      {% elif forloop.counter == 6 %}
      <!-- 6番目から9番目の画像（2x2グリッド） -->
      <div class="grid grid-cols-2 gap-6">
        <div class="image-placeholder rounded-box aspect-5/4 min-h-57.75 object-cover"
          data-src="{{ image.thumbnail_url }}">
          <div class="skeleton h-full w-full animate-pulse"></div>
        </div>
        {% elif forloop.counter == 7 %}
        <div class="image-placeholder rounded-box aspect-5/4 min-h-57.75 object-cover"
          data-src="{{ image.thumbnail_url }}">
          <div class="skeleton h-full w-full animate-pulse"></div>
        </div>
        {% elif forloop.counter == 8 %}
        <div class="image-placeholder rounded-box aspect-5/4 min-h-57.75 object-cover"
          data-src="{{ image.thumbnail_url }}">
          <div class="skeleton h-full w-full animate-pulse"></div>
        </div>
      </div>
      {% endif %}
      {% endfor %}

      <!-- 最後の画像（大きいサイズ） -->
      {% if images|length > 8 %}
      <div>
        <div class="image-placeholder rounded-box aspect-5/4 min-h-121.75 object-cover"
          data-src="{{ images.8.thumbnail_url }}">
          <div class="skeleton h-full w-full animate-pulse"></div>
        </div>
      </div>
      {% endif %}
    </div>
    {% else %}
    <!-- データがない場合の表示 -->
    <div class="text-center py-12">
      <div class="text-base-content/50 text-lg mb-4">
        <span class="icon-[tabler--photo-off] size-16 mx-auto block mb-4"></span>
        画像がアップロードされていません
      </div>
      <p class="text-base-content/60">
        画像をアップロードして解析を開始してください。
      </p>
    </div>
    {% endif %}
  </div>
</div>

<!-- テーブルセクション -->
<div class="container mx-auto px-4 py-8">
  <div class="bg-base-100 rounded-xl shadow-sm p-6">
    <!-- Filter Bar -->
    <div class="flex flex-col flex-wrap gap-4 sm:flex-row sm:items-center sm:justify-between mb-6">
      <!-- Left side: Search -->
      <div class="select-floating w-80">
        <input class="input" list="datalistOptions" id="exampleDataList" placeholder="Type to search..." />
        <label class="select-floating-label" for="selectFloating">Search</label>
      </div>
      <!-- Right side: Date Sort and Status Filter -->
      <div class="flex flex-col sm:flex-row gap-4">
        <div class="select-floating w-40">
          <select class="select" aria-label="Date sort" id="dateSort">
            <option>新しい順</option>
            <option>古い順</option>
          </select>
          <label class="select-floating-label" for="dateSort">日順ソート</label>
        </div>

        <div class="select-floating w-40">
          <select class="select" aria-label="Select floating label" id="selectFloating">
            <option>すべて</option>
            <option>解析成功</option>
            <option>解析中</option>
            <option>準備中</option>
            <option>失敗</option>
          </select>
          <label class="select-floating-label" for="selectFloating">ステータス</label>
        </div>

        <div class="select-floating w-40">
          <select class="select" aria-label="Label filter" id="labelFilter">
            <option>すべて</option>
            <option>犬</option>
            <option>屋外</option>
            <option>公園</option>
            <option>風景</option>
            <option>人物</option>
          </select>
          <label class="select-floating-label" for="labelFilter">ラベル</label>
        </div>

        <div class="select-floating w-40">
          <select class="select" aria-label="Confidence filter" id="confidenceFilter">
            <option>すべて</option>
            <option>90%以上</option>
            <option>80-89%</option>
            <option>70-79%</option>
            <option>60-69%</option>
            <option>60%未満</option>
          </select>
          <label class="select-floating-label" for="confidenceFilter">信頼度</label>
        </div>

        <button type="button" class="btn btn-soft btn-sm btn-circle" onclick="resetAllFilters()" title="フィルターをリセット">
          <span class="icon-[tabler--refresh] size-4"></span>
        </button>
      </div>
    </div>

    <!-- Table -->
    <div class="overflow-x-auto max-w-6xl mx-auto">
      {% if has_data %}
      <table class="table w-full [&_tr:nth-child(even)]:bg-base-200">
        <thead>
          <tr>
            <th>サムネイル画像</th>
            <th>アップロード日時</th>
            <th>ステータス</th>
            <th>機械学習によってつけられたラベル</th>
            <th>信頼度</th>
          </tr>
        </thead>
        <tbody>
          {% for image in images %}
          <tr>
            <td>
              <div class="flex items-center gap-3">
                <div class="avatar cursor-pointer" data-overlay="#slide-down-animated-modal">
                  <div class="bg-base-content/10 h-10 w-10 rounded-md">
                    <div class="image-placeholder-small" data-src="{{ image.thumbnail_url }}">
                      <div class="skeleton h-full w-full animate-pulse"></div>
                    </div>
                  </div>
                </div>
                <div>
                  <div class="text-sm opacity-50">画像ファイル</div>
                  <div class="font-medium">{{ image.filename }}</div>
                </div>
              </div>
            </td>
            <td>{{ image.upload_date|date:"Y-m-d H:i" }}</td>
            <td>
              {% if image.status == 'success' %}
              <span class="badge badge-outline border-dashed badge-success me-2">解析成功</span>
              {% elif image.status == 'analyzing' %}
              <span class="badge badge-outline border-dashed badge-info me-2">解析中</span>
              {% elif image.status == 'preparing' %}
              <span class="badge badge-outline border-dashed badge-secondary me-2">準備中</span>
              {% elif image.status == 'failed' %}
              <span class="badge badge-outline border-dashed badge-error me-2">失敗</span>
              {% endif %}
            </td>
            <td>
              {% if image.analysis_results_list %}
              {% for result in image.analysis_results_list %}
              <span class="badge badge-{% cycle 'error' 'secondary' 'success' %} me-1">{{ result.label }}</span>
              {% endfor %}
              {% else %}
              <span class="text-sm text-gray-500">-</span>
              {% endif %}
            </td>
            <td>
              {% if image.analysis_results_list %}
              {% with first_result=image.analysis_results_list.first %}
              <span class="badge badge-success">{{ first_result.confidence }}%</span>
              {% endwith %}
              {% else %}
              <span class="badge badge-secondary">-</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <!-- データがない場合の表示 -->
      <div class="text-center py-12">
        <div class="text-base-content/50 text-lg mb-4">
          <span class="icon-[tabler--table-off] size-16 mx-auto block mb-4"></span>
          データがありません
        </div>
        <p class="text-base-content/60">
          画像をアップロードすると、ここに解析結果が表示されます。
        </p>
      </div>
      {% endif %}
    </div>

    <!-- 他の行は省略 -->
  </div>

  <!-- Pagination -->
  {% if has_data %}
  <div class="flex flex-wrap items-center justify-between gap-2 py-4">
    <div class="text-sm text-base-content/80">
      Showing <span class="font-semibold">1-{{ images.count }}</span> of <span class="font-semibold">{{ images.count
        }}</span> images
    </div>
    <nav class="join">
      <button class="btn btn-soft btn-square join-item"><span
          class="icon-[tabler--chevron-left] size-5"></span></button>
      <button class="btn btn-soft join-item btn-square" aria-current="page">1</button>
      <button class="btn btn-soft btn-square join-item"><span
          class="icon-[tabler--chevron-right] size-5"></span></button>
    </nav>
  </div>
  {% endif %}
</div>

<!-- Error Log Modal -->
<div id="slide-down-animated-modal" class="overlay modal overlay-open:opacity-100 overlay-open:duration-300 hidden"
  role="dialog" tabindex="-1">
  <div class="modal-dialog overlay-open:mt-12 overlay-open:duration-300 transition-all ease-out">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">画像詳細</h3>
        <button type="button" class="btn btn-text btn-circle btn-sm absolute end-3 top-3" aria-label="Close"
          data-overlay="#slide-down-animated-modal">
          <span class="icon-[tabler--x] size-4"></span>
        </button>
      </div>
      <div class="modal-body">
        <div class="flex flex-col gap-4">
          <!-- Image -->
          <div class="flex justify-center">
            <div class="image-placeholder-modal rounded-lg shadow-lg" data-src="">
              <div class="skeleton h-full w-full animate-pulse"></div>
            </div>
          </div>

          <!-- Image Details -->
          <div class="grid grid-cols-1 gap-3">
            <div class="flex justify-between items-center">
              <span class="font-semibold">ファイル名:</span>
              <span class="text-sm text-gray-600">sample_image_001.jpg</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="font-semibold">アップロード日時:</span>
              <span class="text-sm text-gray-600">2024-01-15 10:30</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="font-semibold">ステータス:</span>
              <span class="badge badge-outline border-dashed badge-success me-2">解析成功</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="font-semibold">機械学習によってつけられたラベル:</span>
              <div class="flex gap-2">
                <span class="badge badge-primary">犬</span>
                <span class="badge badge-secondary">屋外</span>
                <span class="badge badge-success">公園</span>
              </div>
            </div>
            <div class="flex justify-between items-center">
              <span class="font-semibold">信頼度:</span>
              <span class="badge badge-soft badge-success">95%</span>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-soft btn-secondary" data-overlay="#slide-down-animated-modal">
          閉じる
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Image Detail Modal (Temporary test with same content as preview) -->
<div id="image-detail-modal" class="overlay modal overlay-open:opacity-100 overlay-open:duration-300 hidden"
  role="dialog" tabindex="-1">
  <div
    class="overlay-animation-target modal-dialog overlay-open:mt-4 overlay-open:duration-300 mt-12 transition-all ease-out">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Dialog Title</h3>
        <button type="button" class="btn btn-text btn-circle btn-sm absolute end-3 top-3" aria-label="Close"
          data-overlay="#image-detail-modal" id="modal-close-x">
          <span class="icon-[tabler--x] size-4"></span>
        </button>
      </div>
      <div class="modal-body">
        <div class="flex flex-col gap-4">
          <!-- Image -->
          <div class="flex justify-center">
            <div class="image-placeholder-modal rounded-lg shadow-lg" data-src="">
              <div class="skeleton h-full w-full animate-pulse"></div>
            </div>
          </div>

          <!-- Image Details -->
          <div class="grid grid-cols-1 gap-3">
            <div class="flex justify-between items-center">
              <span class="font-semibold">ファイル名:</span>
              <span id="modal-filename" class="text-sm text-gray-600"></span>
            </div>
            <div class="flex justify-between items-center">
              <span class="font-semibold">アップロード日時:</span>
              <span id="modal-upload-time" class="text-sm text-gray-600"></span>
            </div>
            <div class="flex justify-between items-center">
              <span class="font-semibold">ステータス:</span>
              <span id="modal-status-badge" class="badge badge-outline border-dashed me-2"></span>
            </div>
            <div class="flex justify-between items-center">
              <span class="font-semibold">ラベル:</span>
              <div id="modal-labels" class="flex flex-wrap gap-1"></div>
            </div>
            <div class="flex justify-between items-center">
              <span class="font-semibold">信頼度:</span>
              <span id="modal-confidence" class="badge"></span>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-soft btn-secondary" data-overlay="#image-detail-modal"
          id="modal-close-button">
          閉じる
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/image_gallery.js' %}"></script>
{% endblock %}

{% block extra_css %}
<style>
  .table tbody tr:nth-child(even) {
    background-color: #f3f4f6;
  }

  /* 画像プレースホルダーのスタイル */
  .image-placeholder {
    background: linear-gradient(135deg, #f3f4f6 25%, transparent 25%),
      linear-gradient(225deg, #f3f4f6 25%, transparent 25%),
      linear-gradient(45deg, #f3f4f6 25%, transparent 25%),
      linear-gradient(315deg, #f3f4f6 25%, transparent 25%);
    background-position: 10px 0, 10px 0, 0 0, 0 0;
    background-size: 20px 20px;
    background-repeat: repeat;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #6b7280;
    border: 2px dashed #d1d5db;
    position: relative;
  }

  /* 画像が読み込まれた時のスタイル */
  .image-placeholder[style*="background-image"],
  .image-placeholder.image-loaded {
    background-size: cover !important;
    background-position: center !important;
    background-repeat: no-repeat !important;
  }

  .image-placeholder[style*="background-image"] .skeleton,
  .image-placeholder.image-loaded .skeleton {
    display: none !important;
  }

  .image-placeholder-small {
    background: linear-gradient(135deg, #f3f4f6 25%, transparent 25%),
      linear-gradient(225deg, #f3f4f6 25%, transparent 25%),
      linear-gradient(45deg, #f3f4f6 25%, transparent 25%),
      linear-gradient(315deg, #f3f4f6 25%, transparent 25%);
    background-position: 5px 0, 5px 0, 0 0, 0 0;
    background-size: 10px 10px;
    background-repeat: repeat;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #6b7280;
    border: 1px dashed #d1d5db;
    width: 100%;
    height: 100%;
    position: relative;
  }

  /* 小さいプレースホルダーが画像読み込み済みの時のスタイル */
  .image-placeholder-small[style*="background-image"],
  .image-placeholder-small.image-loaded {
    background-size: cover !important;
    background-position: center !important;
    background-repeat: no-repeat !important;
  }

  .image-placeholder-small[style*="background-image"] .skeleton,
  .image-placeholder-small.image-loaded .skeleton {
    display: none !important;
  }

  .image-placeholder-modal {
    background: linear-gradient(135deg, #f3f4f6 25%, transparent 25%),
      linear-gradient(225deg, #f3f4f6 25%, transparent 25%),
      linear-gradient(45deg, #f3f4f6 25%, transparent 25%),
      linear-gradient(315deg, #f3f4f6 25%, transparent 25%);
    background-position: 10px 0, 10px 0, 0 0, 0 0;
    background-size: 20px 20px;
    background-repeat: repeat;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #6b7280;
    border: 2px dashed #d1d5db;
    min-height: 300px;
    width: 100%;
    max-width: 400px;
  }

  .placeholder-content {
    text-align: center;
  }

  .placeholder-content-small {
    text-align: center;
  }

  .placeholder-content-modal {
    text-align: center;
  }
</style>
{% endblock %}