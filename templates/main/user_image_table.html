{% extends 'base.html' %}
{% load static %}

{% block title %}Test Page{% endblock %}

{% block content %}
{% csrf_token %}
<div class="pt-16 py-8 sm:py-16 lg:py-24">
  <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
    <div class="mb-12 space-y-4 text-center sm:mb-16 lg:mb-24">
      <h2 class="text-base-content text-2xl font-semibold md:text-3xl lg:text-4xl">
        <span class="relative z-1 font-bold">
          アップロードされた
          <span class="from-primary absolute start-0 bottom-1 -z-1 h-0.5 w-full bg-gradient-to-r to-transparent to-80%"
            aria-hidden="true"></span>
        </span>
        画像ギャラリー
      </h2>
      <p class="text-base-content/80 text-xl">
        アップロードした画像の一覧を表示します。解析状況や結果を確認できます。
      </p>
      <div class="group flex items-center justify-center gap-2 pt-4 pb-4"
        style="padding-top: 16px !important; padding-bottom: 16px !important;">
        <a href="{% url 'v2_image_upload' %}" class="link link-animated link-primary font-normal">画像解析へ</a>
        <span
          class="icon-[tabler--chevron-right] text-primary size-5 shrink-0 transition-transform group-hover:translate-x-1 rtl:rotate-180"></span>
      </div>
    </div>
    <!-- 画像ギャラリー -->
    {% if has_data %}
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
      <div class="grid gap-6 md:grid-cols-2">
        <!-- 最初の画像（大きいサイズ） -->
        {% if images.0 %}
        <div>
          <img src="{{ images.0.thumbnail_url }}" alt="{{ images.0.filename }}"
            class="rounded-box aspect-5/4 min-h-121.75 object-cover" />
        </div>
        {% endif %}

        <!-- 2番目から5番目の画像（2x2グリッド） -->
        <div class="grid grid-cols-2 gap-6">
          {% if images.1 %}
          <img src="{{ images.1.thumbnail_url }}" alt="{{ images.1.filename }}"
            class="rounded-box aspect-5/4 min-h-57.75 object-cover" />
          {% endif %}
          {% if images.2 %}
          <img src="{{ images.2.thumbnail_url }}" alt="{{ images.2.filename }}"
            class="rounded-box aspect-5/4 min-h-57.75 object-cover" />
          {% endif %}
          {% if images.3 %}
          <img src="{{ images.3.thumbnail_url }}" alt="{{ images.3.filename }}"
            class="rounded-box aspect-5/4 min-h-57.75 object-cover" />
          {% endif %}
          {% if images.4 %}
          <img src="{{ images.4.thumbnail_url }}" alt="{{ images.4.filename }}"
            class="rounded-box aspect-5/4 min-h-57.75 object-cover" />
          {% endif %}
        </div>

        <!-- 6番目から9番目の画像（2x2グリッド） -->
        <div class="grid grid-cols-2 gap-6">
          {% if images.5 %}
          <img src="{{ images.5.thumbnail_url }}" alt="{{ images.5.filename }}"
            class="rounded-box aspect-5/4 min-h-57.75 object-cover" />
          {% endif %}
          {% if images.6 %}
          <img src="{{ images.6.thumbnail_url }}" alt="{{ images.6.filename }}"
            class="rounded-box aspect-5/4 min-h-57.75 object-cover" />
          {% endif %}
          {% if images.7 %}
          <img src="{{ images.7.thumbnail_url }}" alt="{{ images.7.filename }}"
            class="rounded-box aspect-5/4 min-h-57.75 object-cover" />
          {% endif %}
          {% if images.8 %}
          <img src="{{ images.8.thumbnail_url }}" alt="{{ images.8.filename }}"
            class="rounded-box aspect-5/4 min-h-57.75 object-cover" />
          {% endif %}
        </div>

        <!-- 最後の画像（大きいサイズ） -->
        {% if images.9 %}
        <div>
          <img src="{{ images.9.thumbnail_url }}" alt="{{ images.9.filename }}"
            class="rounded-box aspect-5/4 min-h-121.75 object-cover" />
        </div>
        {% endif %}
      </div>
    </div>
    {% else %}
    <!-- データがない場合の表示 -->
    <div class="text-center py-12">
      <div class="text-base-content/50 text-lg mb-4">
        <span class="icon-[tabler--photo-off] size-16 mx-auto block mb-4"></span>
        画像がアップロードされていません
      </div>
      <p class="text-base-content/60">
        画像をアップロードして解析を開始してください。
      </p>
    </div>
    {% endif %}
  </div>
</div>

<!-- テーブルセクション -->
<div class="container mx-auto px-4 py-8">
  <div class="bg-base-100 rounded-xl shadow-sm p-6">
    <!-- Filter Bar -->
    <div class="flex flex-col flex-wrap gap-4 sm:flex-row sm:items-center sm:justify-between mb-6">
      <!-- Left side: Search -->
      <div class="select-floating w-80">
        <input class="input" list="datalistOptions" id="exampleDataList" placeholder="ファイル名で検索..." />
        <label class="select-floating-label" for="selectFloating">検索</label>
      </div>
      <!-- Right side: Date Sort and Status Filter -->
      <div class="flex flex-col sm:flex-row gap-4">
        <div class="select-floating w-40">
          <select class="select" aria-label="Date sort" id="dateSort">
            <option>新しい順</option>
            <option>古い順</option>
          </select>
          <label class="select-floating-label" for="dateSort">日順ソート</label>
        </div>

        <div class="select-floating w-40">
          <select class="select" aria-label="Select floating label" id="selectFloating">
            <option>すべて</option>
            <option>アップロード</option>
            <option>解析成功</option>
            <option>解析中</option>
            <option>準備中</option>
            <option>失敗</option>
          </select>
          <label class="select-floating-label" for="selectFloating">ステータス</label>
        </div>

        <div class="select-floating w-40">
          <select class="select" aria-label="Label filter" id="labelFilter">
            <option>すべて</option>
            <option>人物</option>
            <option>アニメ・イラスト</option>
            <option>動物</option>
            <option>テクノロジー</option>
            <option>ファッション</option>
            <option>食べ物</option>
            <option>建物</option>
            <option>乗り物</option>
            <option>自然</option>
            <option>スポーツ</option>
          </select>
          <label class="select-floating-label" for="labelFilter">ラベル</label>
        </div>

        <div class="select-floating w-40">
          <select class="select" aria-label="Confidence filter" id="confidenceFilter">
            <option>すべて</option>
            <option>90%以上</option>
            <option>80-89%</option>
            <option>70-79%</option>
            <option>60-69%</option>
            <option>60%未満</option>
          </select>
          <label class="select-floating-label" for="confidenceFilter">信頼度</label>
        </div>

        <button type="button" class="btn btn-soft btn-sm btn-circle" onclick="resetAllFilters()" title="フィルターをリセット">
          <span class="icon-[tabler--refresh] size-4"></span>
        </button>
      </div>
    </div>

    <!-- Table -->
    <div class="overflow-x-auto max-w-6xl mx-auto">
      {% if has_data %}
      <table class="table w-full [&_tr:nth-child(even)]:bg-base-200">
        <thead>
          <tr>
            <th>サムネイル画像</th>
            <th>アップロード日時</th>
            <th>ステータス</th>
            <th>機械学習によってつけられたラベル</th>
            <th>信頼度</th>
          </tr>
        </thead>
        <tbody>
          {% for image in images %}
          <tr data-image-id="{{ image.image_id }}">
            <td>
              <div class="flex items-center gap-3">
                <div class="avatar cursor-pointer" data-overlay="#slide-down-animated-modal">
                  <div class="bg-base-content/10 h-10 w-10 rounded-md">
                    <img src="{{ image.thumbnail_url }}" alt="{{ image.filename }}"
                      class="h-full w-full object-cover rounded-md" />
                  </div>
                </div>
                <div>
                  <div class="text-sm opacity-50">画像ファイル</div>
                  <div class="font-medium">{{ image.filename }}</div>
                </div>
              </div>
            </td>
            <td>
              {% if image.created_at %}
              {{ image.created_at|date:"Y-m-d H:i" }}
              {% else %}
              日時データなし
              {% endif %}
            </td>
            <td>
              {% if image.status == 'completed' %}
              <span class="badge badge-outline border-dashed badge-success me-2">解析成功</span>
              {% elif image.status == 'analyzing' %}
              <span class="badge badge-outline border-dashed badge-info me-2">解析中</span>
              {% elif image.status == 'upload' %}
              <span class="badge badge-outline border-dashed badge-primary me-2">アップロード</span>
              {% elif image.status == 'uploaded' %}
              <span class="badge badge-outline border-dashed badge-warning me-2">アップロード完了</span>
              {% elif image.status == 'preparing' %}
              {% if image.queue_item %}
              <span class="badge badge-outline border-dashed badge-secondary me-2" title="クリックしてタイムラインを確認"
                data-overlay="#timeline-modal">
                準備中 → あと{{ image.queue_item.waiting_position }}枚
              </span>
              {% else %}
              <span class="badge badge-outline border-dashed badge-secondary me-2" title="クリックしてタイムラインを確認"
                data-overlay="#timeline-modal">準備中</span>
              {% endif %}
              {% elif image.status == 'failed' %}
              <span class="badge badge-outline border-dashed badge-error me-2">失敗</span>
              {% endif %}
            </td>
            <td class="text-center">
              {% if image.status == 'completed' %}
              {% with image.get_previous_results|first as latest_result %}
              {% if latest_result %}
              <span class="badge badge-primary">{{ latest_result.label }}</span>
              {% else %}
              <span class="text-sm text-gray-500">-</span>
              {% endif %}
              {% endwith %}
              {% else %}
              <span class="text-sm text-gray-500">-</span>
              {% endif %}
            </td>
            <td>
              {% if image.status == 'completed' %}
              {% with image.get_previous_results|first as latest_result %}
              {% if latest_result %}
              <span class="badge badge-success">{{ latest_result.confidence }}%</span>
              {% else %}
              <span class="badge badge-secondary">-</span>
              {% endif %}
              {% endwith %}
              {% else %}
              <span class="badge badge-secondary">-</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <!-- データがない場合の表示 -->
      <div class="text-center py-12">
        <div class="text-base-content/50 text-lg mb-4">
          <span class="icon-[tabler--table-off] size-16 mx-auto block mb-4"></span>
          データがありません
        </div>
        <p class="text-base-content/60">
          画像をアップロードすると、ここに解析結果が表示されます。
        </p>
      </div>
      {% endif %}
    </div>

    <!-- 他の行は省略 -->
  </div>

  <!-- Pagination -->
  {% if has_data %}
  <div class="flex flex-wrap items-center justify-between gap-2 py-4">
    <div class="text-sm text-base-content/80">
      <span class="font-semibold">{{ page_obj.start_index }}-{{ page_obj.end_index }}</span>件目 / 全
      <span class="font-semibold">{{ page_obj.paginator.count }}</span>件の画像を表示中
    </div>
    {% if page_obj.has_other_pages %}
    <nav class="join">
      {% if page_obj.has_previous %}
      <a href="?page={{ page_obj.previous_page_number }}" class="btn btn-soft btn-square join-item">
        <span class="icon-[tabler--chevron-left] size-5"></span>
      </a>
      {% else %}
      <button class="btn btn-soft btn-square join-item" disabled>
        <span class="icon-[tabler--chevron-left] size-5"></span>
      </button>
      {% endif %}

      {% for num in page_obj.paginator.page_range %}
      {% if page_obj.number == num %}
      <button class="btn btn-soft join-item btn-square" aria-current="page">{{ num }}</button>
      {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %} <a href="?page={{ num }}"
        class="btn btn-soft join-item btn-square">{{ num }}</a>
        {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}" class="btn btn-soft btn-square join-item">
          <span class="icon-[tabler--chevron-right] size-5"></span>
        </a>
        {% else %}
        <button class="btn btn-soft btn-square join-item" disabled>
          <span class="icon-[tabler--chevron-right] size-5"></span>
        </button>
        {% endif %}
    </nav>
    {% endif %}
  </div>
  {% endif %}
</div>

<!-- Error Log Modal -->
<div id="slide-down-animated-modal" class="overlay modal overlay-open:opacity-100 overlay-open:duration-300 hidden"
  role="dialog" tabindex="-1">
  <div
    class="modal-dialog fixed top-8 left-1/2 transform -translate-x-1/2 overlay-open:duration-300 transition-all ease-out">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">画像詳細</h3>
        <button type="button" class="btn btn-text btn-circle btn-sm absolute end-3 top-3" aria-label="Delete"
          onclick="openDeleteConfirmModal()">
          <span class="icon-[tabler--trash] size-4"></span>
        </button>
      </div>
      <div class="modal-body">
        <!-- 通常状態: 画像詳細表示 -->
        <div id="modal-image-detail" class="flex flex-col gap-4">
          <!-- Image -->
          <div class="flex justify-center">
            <img id="modal-image" src="" alt=""
              class="rounded-lg shadow-lg max-w-full h-auto max-h-96 object-contain" />
          </div>

          <!-- Image Details -->
          <div class="grid grid-cols-1 gap-3">
            <div class="flex justify-between items-center">
              <span class="font-semibold">ファイル名:</span>
              <span id="modal-filename" class="text-sm text-gray-600"></span>
            </div>
            <div class="flex justify-between items-center">
              <span class="font-semibold">アップロード日時:</span>
              <span id="modal-upload-time" class="text-sm text-gray-600"></span>
            </div>
            <div class="flex justify-between items-center">
              <span class="font-semibold">ステータス:</span>
              <span id="modal-status-badge" class="badge badge-outline border-dashed me-2"></span>
            </div>
            <div class="flex justify-between items-center">
              <span class="font-semibold">ラベル:</span>
              <div id="modal-labels" class="flex flex-wrap gap-1"></div>
            </div>
            <div class="flex justify-between items-center">
              <span class="font-semibold">信頼度:</span>
              <span id="modal-confidence" class="badge"></span>
            </div>
          </div>
        </div>

        <!-- 削除確認状態: 削除確認表示 -->
        <div id="modal-delete-confirm" class="flex flex-col gap-4 hidden">
          <div class="flex items-center gap-3">
            <span class="icon-[tabler--alert-triangle] size-8 text-warning"></span>
            <div>
              <h4 class="font-semibold text-lg">画像の削除</h4>
              <p class="text-sm text-gray-600 mt-1">この画像を削除しますか？</p>
              <p class="text-xs text-gray-500 mt-1">削除された画像は復元できません。解析結果も一緒に削除されます。</p>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <!-- 通常状態のボタン -->
        <div id="modal-normal-buttons" class="flex gap-2">
          <button type="button" class="btn btn-soft btn-primary" id="reanalysis-button"
            onclick="navigateToReanalysis()">
            再解析
          </button>
          <button type="button" class="btn btn-soft btn-secondary" data-overlay="#slide-down-animated-modal">
            閉じる
          </button>
        </div>

        <!-- 削除確認状態のボタン -->
        <div id="modal-delete-buttons" class="flex gap-2 hidden">
          <button type="button" class="btn btn-soft btn-secondary" onclick="cancelDeleteConfirm()">
            キャンセル
          </button>
          <button type="button" class="btn btn-error" onclick="confirmDeleteImage()">
            削除
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- モデル選択モーダル -->
<!-- タイムライン表示モーダル -->
<!-- 解析進捗モーダル -->
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/pages/image-gallery.js' %}"></script>
<script src="{% static 'js/pages/user-image-table.js' %}?v={{ timestamp|default:'1.0' }}"></script>
{% endblock %}

{% block extra_css %}
<style>
  .table tbody tr:nth-child(even) {
    background-color: #f3f4f6;
  }

  /* 準備中バッジのホバー効果 */
  .badge-secondary.cursor-pointer:hover {
    background-color: #6b7280 !important;
    color: white !important;
    transform: scale(1.05);
    transition: all 0.2s ease;
  }

  /* 画像プレースホルダーのスタイル */
  .image-placeholder {
    background: linear-gradient(135deg, #f3f4f6 25%, transparent 25%),
      linear-gradient(225deg, #f3f4f6 25%, transparent 25%),
      linear-gradient(45deg, #f3f4f6 25%, transparent 25%),
      linear-gradient(315deg, #f3f4f6 25%, transparent 25%);
    background-position: 10px 0, 10px 0, 0 0, 0 0;
    background-size: 20px 20px;
    background-repeat: repeat;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #6b7280;
    border: 2px dashed #d1d5db;
    position: relative;
  }

  /* 画像が読み込まれた時のスタイル */
  .image-placeholder[style*="background-image"],
  .image-placeholder.image-loaded {
    background-size: cover !important;
    background-position: center !important;
    background-repeat: no-repeat !important;
  }

  .image-placeholder[style*="background-image"] .skeleton,
  .image-placeholder.image-loaded .skeleton {
    display: none !important;
  }


  .image-placeholder-modal {
    background: linear-gradient(135deg, #f3f4f6 25%, transparent 25%),
      linear-gradient(225deg, #f3f4f6 25%, transparent 25%),
      linear-gradient(45deg, #f3f4f6 25%, transparent 25%),
      linear-gradient(315deg, #f3f4f6 25%, transparent 25%);
    background-position: 10px 0, 10px 0, 0 0, 0 0;
    background-size: 20px 20px;
    background-repeat: repeat;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #6b7280;
    border: 2px dashed #d1d5db;
    min-height: 300px;
    width: 100%;
    max-width: 400px;
  }

  .placeholder-content {
    text-align: center;
  }

  .placeholder-content-small {
    text-align: center;
  }

  .placeholder-content-modal {
    text-align: center;
  }
</style>
{% endblock %}