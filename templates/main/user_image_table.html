{% extends 'base.html' %}
{% load static %}

{% block title %}Test Page{% endblock %}

{% block content %}
{% csrf_token %}
<div class="pt-16 py-8 sm:py-16 lg:py-24">
  <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
    <div class="mb-12 space-y-4 text-center sm:mb-16 lg:mb-24">
      <h2 class="text-base-content text-2xl font-semibold md:text-3xl lg:text-4xl">
        <span class="relative z-1 font-bold">
          アップロードされた
          <span class="from-primary absolute start-0 bottom-1 -z-1 h-0.5 w-full bg-gradient-to-r to-transparent to-80%"
            aria-hidden="true"></span>
        </span>
        画像ギャラリー
      </h2>
      <p class="text-base-content/80 text-xl">
        アップロードした画像の一覧を表示します。解析状況や結果を確認できます。
      </p>
      <div class="group flex items-center justify-center gap-2 pt-4 pb-4"
        style="padding-top: 16px !important; padding-bottom: 16px !important;">
        <a href="{% url 'image_upload' %}" class="link link-animated link-primary font-normal">画像解析へ</a>
        <span
          class="icon-[tabler--chevron-right] text-primary size-5 shrink-0 transition-transform group-hover:translate-x-1 rtl:rotate-180"></span>
      </div>
    </div>
    <!-- 画像ギャラリー -->
    {% if has_data %}
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
      <div class="grid gap-6 md:grid-cols-2">
        <!-- 最初の画像（大きいサイズ） -->
        {% if images.0 %}
        <div>
          <img src="{{ images.0.thumbnail_url }}" alt="{{ images.0.filename }}"
            class="rounded-box aspect-5/4 min-h-121.75 object-cover" />
        </div>
        {% endif %}

        <!-- 2番目から5番目の画像（2x2グリッド） -->
        <div class="grid grid-cols-2 gap-6">
          {% if images.1 %}
          <img src="{{ images.1.thumbnail_url }}" alt="{{ images.1.filename }}"
            class="rounded-box aspect-5/4 min-h-57.75 object-cover" />
          {% endif %}
          {% if images.2 %}
          <img src="{{ images.2.thumbnail_url }}" alt="{{ images.2.filename }}"
            class="rounded-box aspect-5/4 min-h-57.75 object-cover" />
          {% endif %}
          {% if images.3 %}
          <img src="{{ images.3.thumbnail_url }}" alt="{{ images.3.filename }}"
            class="rounded-box aspect-5/4 min-h-57.75 object-cover" />
          {% endif %}
          {% if images.4 %}
          <img src="{{ images.4.thumbnail_url }}" alt="{{ images.4.filename }}"
            class="rounded-box aspect-5/4 min-h-57.75 object-cover" />
          {% endif %}
        </div>

        <!-- 6番目から9番目の画像（2x2グリッド） -->
        <div class="grid grid-cols-2 gap-6">
          {% if images.5 %}
          <img src="{{ images.5.thumbnail_url }}" alt="{{ images.5.filename }}"
            class="rounded-box aspect-5/4 min-h-57.75 object-cover" />
          {% endif %}
          {% if images.6 %}
          <img src="{{ images.6.thumbnail_url }}" alt="{{ images.6.filename }}"
            class="rounded-box aspect-5/4 min-h-57.75 object-cover" />
          {% endif %}
          {% if images.7 %}
          <img src="{{ images.7.thumbnail_url }}" alt="{{ images.7.filename }}"
            class="rounded-box aspect-5/4 min-h-57.75 object-cover" />
          {% endif %}
          {% if images.8 %}
          <img src="{{ images.8.thumbnail_url }}" alt="{{ images.8.filename }}"
            class="rounded-box aspect-5/4 min-h-57.75 object-cover" />
          {% endif %}
        </div>

        <!-- 最後の画像（大きいサイズ） -->
        {% if images.9 %}
        <div>
          <img src="{{ images.9.thumbnail_url }}" alt="{{ images.9.filename }}"
            class="rounded-box aspect-5/4 min-h-121.75 object-cover" />
        </div>
        {% endif %}
      </div>
    </div>
    {% else %}
    <!-- データがない場合の表示 -->
    <div class="text-center py-12">
      <div class="text-base-content/50 text-lg mb-4">
        <span class="icon-[tabler--photo-off] size-16 mx-auto block mb-4"></span>
        画像がアップロードされていません
      </div>
      <p class="text-base-content/60">
        画像をアップロードして解析を開始してください。
      </p>
    </div>
    {% endif %}
  </div>
</div>

<!-- テーブルセクション -->
<div class="container mx-auto px-4 py-8">
  <div class="bg-base-100 rounded-xl shadow-sm p-6">
    <!-- Filter Bar -->
    <div class="flex flex-col flex-wrap gap-4 sm:flex-row sm:items-center sm:justify-between mb-6">
      <!-- Left side: Search -->
      <div class="select-floating w-80">
        <input class="input" list="datalistOptions" id="exampleDataList" placeholder="ファイル名で検索..." />
        <label class="select-floating-label" for="selectFloating">検索</label>
      </div>
      <!-- Right side: Date Sort and Status Filter -->
      <div class="flex flex-col sm:flex-row gap-4">
        <div class="select-floating w-40">
          <select class="select" aria-label="Date sort" id="dateSort">
            <option>新しい順</option>
            <option>古い順</option>
          </select>
          <label class="select-floating-label" for="dateSort">日順ソート</label>
        </div>

        <div class="select-floating w-40">
          <select class="select" aria-label="Select floating label" id="selectFloating">
            <option>すべて</option>
            <option>解析成功</option>
            <option>解析中</option>
            <option>準備中</option>
            <option>失敗</option>
          </select>
          <label class="select-floating-label" for="selectFloating">ステータス</label>
        </div>

        <div class="select-floating w-40">
          <select class="select" aria-label="Label filter" id="labelFilter">
            <option>すべて</option>
            <option>犬</option>
            <option>屋外</option>
            <option>公園</option>
            <option>風景</option>
            <option>人物</option>
          </select>
          <label class="select-floating-label" for="labelFilter">ラベル</label>
        </div>

        <div class="select-floating w-40">
          <select class="select" aria-label="Confidence filter" id="confidenceFilter">
            <option>すべて</option>
            <option>90%以上</option>
            <option>80-89%</option>
            <option>70-79%</option>
            <option>60-69%</option>
            <option>60%未満</option>
          </select>
          <label class="select-floating-label" for="confidenceFilter">信頼度</label>
        </div>

        <button type="button" class="btn btn-soft btn-sm btn-circle" onclick="resetAllFilters()" title="フィルターをリセット">
          <span class="icon-[tabler--refresh] size-4"></span>
        </button>
      </div>
    </div>

    <!-- Table -->
    <div class="overflow-x-auto max-w-6xl mx-auto">
      {% if has_data %}
      <table class="table w-full [&_tr:nth-child(even)]:bg-base-200">
        <thead>
          <tr>
            <th>サムネイル画像</th>
            <th>アップロード日時</th>
            <th>ステータス</th>
            <th>機械学習によってつけられたラベル</th>
            <th>信頼度</th>
          </tr>
        </thead>
        <tbody>
          {% for image in images %}
          <tr data-image-id="{{ image.id }}">
            <td>
              <div class="flex items-center gap-3">
                <div class="avatar cursor-pointer" data-overlay="#slide-down-animated-modal">
                  <div class="bg-base-content/10 h-10 w-10 rounded-md">
                    <img src="{{ image.thumbnail_url }}" alt="{{ image.filename }}"
                      class="h-full w-full object-cover rounded-md" />
                  </div>
                </div>
                <div>
                  <div class="text-sm opacity-50">画像ファイル</div>
                  <div class="font-medium">{{ image.filename }}</div>
                </div>
              </div>
            </td>
            <td>{{ image.upload_date|date:"Y-m-d H:i" }}</td>
            <td>
              {% if image.status == 'completed' %}
              <span class="badge badge-outline border-dashed badge-success me-2 cursor-pointer"
                title="クリックしてアップロードページに遷移" onclick="navigateToUploadPage({{ image.id }}, 'completed')">解析成功</span>
              {% elif image.status == 'analyzing' %}
              <span class="badge badge-outline border-dashed badge-info me-2 cursor-pointer" title="クリックしてアップロードページに遷移"
                onclick="navigateToUploadPage({{ image.id }}, 'analyzing')">解析中</span>
              {% elif image.status == 'uploaded' %}
              <span class="badge badge-outline border-dashed badge-warning me-2 cursor-pointer"
                title="クリックしてアップロードページに遷移" onclick="navigateToUploadPage({{ image.id }}, 'uploaded')">アップロード完了</span>
              {% elif image.status == 'preparing' %}
              {% if image.queue_item %}
              <span class="badge badge-outline border-dashed badge-secondary me-2 cursor-pointer"
                title="クリックしてタイムラインを確認" data-overlay="#timeline-modal">
                準備中 → あと{{ image.queue_item.waiting_position }}枚
              </span>
              {% else %}
              <span class="badge badge-outline border-dashed badge-secondary me-2 cursor-pointer"
                title="クリックしてタイムラインを確認" data-overlay="#timeline-modal">準備中</span>
              {% endif %}
              {% elif image.status == 'failed' %}
              <span class="badge badge-outline border-dashed badge-error me-2 cursor-pointer" title="クリックしてアップロードページに遷移"
                onclick="navigateToUploadPage({{ image.id }}, 'failed')">失敗</span>
              {% endif %}
            </td>
            <td>
              {% if image.analysis_results.all %}
              {% for result in image.analysis_results.all %}
              <span class="badge badge-{% cycle 'error' 'secondary' 'success' %} me-1">{{ result.label }}</span>
              {% endfor %}
              {% else %}
              <span class="text-sm text-gray-500">-</span>
              {% endif %}
            </td>
            <td>
              {% if image.analysis_results.all %}
              {% with first_result=image.analysis_results.first %}
              <span class="badge badge-success">{{ first_result.confidence }}%</span>
              {% endwith %}
              {% else %}
              <span class="badge badge-secondary">-</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <!-- データがない場合の表示 -->
      <div class="text-center py-12">
        <div class="text-base-content/50 text-lg mb-4">
          <span class="icon-[tabler--table-off] size-16 mx-auto block mb-4"></span>
          データがありません
        </div>
        <p class="text-base-content/60">
          画像をアップロードすると、ここに解析結果が表示されます。
        </p>
      </div>
      {% endif %}
    </div>

    <!-- 他の行は省略 -->
  </div>

  <!-- Pagination -->
  {% if has_data %}
  <div class="flex flex-wrap items-center justify-between gap-2 py-4">
    <div class="text-sm text-base-content/80">
      Showing <span class="font-semibold">{{ page_obj.start_index }}-{{ page_obj.end_index }}</span> of
      <span class="font-semibold">{{ page_obj.paginator.count }}</span> images
    </div>
    {% if page_obj.has_other_pages %}
    <nav class="join">
      {% if page_obj.has_previous %}
      <a href="?page={{ page_obj.previous_page_number }}" class="btn btn-soft btn-square join-item">
        <span class="icon-[tabler--chevron-left] size-5"></span>
      </a>
      {% else %}
      <button class="btn btn-soft btn-square join-item" disabled>
        <span class="icon-[tabler--chevron-left] size-5"></span>
      </button>
      {% endif %}

      {% for num in page_obj.paginator.page_range %}
      {% if page_obj.number == num %}
      <button class="btn btn-soft join-item btn-square" aria-current="page">{{ num }}</button>
      {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %} <a href="?page={{ num }}"
        class="btn btn-soft join-item btn-square">{{ num }}</a>
        {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}" class="btn btn-soft btn-square join-item">
          <span class="icon-[tabler--chevron-right] size-5"></span>
        </a>
        {% else %}
        <button class="btn btn-soft btn-square join-item" disabled>
          <span class="icon-[tabler--chevron-right] size-5"></span>
        </button>
        {% endif %}
    </nav>
    {% endif %}
  </div>
  {% endif %}
</div>

<!-- Error Log Modal -->
<div id="slide-down-animated-modal" class="overlay modal overlay-open:opacity-100 overlay-open:duration-300 hidden"
  role="dialog" tabindex="-1">
  <div
    class="modal-dialog fixed top-8 left-1/2 transform -translate-x-1/2 overlay-open:duration-300 transition-all ease-out">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">画像詳細</h3>
        <button type="button" class="btn btn-text btn-circle btn-sm absolute end-3 top-3" aria-label="Close"
          data-overlay="#slide-down-animated-modal">
          <span class="icon-[tabler--x] size-4"></span>
        </button>
      </div>
      <div class="modal-body">
        <div class="flex flex-col gap-4">
          <!-- Image -->
          <div class="flex justify-center">
            <img id="modal-image" src="" alt=""
              class="rounded-lg shadow-lg max-w-full h-auto max-h-96 object-contain" />
          </div>

          <!-- Image Details -->
          <div class="grid grid-cols-1 gap-3">
            <div class="flex justify-between items-center">
              <span class="font-semibold">ファイル名:</span>
              <span id="modal-filename" class="text-sm text-gray-600"></span>
            </div>
            <div class="flex justify-between items-center">
              <span class="font-semibold">アップロード日時:</span>
              <span id="modal-upload-time" class="text-sm text-gray-600"></span>
            </div>
            <div class="flex justify-between items-center">
              <span class="font-semibold">ステータス:</span>
              <span id="modal-status-badge" class="badge badge-outline border-dashed me-2"></span>
            </div>
            <div class="flex justify-between items-center">
              <span class="font-semibold">機械学習によってつけられたラベル:</span>
              <div id="modal-labels" class="flex flex-wrap gap-1"></div>
            </div>
            <div class="flex justify-between items-center">
              <span class="font-semibold">信頼度:</span>
              <span id="modal-confidence" class="badge"></span>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-soft btn-secondary" data-overlay="#slide-down-animated-modal">
          閉じる
        </button>
      </div>
    </div>
  </div>
</div>

<!-- モデル選択モーダル -->
<div id="model-selection-modal" class="overlay modal hidden" role="dialog" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">解析モデルを選択</h3>
        <button type="button" class="btn btn-text btn-circle btn-sm absolute end-3 top-3" aria-label="Close"
          data-overlay="#model-selection-modal">
          <span class="icon-[tabler--x] size-4"></span>
        </button>
      </div>
      <div class="modal-body">
        <div class="flex flex-col gap-4">
          <div>
            <label class="form-label" for="model-selector">解析モデル</label>
            <select class="select select-bordered w-full" id="model-selector">
              <option value="">モデルを選択してください</option>
              <option value="resnet50">ResNet-50 v2.1 (汎用画像分類)</option>
              <option value="efficientnet">EfficientNet-B0 (軽量・高速)</option>
              <option value="mobilenet">MobileNet v2 (モバイル最適化)</option>
              <option value="vgg16">VGG-16 (高精度・詳細分析)</option>
              <option value="custom">カスタムモデル (特定用途特化)</option>
            </select>
          </div>
          <div class="bg-base-200 rounded-lg p-3">
            <h4 class="font-semibold text-sm mb-2">選択されたモデルの特徴</h4>
            <p id="model-description" class="text-sm text-gray-600">モデルを選択すると詳細が表示されます</p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-soft btn-secondary" data-overlay="#model-selection-modal">キャンセル</button>
        <button type="button" class="btn btn-primary" id="modal-start-analysis-btn">
          <span class="icon-[tabler--player-play] size-4 mr-2"></span>解析開始
        </button>
      </div>
    </div>
  </div>
</div>

<!-- タイムライン表示モーダル -->
<div id="timeline-modal" class="overlay modal overlay-open:opacity-100 overlay-open:duration-300 hidden" role="dialog"
  tabindex="-1">
  <div
    class="modal-dialog overlay-open:mt-4 sm:overlay-open:mt-8 lg:overlay-open:mt-12 overlay-open:duration-300 transition-all ease-out max-w-sm sm:max-w-md lg:max-w-lg">
    <div class="modal-content">
      <div class="modal-header p-4 sm:p-6">
        <h3 class="modal-title text-lg sm:text-xl">解析タイムライン</h3>
        <button type="button" class="btn btn-text btn-circle btn-sm absolute end-3 top-3" aria-label="Close"
          data-overlay="#timeline-modal">
          <span class="icon-[tabler--x] size-4"></span>
        </button>
      </div>
      <div class="modal-body p-4 sm:p-6">
        <div class="flex flex-col gap-4 sm:gap-6">
          <!-- 画像情報 -->
          <div class="text-center">
            <h4 class="font-semibold text-sm sm:text-base mb-2" id="timeline-filename">ファイル名</h4>
            <p class="text-xs sm:text-sm text-gray-500" id="timeline-status">ステータス</p>
          </div>

          <!-- 進捗バー（解析中の場合のみ表示） -->
          <div id="timeline-progress-section" class="hidden">
            <div class="flex items-center gap-x-3 whitespace-nowrap mb-4">
              <div class="progress h-2 flex-1" id="timeline-progress">
                <div class="progress-bar progress-info transition-all duration-500" style="width:0%"
                  id="timeline-progress-bar"></div>
              </div>
              <span class="text-base-content mb-0.5 text-sm">
                <span id="timeline-progress-value">0</span>%
              </span>
            </div>
            <div class="text-center">
              <span class="text-xs text-gray-600" id="timeline-progress-description">解析中...</span>
            </div>
          </div>

          <!-- タイムライン表示 -->
          <div class="space-y-4" id="timeline-content">
            <div class="flex items-center gap-3">
              <div class="flex-shrink-0">
                <div class="w-8 h-8 bg-success rounded-full flex items-center justify-center">
                  <span class="icon-[tabler--upload] text-success-content size-4"></span>
                </div>
              </div>
              <div class="flex-1">
                <div class="flex justify-between items-center">
                  <span class="text-sm font-medium">ファイルアップロード</span>
                  <span class="text-xs text-gray-500" id="upload-time">-</span>
                </div>
                <div class="text-xs text-gray-600" id="upload-duration">所要時間: -</div>
              </div>
            </div>

            <div class="flex items-center gap-3">
              <div class="flex-shrink-0">
                <div class="w-8 h-8 bg-secondary rounded-full flex items-center justify-center">
                  <span class="icon-[tabler--settings] text-secondary-content size-4"></span>
                </div>
              </div>
              <div class="flex-1">
                <div class="flex justify-between items-center">
                  <span class="text-sm font-medium">モデル選択</span>
                  <span class="text-xs text-gray-500" id="model-selection-time">-</span>
                </div>
                <div class="text-xs text-gray-600" id="selected-model">選択モデル: -</div>
              </div>
            </div>

            <div class="flex items-center gap-3">
              <div class="flex-shrink-0">
                <div class="w-8 h-8 bg-warning rounded-full flex items-center justify-center">
                  <span class="icon-[tabler--brain] text-warning-content size-4"></span>
                </div>
              </div>
              <div class="flex-1">
                <div class="flex justify-between items-center">
                  <span class="text-sm font-medium">解析開始</span>
                  <span class="text-xs text-gray-500" id="analysis-start-time">-</span>
                </div>
                <div class="text-xs text-gray-600" id="model-used">使用モデル: -</div>
              </div>
            </div>

            <!-- エラー情報表示セクション（失敗時のみ表示） -->
            <div id="error-info-section" class="hidden">
              <div class="flex items-center gap-3">
                <div class="flex-shrink-0">
                  <div class="w-8 h-8 bg-error rounded-full flex items-center justify-center">
                    <span class="icon-[tabler--x] text-error-content size-4"></span>
                  </div>
                </div>
                <div class="flex-1">
                  <div class="flex justify-between items-center">
                    <span class="text-sm font-medium text-error">解析失敗</span>
                    <span class="text-xs text-gray-500" id="error-timestamp">-</span>
                  </div>
                  <div class="text-xs text-error" id="error-message">エラーメッセージ: -</div>
                </div>
              </div>
            </div>

            <div class="flex items-center gap-3">
              <div class="flex-shrink-0">
                <div class="w-8 h-8 bg-info rounded-full flex items-center justify-center">
                  <span class="icon-[tabler--check] text-info-content size-4"></span>
                </div>
              </div>
              <div class="flex-1">
                <div class="flex justify-between items-center">
                  <span class="text-sm font-medium">解析完了</span>
                  <span class="text-xs text-gray-500" id="analysis-end-time">-</span>
                </div>
                <div class="text-xs text-gray-600" id="analysis-duration">所要時間: -</div>
              </div>
            </div>

            <div class="border-t pt-3">
              <div class="flex justify-between items-center">
                <span class="text-sm font-semibold">総所要時間</span>
                <span class="text-sm font-semibold text-primary" id="total-duration">-</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="flex justify-end gap-3">
          <!-- 再解析ボタン（失敗時のみ表示） -->
          <button type="button" id="retry-analysis-btn" class="btn btn-primary hidden" onclick="retryAnalysis()">
            <span class="icon-[tabler--refresh] size-4 mr-2"></span>
            再解析
          </button>
          <button type="button" class="btn btn-soft btn-secondary" data-overlay="#timeline-modal">閉じる</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 解析進捗モーダル -->
<div id="analysis-progress-modal" class="overlay modal overlay-open:opacity-100 overlay-open:duration-300 hidden"
  role="dialog" tabindex="-1">
  <div
    class="modal-dialog overlay-open:mt-4 sm:overlay-open:mt-8 lg:overlay-open:mt-12 overlay-open:duration-300 transition-all ease-out max-w-sm sm:max-w-md lg:max-w-lg">
    <div class="modal-content">
      <div class="modal-header p-4 sm:p-6">
        <h3 class="modal-title text-lg sm:text-xl">解析進捗</h3>
        <button type="button" class="btn btn-text btn-circle btn-sm absolute end-3 top-3" aria-label="Close"
          data-overlay="#analysis-progress-modal">
          <span class="icon-[tabler--x] size-4"></span>
        </button>
      </div>
      <div class="modal-body p-4 sm:p-6">
        <div class="flex flex-col gap-4 sm:gap-6">
          <div class="text-center">
            <p class="text-sm sm:text-base text-gray-600 mb-4">画像解析の進捗状況を表示しています。</p>

            <!-- ローディングアニメーション -->
            <div class="flex justify-center items-center gap-2 mb-4">
              <div class="flex gap-1">
                <span class="w-1.5 h-1.5 bg-info rounded-full animate-pulse"></span>
                <span class="w-1.5 h-1.5 bg-info rounded-full animate-pulse"></span>
                <span class="w-1.5 h-1.5 bg-info rounded-full animate-pulse"></span>
              </div>
            </div>

            <!-- 進捗バー -->
            <div class="flex items-center gap-x-3 whitespace-nowrap mb-4">
              <div class="progress h-2 flex-1" id="modal-analysis-progress">
                <div class="progress-bar progress-info transition-all duration-500" style="width:0%"
                  id="modal-analysis-progress-bar"></div>
              </div>
              <span class="text-base-content mb-0.5 text-sm">
                <span id="modal-analysis-progress-value">0</span>%
              </span>
            </div>

            <!-- ステータス表示 -->
            <div class="flex items-center justify-center gap-2">
              <span class="icon-[tabler--brain] text-info size-4"></span>
              <span class="text-sm text-info font-medium">解析中</span>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="flex justify-end gap-3">
          <button type="button" class="btn btn-soft btn-secondary" data-overlay="#analysis-progress-modal">閉じる</button>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/image_gallery.js' %}"></script>
<script>
  // アップロードページに遷移する関数
  function navigateToUploadPage(imageId, imageStatus) {
    console.log('navigateToUploadPage called with:', imageId, imageStatus);

    // Djangoのセッションに画像IDと状態を保存
    fetch('/api/set-selected-image/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      },
      body: JSON.stringify({
        image_id: imageId,
        image_status: imageStatus
      })
    }).then(response => {
      console.log('API response:', response);
      return response.json();
    }).then(data => {
      console.log('API data:', data);
      // 再解析ページに遷移
      window.location.href = '/re_image_upload/';
    }).catch(error => {
      console.error('Error setting selected image:', error);
      // エラーが発生しても遷移は実行
      window.location.href = '/re_image_upload/';
    });
  }

  // モーダルに画像データを設定する関数
  function openImageModal(filename, imageSrc, uploadTime, status, labels, confidence) {
    // モーダルの内容を設定
    document.getElementById('modal-filename').textContent = filename;
    document.getElementById('modal-image').src = imageSrc;
    document.getElementById('modal-image').alt = filename;
    document.getElementById('modal-upload-time').textContent = uploadTime;

    // ステータスバッジ
    const statusBadge = document.getElementById('modal-status-badge');
    statusBadge.textContent = status;
    statusBadge.className = 'badge badge-outline border-dashed me-2';

    // ステータスに応じて色を設定
    if (status === '解析成功') {
      statusBadge.classList.add('badge-success');
    } else if (status === '解析中') {
      statusBadge.classList.add('badge-warning');
    } else if (status === '準備中') {
      statusBadge.classList.add('badge-info');
    } else {
      statusBadge.classList.add('badge-error');
    }

    // ラベル
    const labelsContainer = document.getElementById('modal-labels');
    labelsContainer.innerHTML = '';
    if (labels && labels.length > 0) {
      labels.forEach(label => {
        const badge = document.createElement('span');
        badge.className = 'badge badge-primary';
        badge.textContent = label;
        labelsContainer.appendChild(badge);
      });
    } else {
      labelsContainer.innerHTML = '<span class="text-sm text-gray-500">ラベルなし</span>';
    }

    // 信頼度
    const confidenceBadge = document.getElementById('modal-confidence');
    if (confidence && confidence !== '-') {
      confidenceBadge.textContent = confidence;
      confidenceBadge.className = 'badge';

      // 信頼度に応じて色を設定
      const confidenceValue = parseFloat(confidence.replace('%', ''));
      if (confidenceValue >= 80) {
        confidenceBadge.classList.add('badge-success');
      } else if (confidenceValue >= 60) {
        confidenceBadge.classList.add('badge-warning');
      } else {
        confidenceBadge.classList.add('badge-error');
      }
    } else {
      confidenceBadge.textContent = '-';
      confidenceBadge.className = 'badge badge-outline';
    }
  }

  // テーブルのサムネイル画像クリックイベント
  document.addEventListener('DOMContentLoaded', function () {
    const avatarElements = document.querySelectorAll('.avatar[data-overlay="#slide-down-animated-modal"]');

    avatarElements.forEach(avatar => {
      avatar.addEventListener('click', function () {
        const row = this.closest('tr');
        if (row) {
          const filename = row.querySelector('td:nth-child(1) .font-medium')?.textContent || '';
          const uploadTime = row.querySelector('td:nth-child(2)')?.textContent || '';
          const status = row.querySelector('td:nth-child(3) .badge')?.textContent || '';
          const labels = Array.from(row.querySelectorAll('td:nth-child(4) .badge')).map(badge => badge.textContent);
          const confidence = row.querySelector('td:nth-child(5)')?.textContent || '-';

          // 画像URLを取得（サムネイルから）
          const thumbnailImg = row.querySelector('img');
          const imageSrc = thumbnailImg ? thumbnailImg.src : '';

          // モーダルを開く
          openImageModal(filename, imageSrc, uploadTime, status, labels, confidence);
        }
      });
    });
  });

  // クリックされた準備中バッジの画像IDを保存する変数
  let clickedImageId = null;

  // 進捗監視用の変数
  let progressInterval = null;

  // モデル選択モーダルの機能
  document.addEventListener('DOMContentLoaded', () => {
    // イベント委譲を使用して準備中バッジのクリックイベントを処理
    document.addEventListener('click', function (event) {
      // 準備中バッジがクリックされた場合
      if (event.target.classList.contains('badge-secondary') &&
        event.target.getAttribute('data-overlay') === '#model-selection-modal') {
        const row = event.target.closest('tr');
        clickedImageId = row ? row.getAttribute('data-image-id') : null;
        console.log('準備中バッジクリック、画像ID:', clickedImageId);
        console.log('行要素:', row);
        console.log('data-image-id属性:', row ? row.getAttribute('data-image-id') : '行が見つからない');

        // 画像IDが取得できない場合の代替手段
        if (!clickedImageId) {
          console.error('画像IDを取得できませんでした');
          alert('画像IDを取得できませんでした。ページを再読み込みしてください。');
        }
      }
    });

    // イベント委譲を使用して解析中バッジのクリックイベントを処理
    document.addEventListener('click', function (event) {
      console.log('クリックされた要素:', event.target);
      console.log('クラス一覧:', event.target.classList.toString());
      console.log('data-overlay属性:', event.target.getAttribute('data-overlay'));

      // 解析中バッジがクリックされた場合
      if (event.target.classList.contains('badge-info') &&
        event.target.getAttribute('data-overlay') === '#analysis-progress-modal') {
        const row = event.target.closest('tr');
        const imageId = row ? row.getAttribute('data-image-id') : null;
        console.log('解析中バッジクリック、画像ID:', imageId);

        // 進捗監視を開始
        if (imageId) {
          startProgressMonitoring(imageId);
        } else {
          console.error('解析中バッジ: 画像IDを取得できませんでした');
        }
      }

      // 解析成功バッジがクリックされた場合
      if (event.target.classList.contains('badge-success') &&
        event.target.getAttribute('data-overlay') === '#slide-down-animated-modal') {
        const row = event.target.closest('tr');
        const imageId = row ? row.getAttribute('data-image-id') : null;
        console.log('解析成功バッジクリック、画像ID:', imageId);

        // 画像詳細モーダルを開く
        if (imageId) {
          openImageDetailModal(imageId);
        }
      }
    });

    // 解析開始ボタン
    const modalStartBtn = document.getElementById('modal-start-analysis-btn');
    if (modalStartBtn) {
      modalStartBtn.addEventListener('click', () => {
        const selector = document.getElementById('model-selector');
        const model = selector ? selector.value : '';
        if (!model) {
          alert('モデルを選択してください');
          return;
        }

        console.log('解析開始ボタンクリック時の画像ID:', clickedImageId);
        if (!clickedImageId) {
          console.error('画像IDが見つかりません');
          alert('画像IDを取得できませんでした');
          return;
        }

        startIndividualAnalysis(clickedImageId, model);
      });
    }

    // モーダルが閉じられた時に画像IDをリセット
    const modal = document.getElementById('model-selection-modal');
    if (modal) {
      modal.addEventListener('hidden.bs.modal', function () {
        clickedImageId = null;
        console.log('モーダル閉じる、画像IDリセット');
      });
    }

    // キャンセルボタンとXボタンで画像IDをリセット
    const cancelBtn = document.querySelector('[data-overlay="#model-selection-modal"]');
    if (cancelBtn) {
      cancelBtn.addEventListener('click', function () {
        clickedImageId = null;
        console.log('キャンセルボタンクリック、画像IDリセット');
      });
    }

    // モデル選択時の説明表示
    const modelSelector = document.getElementById('model-selector');
    if (modelSelector) {
      modelSelector.addEventListener('change', (e) => {
        const selectedModel = e.target.value;
        const descriptionEl = document.getElementById('model-description');
        if (!descriptionEl) return;

        const descriptions = {
          'resnet50': 'ResNet-50 v2.1は、深層学習における代表的な画像分類モデルです。高い精度と汎用性を持ち、様々な画像タスクに適用できます。ImageNetで学習済みで、1000クラスの分類が可能です。',
          'efficientnet': 'EfficientNet-B0は、効率性を重視した軽量モデルです。少ないパラメータ数で高い性能を実現し、モバイルデバイスやエッジコンピューティングに最適です。高速な推論が可能です。',
          'mobilenet': 'MobileNet v2は、モバイル環境に特化して設計されたモデルです。軽量で高速な処理が可能で、スマートフォンやタブレットでのリアルタイム画像認識に適しています。',
          'vgg16': 'VGG-16は、深いネットワーク構造を持つ高精度モデルです。詳細な特徴抽出が得意で、複雑な画像パターンの識別に優れています。計算量は多いですが、高い精度が期待できます。',
          'custom': 'カスタムモデルは、特定の用途やデータセットに特化して学習されたモデルです。ドメイン固有の特徴を捉えることができ、専門的な画像解析タスクに最適です。'
        };

        if (selectedModel && descriptions[selectedModel]) {
          descriptionEl.textContent = descriptions[selectedModel];
        } else {
          descriptionEl.textContent = 'モデルを選択すると、ここに詳細な説明が表示されます。';
        }
      });
    }
  });

  // 個別画像解析開始
  function startIndividualAnalysis(imageId, modelName) {
    console.log('=== 個別画像解析開始 ===');
    console.log('画像ID:', imageId);
    console.log('モデル名:', modelName);
    console.log('タイムスタンプ:', new Date().toISOString());

    // 画像IDが取得できない場合の処理
    if (!imageId) {
      console.error('画像IDが取得できません');
      alert('画像IDが取得できません。ページを再読み込みしてください。');
      return;
    }

    // CSRFトークンを取得
    const csrfToken = getCSRFToken();
    console.log('CSRFトークン:', csrfToken);

    // API呼び出し
    console.log('API呼び出し開始: /api/analysis/start/');
    console.log('リクエストボディ:', { image_id: imageId, model: modelName });

    fetch('/api/analysis/start/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': csrfToken
      },
      body: new URLSearchParams({
        'image_id': imageId,
        'model': modelName
      })
    })
      .then(response => {
        console.log('=== API応答受信 ===');
        console.log('ステータス:', response.status);
        console.log('ステータステキスト:', response.statusText);
        console.log('ヘッダー:', response.headers);

        // レスポンスがJSONかどうかをチェック
        const contentType = response.headers.get('content-type');
        console.log('Content-Type:', contentType);

        if (!contentType || !contentType.includes('application/json')) {
          throw new Error('サーバーから無効なレスポンスが返されました');
        }
        return response.json();
      })
      .then(data => {
        console.log('=== 解析開始API応答 ===');
        console.log('成功:', data.ok);
        console.log('メッセージ:', data.message);
        console.log('結果:', data.results);
        console.log('エラー:', data.error);

        if (data.ok) {
          console.log('解析開始成功:', data);

          // モデル選択時刻を記録
          recordModelSelection(imageId, modelName);

          // バッジを「解析中」に更新
          updateBadgeStatus(imageId, 'analyzing');

          // モーダルを閉じる
          closeModelSelectionModal();

          // ページリロードは不要
        } else {
          console.error('解析開始失敗:', data.error);
          handleAnalysisError('解析の開始に失敗しました: ' + (data.error || '不明なエラー'));
        }
      })
      .catch(error => {
        console.error('=== API呼び出しエラー ===');
        console.error('エラー詳細:', error);
        console.error('エラーメッセージ:', error.message);
        console.error('エラースタック:', error.stack);
        handleAnalysisError('解析の開始中にエラーが発生しました: ' + error.message);
      });
  }

  // 解析エラー処理
  function handleAnalysisError(errorMessage) {
    console.error('解析エラー:', errorMessage);

    // 画像IDを取得
    const imageId = clickedImageId;
    console.log('エラー処理時の画像ID:', imageId);

    // 画像IDをリセット
    clickedImageId = null;

    // FlyonUIのモーダルを正しく閉じる
    const modal = document.getElementById('model-selection-modal');
    if (modal) {
      // 方法1: FlyonUIのHSOverlayを使用してモーダルを閉じる
      if (window.HSOverlay) {
        const overlay = window.HSOverlay.getInstance(modal);
        if (overlay) {
          overlay.close();
        }
      }

      // 方法2: data-overlay属性を持つ要素をクリックしてモーダルを閉じる
      const closeBtn = document.querySelector('[data-overlay="#model-selection-modal"]');
      if (closeBtn) {
        closeBtn.click();
      }

      // 方法3: フォールバック - 手動でモーダルを閉じる
      setTimeout(() => {
        modal.classList.add('hidden');
        modal.classList.remove('overlay-open');
        modal.style.display = 'none';
        modal.style.opacity = '0';
        modal.style.visibility = 'hidden';

        // 背景オーバーレイも除去
        const overlay = document.querySelector('.overlay');
        if (overlay) {
          overlay.classList.remove('overlay-open');
          overlay.style.display = 'none';
        }

        // bodyからoverlay-openクラスを除去
        document.body.classList.remove('overlay-open');
      }, 100);
    }

    // エラーメッセージを表示
    alert(errorMessage);

    // 画像IDがある場合は、ステータスを失敗に更新
    if (imageId) {
      updateImageStatusToFailed(imageId).then(() => {
        // バッジを「失敗」に更新
        updateBadgeStatus(imageId, 'failed');
      }).catch(() => {
        // ステータス更新に失敗してもバッジを更新
        updateBadgeStatus(imageId, 'failed');
      });
    }
  }

  // モデル選択時刻を記録
  function recordModelSelection(imageId, modelName) {
    console.log('モデル選択記録:', imageId, modelName);

    // モデル名の表示名を取得
    const modelDisplayNames = {
      'resnet50': 'ResNet-50 v2.1',
      'efficientnet': 'EfficientNet-B0',
      'mobilenet': 'MobileNet v2',
      'vgg16': 'VGG-16',
      'custom': 'カスタムモデル'
    };

    const displayName = modelDisplayNames[modelName] || modelName;

    // タイムライン表示を即座に更新
    const now = new Date();
    document.getElementById('model-selection-time').textContent = formatDateTime(now);
    document.getElementById('selected-model').textContent = `選択モデル: ${displayName}`;

    console.log('モデル選択記録完了:', displayName);
  }

  // 画像ステータスを失敗に更新
  function updateImageStatusToFailed(imageId) {
    const csrfToken = getCSRFToken();

    return fetch('/api/update-status/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': csrfToken
      },
      body: new URLSearchParams({
        'image_id': imageId,
        'status': 'failed'
      })
    })
      .then(response => response.json())
      .then(data => {
        if (data.ok) {
          console.log('ステータス更新成功:', data);
        } else {
          console.error('ステータス更新失敗:', data.error);
        }
      })
      .catch(error => {
        console.error('ステータス更新エラー:', error);
      });
  }

  // 進捗監視開始
  function startProgressMonitoring(imageId) {
    console.log('進捗監視開始:', imageId);

    // 既存の監視を停止
    if (progressInterval) {
      clearInterval(progressInterval);
    }

    // 進捗モーダルを手動で開く
    const modal = document.getElementById('analysis-progress-modal');
    if (modal) {
      modal.classList.remove('hidden');
      modal.style.display = 'block';
      modal.style.opacity = '1';
      modal.style.visibility = 'visible';

      // 背景オーバーレイを追加
      document.body.classList.add('overlay-open');
    }

    // 進捗バーと％をリセット
    const progressBar = document.getElementById('modal-analysis-progress-bar');
    const progressValue = document.getElementById('modal-analysis-progress-value');
    if (progressBar) progressBar.style.width = '0%';
    if (progressValue) progressValue.textContent = '0';

    // 進捗説明をリセット
    const progressDescription = document.querySelector('#analysis-progress-modal .text-gray-600');
    if (progressDescription) {
      progressDescription.textContent = '解析を開始しています...';
    }

    // 1秒ごとに進捗を取得
    progressInterval = setInterval(() => {
      fetch(`/api/analysis/progress/?image_id=${imageId}`)
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          console.log('進捗取得結果:', data);
          if (data.ok && data.progress !== undefined) {
            const progress = data.progress;
            console.log(`進捗更新: ${progress}% - ${data.description}`);
            if (progressBar) progressBar.style.width = progress + '%';
            if (progressValue) progressValue.textContent = progress;

            // 進捗説明も更新
            const progressDescription = document.querySelector('#analysis-progress-modal .text-gray-600');
            if (progressDescription && data.description) {
              progressDescription.textContent = data.description;
            }

            // 100%になったら監視を停止
            if (progress >= 100) {
              clearInterval(progressInterval);
              progressInterval = null;
              console.log('解析完了');

              // モーダル表示を完了状態に変更
              updateProgressModalToCompleted();

              // バッジを自動で更新
              updateBadgeStatus(imageId, 'success');
            }
          } else {
            console.log('進捗データが無効:', data);
          }
        })
        .catch(error => {
          console.error('進捗取得エラー:', error);
          // エラーが続く場合は監視を停止
          clearInterval(progressInterval);
          progressInterval = null;
        });
    }, 1000);
  }

  // 進捗監視停止
  function stopProgressMonitoring() {
    if (progressInterval) {
      clearInterval(progressInterval);
      progressInterval = null;
      console.log('進捗監視停止');
    }
  }

  // 進捗モーダルを完了状態に変更
  function updateProgressModalToCompleted() {
    // 進捗バーを完了状態に変更
    const progressBar = document.getElementById('modal-analysis-progress-bar');
    if (progressBar) {
      progressBar.style.width = '100%';
      progressBar.classList.remove('progress-info');
      progressBar.classList.add('progress-success');
    }

    // 進捗値を100%に設定
    const progressValue = document.getElementById('modal-analysis-progress-value');
    if (progressValue) {
      progressValue.textContent = '100';
    }

    // 進捗説明を完了メッセージに変更
    const progressDescription = document.querySelector('#analysis-progress-modal .text-gray-600');
    if (progressDescription) {
      progressDescription.textContent = '解析が完了しました！';
      progressDescription.classList.remove('text-gray-600');
      progressDescription.classList.add('text-success');
    }

    // モーダルのタイトルを変更
    const modalTitle = document.querySelector('#analysis-progress-modal .modal-title');
    if (modalTitle) {
      modalTitle.textContent = '解析完了';
    }

    // ステータス表示を完了状態に変更
    const statusIcon = document.querySelector('#analysis-progress-modal .icon-\\[tabler--brain\\]');
    const statusText = document.querySelector('#analysis-progress-modal .text-info.font-medium');
    if (statusIcon && statusText) {
      statusIcon.className = 'icon-[tabler--check-circle] text-success size-4';
      statusText.textContent = '解析完了';
      statusText.classList.remove('text-info');
      statusText.classList.add('text-success');
    }

    // ローディングアニメーションを停止
    const loadingDots = document.querySelector('#analysis-progress-modal .flex.gap-1');
    if (loadingDots) {
      loadingDots.style.display = 'none';
    }

    console.log('進捗モーダルを完了状態に変更しました');

    // 3秒後に自動でモーダルを閉じる（オプション）
    setTimeout(() => {
      const modal = document.getElementById('analysis-progress-modal');
      if (modal) {
        const closeButton = modal.querySelector('[data-overlay="#analysis-progress-modal"]');
        if (closeButton) {
          closeButton.click();
        }
      }
    }, 3000);
  }

  // モデル選択モーダルを閉じる
  function closeModelSelectionModal() {
    const modal = document.getElementById('model-selection-modal');
    if (modal) {
      // 方法1: モーダル内の閉じるボタンをクリック
      const closeButton = modal.querySelector('[data-hs-overlay-close]');
      if (closeButton) {
        closeButton.click();
        return; // 成功したら終了
      }

      // 方法2: FlyonUIのHSOverlayを使用してモーダルを閉じる
      if (typeof HSOverlay !== 'undefined') {
        try {
          // getInstanceを使用
          const overlay = HSOverlay.getInstance(modal);
          if (overlay && typeof overlay.close === 'function') {
            overlay.close();
            return; // 成功したら終了
          }

          // 直接closeメソッドを呼び出し
          if (typeof HSOverlay.close === 'function') {
            HSOverlay.close(modal);
            return; // 成功したら終了
          }
        } catch (error) {
          console.log('HSOverlay.close()でエラー:', error);
        }
      }

      // フォールバック - 手動でモーダルを閉じる
      setTimeout(() => {
        modal.classList.add('hidden');
        modal.classList.remove('overlay-open');
        modal.style.display = 'none';
        modal.style.opacity = '0';
        modal.style.visibility = 'hidden';

        // 背景オーバーレイも除去
        const overlay = document.querySelector('.overlay');
        if (overlay) {
          overlay.classList.remove('overlay-open');
          overlay.style.display = 'none';
        }

        // bodyからoverlay-openクラスを除去
        document.body.classList.remove('overlay-open');
      }, 100);
    }
  }

  // バッジステータスを更新
  function updateBadgeStatus(imageId, status) {
    const row = document.querySelector(`tr[data-image-id="${imageId}"]`);
    if (!row) return;

    const statusCell = row.querySelector('td:nth-child(3)');
    if (!statusCell) return;

    // 既存のバッジを削除
    const existingBadge = statusCell.querySelector('.badge');
    if (existingBadge) {
      existingBadge.remove();
    }

    // 新しいバッジを作成
    let newBadge;
    if (status === 'success') {
      newBadge = document.createElement('span');
      newBadge.className = 'badge badge-outline border-dashed badge-success me-2 cursor-pointer';
      newBadge.textContent = '解析成功';
      newBadge.title = 'クリックしてタイムラインを確認';
      newBadge.setAttribute('data-overlay', '#timeline-modal');
    } else if (status === 'failed') {
      newBadge = document.createElement('span');
      newBadge.className = 'badge badge-outline border-dashed badge-error me-2 cursor-pointer';
      newBadge.textContent = '失敗';
      newBadge.title = 'クリックしてタイムラインを確認';
      newBadge.setAttribute('data-overlay', '#timeline-modal');
    } else if (status === 'analyzing') {
      newBadge = document.createElement('span');
      newBadge.className = 'badge badge-outline border-dashed badge-info me-2 cursor-pointer';
      newBadge.textContent = '解析中';
      newBadge.title = 'クリックしてタイムラインを確認';
      newBadge.setAttribute('data-overlay', '#timeline-modal');
    }

    if (newBadge) {
      statusCell.appendChild(newBadge);
      console.log(`バッジを更新: 画像ID ${imageId} -> ${status}`);
      console.log('新しいバッジのクラス:', newBadge.className);
      console.log('新しいバッジのdata-overlay:', newBadge.getAttribute('data-overlay'));

      // FlyonUIのモーダル機能を再初期化
      if (typeof HSOverlay !== 'undefined') {
        try {
          HSOverlay.autoInit();
          console.log('FlyonUIを再初期化しました');
        } catch (error) {
          console.log('FlyonUI再初期化エラー:', error);
        }
      }

      // 解析中バッジの場合は手動でクリックイベントを追加
      if (status === 'analyzing') {
        newBadge.addEventListener('click', function () {
          const row = this.closest('tr');
          const imageId = row ? row.getAttribute('data-image-id') : null;
          console.log('手動イベント: 解析中バッジクリック、画像ID:', imageId);

          if (imageId) {
            startProgressMonitoring(imageId);
          }
        });
        console.log('解析中バッジに手動クリックイベントを追加しました');
      }
    }
  }

  // モーダルが閉じられた時に進捗監視を停止
  const progressModal = document.getElementById('analysis-progress-modal');
  if (progressModal) {
    progressModal.addEventListener('hidden.bs.modal', function () {
      stopProgressMonitoring();
    });
  }

  // CSRFトークン取得
  function getCSRFToken() {
    // 方法1: csrfmiddlewaretokenフィールドから取得
    const token = document.querySelector('[name=csrfmiddlewaretoken]');
    if (token) {
      return token.value;
    }

    // 方法2: Cookieから取得
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
      const [name, value] = cookie.trim().split('=');
      if (name === 'csrftoken') {
        return value;
      }
    }

    // 方法3: メタタグから取得
    const metaToken = document.querySelector('meta[name=csrf-token]');
    if (metaToken) {
      return metaToken.getAttribute('content');
    }

    console.error('CSRFトークンが見つかりません');
    return '';
  }

  // Function to reset all filters
  function resetAllFilters() {
    console.log('Resetting all filters...');

    // Reset search input
    const searchInput = document.getElementById('exampleDataList');
    if (searchInput) {
      searchInput.value = '';
    }

    // Reset date sort
    const dateSort = document.getElementById('dateSort');
    if (dateSort) {
      dateSort.selectedIndex = 0; // Select first option
    }

    // Reset status filter
    const statusFilter = document.getElementById('selectFloating');
    if (statusFilter) {
      statusFilter.selectedIndex = 0; // Select first option
    }

    // Reset label filter
    const labelFilter = document.getElementById('labelFilter');
    if (labelFilter) {
      labelFilter.selectedIndex = 0; // Select first option
    }

    // Reset confidence filter
    const confidenceFilter = document.getElementById('confidenceFilter');
    if (confidenceFilter) {
      confidenceFilter.selectedIndex = 0; // Select first option
    }

    // Apply filters after reset
    applyFilters();
    console.log('All filters have been reset');
  }

  // Function to apply filters
  function applyFilters() {
    const searchTerm = document.getElementById('exampleDataList').value.toLowerCase();
    const statusFilter = document.getElementById('selectFloating').value;
    const labelFilter = document.getElementById('labelFilter').value;
    const confidenceFilter = document.getElementById('confidenceFilter').value;
    const dateSort = document.getElementById('dateSort').value;

    console.log('フィルター適用:', { searchTerm, statusFilter, labelFilter, confidenceFilter, dateSort });

    const rows = document.querySelectorAll('tbody tr[data-image-id]');
    console.log('見つかった行数:', rows.length);
    let visibleCount = 0;

    // First, collect all rows and their data for sorting
    const rowData = [];
    rows.forEach(row => {
      let showRow = true;

      // Search filter
      if (searchTerm) {
        const filename = row.querySelector('.font-medium').textContent.toLowerCase();
        if (!filename.includes(searchTerm)) {
          showRow = false;
        }
      }

      // Status filter
      if (statusFilter !== 'すべて') {
        const statusBadge = row.querySelector('.badge');
        const statusText = statusBadge.textContent.trim();
        if (statusFilter === '解析成功' && statusText !== '解析成功') showRow = false;
        if (statusFilter === '解析中' && statusText !== '解析中') showRow = false;
        if (statusFilter === '準備中' && statusText !== '準備中') showRow = false;
        if (statusFilter === '失敗' && statusText !== '失敗') showRow = false;
      }

      if (showRow) {
        // Get upload date for sorting
        const uploadDateText = row.querySelector('td:nth-child(2)').textContent.trim();
        const uploadDate = new Date(uploadDateText);

        rowData.push({
          row: row,
          uploadDate: uploadDate,
          uploadDateText: uploadDateText
        });
        visibleCount++;
      } else {
        row.style.display = 'none';
      }
    });

    // Sort by date if needed
    if (dateSort === '古い順') {
      console.log('古い順でソート');
      rowData.sort((a, b) => a.uploadDate - b.uploadDate);
    } else if (dateSort === '新しい順') {
      console.log('新しい順でソート');
      rowData.sort((a, b) => b.uploadDate - a.uploadDate);
    }

    // Reorder and show rows
    const tbody = document.querySelector('tbody');
    if (tbody) {
      // Remove existing rows
      rowData.forEach(item => {
        item.row.remove();
      });

      // Add rows in sorted order
      rowData.forEach(item => {
        item.row.style.display = '';
        tbody.appendChild(item.row);
      });
    }

    console.log('表示される行数:', visibleCount);

    // Show "no results" message if no rows are visible
    let noResultsRow = tbody.querySelector('.no-results-row');

    console.log('検索結果チェック:', { visibleCount, totalRows: rows.length, hasNoResultsRow: !!noResultsRow });

    if (visibleCount === 0 && rows.length > 0) {
      console.log('検索結果なしメッセージを表示');
      if (!noResultsRow) {
        noResultsRow = document.createElement('tr');
        noResultsRow.className = 'no-results-row';
        noResultsRow.innerHTML = `
          <td colspan="5" class="text-center py-8">
            <div class="text-gray-500">
              <span class="icon-[tabler--search] size-8 mx-auto mb-2 block"></span>
              検索条件に一致する画像が見つかりません
            </div>
          </td>
        `;
        tbody.appendChild(noResultsRow);
        console.log('検索結果なしメッセージを追加');
      }
      noResultsRow.style.display = '';
    } else if (noResultsRow) {
      console.log('検索結果なしメッセージを非表示');
      noResultsRow.style.display = 'none';
    }
  }

  // Add event listeners for filters
  document.addEventListener('DOMContentLoaded', function () {
    const searchInput = document.getElementById('exampleDataList');
    const filters = document.querySelectorAll('select');

    // Search input
    if (searchInput) {
      searchInput.addEventListener('input', applyFilters);
    }

    // Filter selects
    filters.forEach(filter => {
      filter.addEventListener('change', applyFilters);
    });
  });

  // タイムラインデータを取得してモーダルに表示する関数
  async function loadTimelineModal(imageId) {
    try {
      console.log('タイムラインデータを取得中:', imageId);

      const response = await fetch(`/api/timeline/${imageId}/`);
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }

      const data = await response.json();
      if (!data.ok) {
        throw new Error(data.error || 'タイムラインデータの取得に失敗');
      }

      const timeline = data.timeline;
      console.log('取得したタイムラインデータ:', timeline);

      // モーダルの基本情報を設定
      document.getElementById('timeline-filename').textContent = timeline.filename || 'ファイル名不明';

      // ステータス表示（準備中の場合はキュー情報も表示）
      let statusText = getStatusDisplayName(timeline.status);
      if (timeline.status === 'preparing' && timeline.queue_info && timeline.queue_info.waiting_position > 0) {
        statusText += ` → あと${timeline.queue_info.waiting_position}枚`;
      }
      document.getElementById('timeline-status').textContent = statusText;

      // 進捗バーの表示制御
      updateProgressSection(timeline.status, imageId);

      // タイムラインデータを設定
      updateTimelineDisplay(timeline);

    } catch (error) {
      console.error('タイムライン取得エラー:', error);
      // エラー時はデフォルト表示
      document.getElementById('timeline-filename').textContent = 'データ取得エラー';
      document.getElementById('timeline-status').textContent = 'エラー';
      resetTimelineDisplay();
    }
  }

  // ステータス表示名を取得する関数
  function getStatusDisplayName(status) {
    const statusMap = {
      'uploaded': 'アップロード完了',
      'preparing': '準備中',
      'analyzing': '解析中',
      'success': '解析成功',
      'failed': '失敗'
    };
    return statusMap[status] || status;
  }

  // モデル名の表示名変換
  function getModelDisplayName(modelKey) {
    const modelMap = {
      'resnet50': 'PyTorch ResNet-50',
      'efficientnet': 'TensorFlow EfficientNet',
      'mobilenet': 'PyTorch MobileNet',
      'vgg16': 'PyTorch VGG-16',
      'custom': 'CLIP'
    };
    return modelMap[modelKey] || modelKey || '-';
  }

  // 進捗バーセクションの表示制御
  function updateProgressSection(status, imageId) {
    const progressSection = document.getElementById('timeline-progress-section');

    if (status === 'analyzing') {
      // 解析中の場合は進捗バーを表示
      progressSection.classList.remove('hidden');
      startTimelineProgressMonitoring(imageId);
    } else {
      // 解析中以外の場合は進捗バーを非表示
      progressSection.classList.add('hidden');
      stopTimelineProgressMonitoring();
    }
  }

  // タイムライン進捗監視の変数
  let timelineProgressInterval = null;

  // タイムライン進捗監視を開始
  function startTimelineProgressMonitoring(imageId) {
    // 既存の監視を停止
    stopTimelineProgressMonitoring();

    console.log('タイムライン進捗監視開始:', imageId);

    timelineProgressInterval = setInterval(async () => {
      try {
        const response = await fetch(`/api/analysis/progress/?image_id=${imageId}`);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        if (data.ok) {
          updateTimelineProgress(data);

          // 100%に達したら監視を停止
          if (data.progress >= 100) {
            stopTimelineProgressMonitoring();
            // タイムラインデータを再取得して更新
            loadTimelineModal(imageId);
          }
        }
      } catch (error) {
        console.error('タイムライン進捗取得エラー:', error);
      }
    }, 1000);
  }

  // タイムライン進捗監視を停止
  function stopTimelineProgressMonitoring() {
    if (timelineProgressInterval) {
      clearInterval(timelineProgressInterval);
      timelineProgressInterval = null;
      console.log('タイムライン進捗監視停止');
    }
  }

  // タイムライン進捗バーを更新
  function updateTimelineProgress(data) {
    const progressBar = document.getElementById('timeline-progress-bar');
    const progressValue = document.getElementById('timeline-progress-value');
    const progressDescription = document.getElementById('timeline-progress-description');

    if (progressBar && progressValue) {
      progressBar.style.width = `${data.progress}%`;
      progressValue.textContent = Math.round(data.progress);

      // 進捗に応じてバーの色を変更
      progressBar.classList.remove('progress-info', 'progress-success');
      if (data.progress >= 100) {
        progressBar.classList.add('progress-success');
      } else {
        progressBar.classList.add('progress-info');
      }
    }

    if (progressDescription && data.description) {
      progressDescription.textContent = data.description;
    }
  }

  // タイムライン表示を更新する関数
  function updateTimelineDisplay(timeline) {
    // アップロード時刻
    if (timeline.upload_completed_at) {
      const uploadTime = new Date(timeline.upload_completed_at);
      document.getElementById('upload-time').textContent = formatDateTime(uploadTime);

      if (timeline.upload_duration) {
        document.getElementById('upload-duration').textContent = `所要時間: ${formatDuration(timeline.upload_duration)}`;
      }
    } else {
      document.getElementById('upload-time').textContent = '-';
      document.getElementById('upload-duration').textContent = '所要時間: -';
    }

    // モデル選択時刻
    const modelSelectionItem = document.querySelector('#timeline-content .flex.items-center.gap-3:nth-child(2)');
    if (timeline.model_selected_at) {
      const modelSelectionTime = new Date(timeline.model_selected_at);
      document.getElementById('model-selection-time').textContent = formatDateTime(modelSelectionTime);
      document.getElementById('selected-model').textContent = `選択モデル: ${timeline.selected_model || '-'}`;
      // モデル選択アイテムを表示
      if (modelSelectionItem) {
        modelSelectionItem.style.display = 'flex';
      }
    } else {
      document.getElementById('model-selection-time').textContent = '-';
      document.getElementById('selected-model').textContent = '選択モデル: -';
      // モデル選択アイテムを非表示
      if (modelSelectionItem) {
        modelSelectionItem.style.display = 'none';
      }
    }

    // 解析開始時刻
    if (timeline.analysis_started_at) {
      const analysisStartTime = new Date(timeline.analysis_started_at);
      document.getElementById('analysis-start-time').textContent = formatDateTime(analysisStartTime);

      // モデル名を適切に表示
      const modelName = getModelDisplayName(timeline.model_used);
      document.getElementById('model-used').textContent = `使用モデル: ${modelName}`;
    } else {
      document.getElementById('analysis-start-time').textContent = '-';
      document.getElementById('model-used').textContent = '使用モデル: -';
    }

    // エラー情報の表示
    const errorInfoSection = document.getElementById('error-info-section');
    const retryBtn = document.getElementById('retry-analysis-btn');
    if (timeline.status === 'failed' && timeline.error_info) {
      errorInfoSection.classList.remove('hidden');
      retryBtn.classList.remove('hidden');
      document.getElementById('error-message').textContent = `エラーメッセージ: ${timeline.error_info.error_message}`;
      if (timeline.error_info.error_timestamp) {
        const errorTime = new Date(timeline.error_info.error_timestamp);
        document.getElementById('error-timestamp').textContent = formatDateTime(errorTime);
      } else {
        document.getElementById('error-timestamp').textContent = '-';
      }
    } else {
      errorInfoSection.classList.add('hidden');
      retryBtn.classList.add('hidden');
    }

    // 解析完了時刻
    if (timeline.analysis_completed_at) {
      const analysisEndTime = new Date(timeline.analysis_completed_at);
      document.getElementById('analysis-end-time').textContent = formatDateTime(analysisEndTime);

      if (timeline.analysis_duration) {
        document.getElementById('analysis-duration').textContent = `所要時間: ${formatDuration(timeline.analysis_duration)}`;
      }
    } else {
      document.getElementById('analysis-end-time').textContent = '-';
      document.getElementById('analysis-duration').textContent = '所要時間: -';
    }

    // 総所要時間
    if (timeline.total_duration) {
      document.getElementById('total-duration').textContent = formatDuration(timeline.total_duration);
    } else {
      document.getElementById('total-duration').textContent = '-';
    }
  }

  // 再解析機能
  function retryAnalysis() {
    if (!currentImageId) {
      console.error('画像IDが設定されていません');
      return;
    }

    // 確認ダイアログ
    if (!confirm('この画像を再解析しますか？')) {
      return;
    }

    // 再解析ボタンを無効化
    const retryBtn = document.getElementById('retry-analysis-btn');
    retryBtn.disabled = true;
    retryBtn.innerHTML = '<span class="icon-[tabler--loader-2] size-4 mr-2 animate-spin"></span>再解析中...';

    // 再解析APIを呼び出し
    fetch('/api/analysis/retry/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({
        image_id: currentImageId
      })
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // 成功時はモーダルを閉じてページをリロード
          closeTimelineModal();
          location.reload();
        } else {
          alert('再解析の開始に失敗しました: ' + (data.error || '不明なエラー'));
          // ボタンを元に戻す
          retryBtn.disabled = false;
          retryBtn.innerHTML = '<span class="icon-[tabler--refresh] size-4 mr-2"></span>再解析';
        }
      })
      .catch(error => {
        console.error('再解析エラー:', error);
        alert('再解析の開始に失敗しました: ' + error.message);
        // ボタンを元に戻す
        retryBtn.disabled = false;
        retryBtn.innerHTML = '<span class="icon-[tabler--refresh] size-4 mr-2"></span>再解析';
      });
  }

  // タイムライン表示をリセットする関数
  function resetTimelineDisplay() {
    document.getElementById('upload-time').textContent = '-';
    document.getElementById('upload-duration').textContent = '所要時間: -';
    document.getElementById('model-selection-time').textContent = '-';
    document.getElementById('selected-model').textContent = '選択モデル: -';
    document.getElementById('analysis-start-time').textContent = '-';
    document.getElementById('model-used').textContent = '使用モデル: -';
    document.getElementById('analysis-end-time').textContent = '-';
    document.getElementById('analysis-duration').textContent = '所要時間: -';
    document.getElementById('total-duration').textContent = '-';

    // エラー情報セクションを非表示
    const errorInfoSection = document.getElementById('error-info-section');
    const retryBtn = document.getElementById('retry-analysis-btn');
    if (errorInfoSection) errorInfoSection.classList.add('hidden');
    if (retryBtn) retryBtn.classList.add('hidden');

    // モデル選択アイテムを非表示
    const modelSelectionItem = document.querySelector('#timeline-content .flex.items-center.gap-3:nth-child(2)');
    if (modelSelectionItem) {
      modelSelectionItem.style.display = 'none';
    }
  }

  // 日時をフォーマットする関数
  function formatDateTime(date) {
    return date.toLocaleString('ja-JP', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit'
    });
  }

  // 所要時間をフォーマットする関数
  function formatDuration(seconds) {
    if (seconds < 60) {
      return `${seconds.toFixed(1)}秒`;
    } else if (seconds < 3600) {
      const minutes = Math.floor(seconds / 60);
      const remainingSeconds = (seconds % 60).toFixed(1);
      return `${minutes}分${remainingSeconds}秒`;
    } else {
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      return `${hours}時間${minutes}分`;
    }
  }

  // バッジクリック時にタイムラインモーダルを開く機能を追加
  document.addEventListener('click', function (event) {
    const badge = event.target;
    if (badge.classList.contains('badge') && badge.getAttribute('data-overlay') === '#timeline-modal') {
      const row = badge.closest('tr');
      const imageId = row ? row.getAttribute('data-image-id') : null;
      if (imageId) {
        console.log('タイムラインモーダルを開く、画像ID:', imageId);
        loadTimelineModal(imageId);
      }
    }
  });

  // タイムラインモーダルが閉じられた時に進捗監視を停止
  document.addEventListener('DOMContentLoaded', function () {
    const timelineModal = document.getElementById('timeline-modal');
    if (timelineModal) {
      // FlyonUIのモーダルイベントを監視
      timelineModal.addEventListener('hidden.bs.modal', function () {
        stopTimelineProgressMonitoring();
      });

      // 閉じるボタンクリック時も監視停止
      const closeButtons = timelineModal.querySelectorAll('[data-overlay="#timeline-modal"]');
      closeButtons.forEach(button => {
        button.addEventListener('click', function () {
          stopTimelineProgressMonitoring();
        });
      });
    }
  });
</script>
{% endblock %}

{% block extra_css %}
<style>
  .table tbody tr:nth-child(even) {
    background-color: #f3f4f6;
  }

  /* 準備中バッジのホバー効果 */
  .badge-secondary.cursor-pointer:hover {
    background-color: #6b7280 !important;
    color: white !important;
    transform: scale(1.05);
    transition: all 0.2s ease;
  }

  /* 画像プレースホルダーのスタイル */
  .image-placeholder {
    background: linear-gradient(135deg, #f3f4f6 25%, transparent 25%),
      linear-gradient(225deg, #f3f4f6 25%, transparent 25%),
      linear-gradient(45deg, #f3f4f6 25%, transparent 25%),
      linear-gradient(315deg, #f3f4f6 25%, transparent 25%);
    background-position: 10px 0, 10px 0, 0 0, 0 0;
    background-size: 20px 20px;
    background-repeat: repeat;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #6b7280;
    border: 2px dashed #d1d5db;
    position: relative;
  }

  /* 画像が読み込まれた時のスタイル */
  .image-placeholder[style*="background-image"],
  .image-placeholder.image-loaded {
    background-size: cover !important;
    background-position: center !important;
    background-repeat: no-repeat !important;
  }

  .image-placeholder[style*="background-image"] .skeleton,
  .image-placeholder.image-loaded .skeleton {
    display: none !important;
  }


  .image-placeholder-modal {
    background: linear-gradient(135deg, #f3f4f6 25%, transparent 25%),
      linear-gradient(225deg, #f3f4f6 25%, transparent 25%),
      linear-gradient(45deg, #f3f4f6 25%, transparent 25%),
      linear-gradient(315deg, #f3f4f6 25%, transparent 25%);
    background-position: 10px 0, 10px 0, 0 0, 0 0;
    background-size: 20px 20px;
    background-repeat: repeat;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #6b7280;
    border: 2px dashed #d1d5db;
    min-height: 300px;
    width: 100%;
    max-width: 400px;
  }

  .placeholder-content {
    text-align: center;
  }

  .placeholder-content-small {
    text-align: center;
  }

  .placeholder-content-modal {
    text-align: center;
  }
</style>
{% endblock %}