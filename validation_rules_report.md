# バリデーションルール調査レポート

## 📋 調査概要
画像解析アプリケーションの現時点でのバリデーションルールを包括的に調査し、実装状況を整理しました。

---

## 🔍 調査結果

### 1. ユーザー認証・登録関連

#### **モデルレベル（`models.py`）**
- **ユーザー名**:
  - 長さ: 3-20文字
  - 形式: 英数字とアンダースコアのみ (`^[a-zA-Z0-9_]+$`)
  - 一意性: UNIQUE制約

- **メールアドレス**:
  - 形式: Django標準EmailValidator使用
  - 一意性: UNIQUE制約

- **パスワード**:
  - Django標準のAbstractUserのパスワード機能を使用

#### **フロントエンド（JavaScript）**
- **ユーザー名**:
  - 長さ: 2-20文字
  - 形式: 英数字、アンダースコア、スペース、日本語文字 (`^[a-zA-Z0-9_ () \u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]{2,20}$`)
  - **⚠️ 問題**: モデルとフロントエンドで文字数制限が異なる（3-20 vs 2-20）

- **メールアドレス**:
  - 形式: 基本的なメール形式チェック (`^[^\s@]+@[^\s@]+\.[^\s@]+$`)

- **パスワード**:
  - 最小長: 6文字以上
  - 要件: 大文字・小文字・数字を含む
  - 確認パスワードとの一致必須

#### **プロジェクトルールとの差異**
- **パスワード要件**: ルールでは8文字以上、大文字・小文字・数字・特殊文字を1種類以上含む
- **実装**: 6文字以上、大文字・小文字・数字のみ（特殊文字なし）
- **⚠️ セキュリティリスク**: 要件より緩いパスワードポリシー

---

### 2. 画像アップロード関連

#### **バックエンド（`views.py`）**
- **ファイルサイズ**:
  - 最大: 1MB（`MAX_MB = 1`）
  - 制限: `MAX_BYTES = MAX_MB * 1024 * 1024`

- **ファイル形式**:
  - 許可拡張子: `.jpg`, `.jpeg`, `.png`, `.gif`
  - 制限: `ALLOWED_EXTENSIONS = {'.jpg', '.jpeg', '.png', '.gif'}`

- **アップロード枚数**:
  - 最大: 5枚（フロントエンド設定）

#### **フロントエンド（HTML/JavaScript）**
- **ファイルサイズ**: 1MB
- **最大ファイル数**: 5枚
- **対応形式**: JPG, PNG, GIF

#### **プロジェクトルールとの整合性**
✅ **完全一致**: サイズ（1MB）、形式（JPG, PNG, GIF）、枚数（5枚）

---

### 3. データベース制約

#### **モデル制約**
- **User**:
  - `username`, `email`: UNIQUE制約
  - `is_staff`: 管理者権限判定

- **Image**:
  - `status`: 選択肢制約（upload, uploaded, preparing, analyzing, success, failed）
  - `user`: CASCADE削除

- **AnalysisResult**:
  - `confidence`: 0.00-100.00%の範囲
  - `rank`: 正の整数

- **TimelineLog**:
  - `image`: OneToOneField（1:1関係）
  - `analysis_progress_percentage`: 0-100の範囲

---

### 4. ビジネスロジックバリデーション

#### **画像解析キュー**
- **キュー管理**:
  - 位置: 正の整数
  - 優先度: low, normal, high, urgent
  - ステータス: waiting, processing, completed, failed, cancelled

#### **パスワードリセット**
- **トークン**:
  - 長さ: 64文字
  - 一意性: UNIQUE制約
  - 有効期限: 1時間（設定可能）

---

## ⚠️ 発見された問題点

### 1. **ユーザー名バリデーションの不整合**
- **モデル**: 3-20文字、英数字とアンダースコアのみ
- **フロントエンド**: 2-20文字、日本語文字も許可
- **影響**: フロントエンドで通ってもバックエンドでエラーになる可能性

### 2. **パスワード要件の不整合**
- **プロジェクトルール**: 8文字以上、特殊文字必須
- **実装**: 6文字以上、特殊文字不要
- **影響**: セキュリティ要件が緩い

### 3. **バリデーション層の分散**
- モデル、ビュー、フロントエンドで異なるルール
- 統一的なバリデーション戦略が必要

---

## 📊 実装状況サマリー

### 🚨 問題のある項目

```
ユーザー名バリデーション
┌─────────────────┬──────────────┬──────────────┐
│   フロントエンド   │   バックエンド   │    ルール     │
├─────────────────┼──────────────┼──────────────┤
│ 2-20文字        │ 3-20文字      │ 3-20文字      │
│ 日本語OK        │ 英数字_のみ    │ 記号のみ禁止    │
└─────────────────┴──────────────┴──────────────┘
❌ 不整合: フロントで通ってもバックエンドでエラー

パスワード要件
┌─────────────────┬──────────────┬──────────────┐
│   フロントエンド   │   バックエンド   │    ルール     │
├─────────────────┼──────────────┼──────────────┤
│ 6文字以上        │ Django標準    │ 8文字以上      │
│ 大文字小文字数字  │              │ 特殊文字必須    │
└─────────────────┴──────────────┴──────────────┘
❌ 不整合: セキュリティ要件が緩い
```

### ✅ 正常な項目

```
ファイルアップロード
┌─────────────────┬──────────────┬──────────────┐
│   フロントエンド   │   バックエンド   │    ルール     │
├─────────────────┼──────────────┼──────────────┤
│ 1MB             │ 1MB           │ 1MB           │
│ JPG,PNG,GIF     │ JPG,PNG,GIF   │ JPG,PNG,GIF   │
│ 5枚まで          │ 5枚まで        │ 5枚まで        │
└─────────────────┴──────────────┴──────────────┘
✅ 完全整合: 問題なし
```

---

## 🔧 推奨改善事項

### 1. **🚨 緊急修正が必要**
1. **ユーザー名バリデーションの統一**
   - モデル: 3-20文字、英数字とアンダースコアのみ
   - フロントエンド: 2-20文字、日本語文字も許可
   - **修正方針**: モデルに合わせてフロントエンドを修正

2. **パスワード要件の強化**
   - 現在: 6文字以上、大文字・小文字・数字のみ
   - 要件: 8文字以上、特殊文字も必須
   - **修正方針**: プロジェクトルールに合わせて強化

3. **フロントエンドとバックエンドの整合性確保**
   - バリデーションルールの統一化
   - エラーメッセージの一貫性確保

### 2. **段階的改善**
1. 統一バリデーションサービスの作成
2. エラーメッセージの多言語対応
3. バリデーションルールの設定ファイル化

### 3. **長期改善**
1. フォームバリデーションのDjango Forms化
2. リアルタイムバリデーションの改善
3. バリデーションログの実装

---

## 📝 結論

現在のシステムは基本的なバリデーション機能は実装されていますが、**フロントエンドとバックエンドの不整合**が複数存在します。

### 🚨 **最重要課題**
1. **ユーザー名バリデーション**: 2文字でも通るが、バックエンドで3文字未満はエラー
2. **パスワードセキュリティ**: 要件より緩いポリシーでセキュリティリスク

### ✅ **正常に動作している部分**
- 画像アップロード関連のバリデーション
- データベース制約
- 基本的なフォームバリデーション

### 🎯 **次のステップ**
1. ユーザー名バリデーションの統一（最優先）
2. パスワード要件の強化
3. 統一バリデーションサービスの実装

**修正作業は比較的簡単**で、フロントエンドのJavaScriptを修正するだけで大部分が解決できます。
